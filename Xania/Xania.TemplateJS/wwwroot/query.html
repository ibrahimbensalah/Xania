<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script src="/jspm_packages/system.js"></script>
    <script src="/lib/fetch/fetch.js"></script>
    <script>
        System.config({
            packages: { '/': {} },
            paths: {
                "github:*": "/jspm_packages/github/*",
                "npm:*": "/jspm_packages/npm/*",
                "ts:*": "/jspm_packages/npm/*"
            },
            map: {
                "css": "github:systemjs/plugin-css@0.1.32",
                "ts": "github:frankwallis/plugin-typescript@7.0.6",
                "less": "npm:systemjs-less-plugin@2.0.0"
            },
            meta: {
                '*.css': { loader: 'css' },
                '*.less': { loader: 'less' }
            }
        });
    </script>
    <script>
        var query =
            ` for i in invoices
              join c in companies on i.companyId = c.id
              select { 
                    invoiceId: i.id, 
                    invoiceDate: i.invoiceDate, 
                    invoiceNumber: i.invoiceNumber,
                    companyName: c.name
              }
            `;
        System.import('src/compile').then(function (compile) {
            var config = {
                method: "POST",
                headers: {
                    'Content-Type': "application/json"
                },
                body: JSON.stringify(compile.parse(query))
            };

            var start = new Date();

            var arr = [];
            for (var i = 0; i < 1000; i++) {
                arr.push(fetch("/api/query", config));
            }
            Promise.all(arr).then(function() {
                var end = new Date();

                console.log({ start: start, end: end, elapsed: end - start });
            });
        });
    </script>
</head>
<body>

</body>
</html>