"use strict";
var template_1 = require("../src/template");
var fsharp_1 = require("../src/fsharp");
var dom_1 = require("../src/dom");
var reactive_1 = require("../src/reactive");
var observables_1 = require("../src/observables");
var ibrahim, ramy;
var RootDom = (function () {
    function RootDom() {
        this.dom = document.createDocumentFragment();
    }
    RootDom.prototype.insert = function (binding, dom, insertAt) {
        if (insertAt < this.dom.childNodes.length) {
            var beforeElement = this.dom.childNodes[insertAt];
            this.dom.insertBefore(dom, beforeElement);
        }
        else {
            this.dom.appendChild(dom);
        }
    };
    Object.defineProperty(RootDom.prototype, "childNodes", {
        get: function () {
            return this.dom.childNodes;
        },
        enumerable: true,
        configurable: true
    });
    return RootDom;
}());
describe("templating", function () {
    beforeEach(function () {
        ibrahim = {
            age: 36,
            firstName: "Ibrahim",
            lastName: "ben Salah",
            adult: true,
            roles: ["developer"]
        };
        ramy = {
            age: 5,
            firstName: "Ramy",
            lastName: "ben Salah",
            adult: false,
            roles: []
        };
    });
    it("text binding", function () {
        var store = new reactive_1.Reactive.Store({ p: ibrahim });
        var binding = new dom_1.Dom.TextBinding(fsharp_1.fs("p.firstName")).update(store);
        store.get("p").get("firstName").set("bla");
        expect(binding.textNode.textContent).toBe("bla");
        expect(binding.dependencies.length).toBe(2);
    });
    it("content binding", function () {
        var store = new reactive_1.Reactive.Store({ people: [ibrahim, ramy] });
        var fragment = new RootDom();
        var binding = new dom_1.Dom.FragmentBinding(fsharp_1.fs("for p in people"), [
            new template_1.Template.TextTemplate(fsharp_1.fs("p.firstName + ' ' + p.lastName")),
            new template_1.Template.FragmentTemplate(fsharp_1.fs("for r in p.roles"))
                .child(new template_1.Template.TextTemplate(fsharp_1.fs("':: ' + r")))
        ])
            .map(fragment)
            .update(store);
        expect(fragment.childNodes.length).toBe(3);
        store.get("people").get(1).get("roles").set(["zoon"]);
        expect(fragment.childNodes.length).toBe(4);
        store.get("people").get(0).get("roles").set(["papa"]);
    });
    it("tag class binding", function () {
        var binding = new dom_1.Dom.TagBinding("div")
            .attr("class", fsharp_1.fs("p.firstName"))
            .attr("class.adult-person", fsharp_1.fs("p.adult"));
        binding.update(new reactive_1.Reactive.Store({ p: ibrahim }));
        expect(binding.tagNode.className).toBe("Ibrahim adult-person");
        binding.update(new reactive_1.Reactive.Store({ p: ramy }));
        expect(binding.tagNode.className).toBe("Ramy");
    });
    it("tag attribute binding", function () {
        var binding = new dom_1.Dom.TagBinding("div")
            .attr("id", fsharp_1.fs('p.age'));
        binding.update(new reactive_1.Reactive.Store({ p: ibrahim }));
        expect(binding.tagNode.id).toBe('36');
        binding.update(new reactive_1.Reactive.Store({ p: ramy }));
        expect(binding.tagNode.id).toBe('5');
    });
    it("tag children binding", function () {
        var store = new reactive_1.Reactive.Store({ p: ibrahim });
        var div = new dom_1.Dom.TagBinding("div")
            .child(new dom_1.Dom.TextBinding(fsharp_1.fs("p.firstName")))
            .attr("data-age", fsharp_1.fs("p.age"));
        div.update(store);
        expect(div.tagNode.childNodes.length).toBe(1);
        expect(div.tagNode.textContent).toBe('Ibrahim');
        store.get('p').get('firstName').set('IBRAHIM');
        expect(div.tagNode.textContent).toBe('IBRAHIM');
    });
    it("tag event binding", function () {
        var store = new reactive_1.Reactive.Store({
            p: {
                message: null,
                sayHello: function (user) {
                    if (user === void 0) { user = 'Jasmine'; }
                    this.message = "Hello, " + user + "!";
                }
            }
        });
        var button = new dom_1.Dom.TagBinding("button")
            .on("click", fsharp_1.fs("p.sayHello"))
            .update(store);
        button.trigger('click');
        expect(store.get('p').get('message').valueOf()).toBe("Hello, Jasmine!");
    });
    it("supports streams", function () {
        var stream = new observables_1.Observables.Observable();
        var binding = new dom_1.Dom.TextBinding(fsharp_1.fs("await value")).update(new reactive_1.Reactive.Store({ value: stream }));
        expect(binding.textNode.textContent).toBe("");
        stream.onNext(123);
        expect(binding.textNode.textContent).toBe("123");
        stream.onNext(456);
        expect(binding.textNode.textContent).toBe("456");
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGVTcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3BlYy90ZW1wbGF0ZVNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUVBLDRDQUEyQztBQUMzQyx3Q0FBbUM7QUFDbkMsa0NBQWlDO0FBQ2pDLDRDQUFpRDtBQUNqRCxrREFBaUQ7QUFJakQsSUFBSSxPQUFnQixFQUFFLElBQWEsQ0FBQztBQUVwQztJQUFBO1FBQ1ksUUFBRyxHQUFHLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0lBY3BELENBQUM7SUFaRyx3QkFBTSxHQUFOLFVBQU8sT0FBTyxFQUFFLEdBQUcsRUFBRSxRQUFRO1FBQ3pCLEVBQUUsQ0FBQyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3hDLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2xELElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM5QyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5QixDQUFDO0lBQ0wsQ0FBQztJQUVELHNCQUFJLCtCQUFVO2FBQWQ7WUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7UUFDL0IsQ0FBQzs7O09BQUE7SUFDTCxjQUFDO0FBQUQsQ0FBQyxBQWZELElBZUM7QUFFRCxRQUFRLENBQUMsWUFBWSxFQUNqQjtJQUVJLFVBQVUsQ0FBQztRQUNQLE9BQU8sR0FBRztZQUNOLEdBQUcsRUFBRSxFQUFFO1lBQ1AsU0FBUyxFQUFFLFNBQVM7WUFDcEIsUUFBUSxFQUFFLFdBQVc7WUFDckIsS0FBSyxFQUFFLElBQUk7WUFDWCxLQUFLLEVB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bm9kZV9tb2R1bGVzL0B0eXBlcy9qYXNtaW5lL2luZGV4LmQudHNcIiAvPlxyXG5cclxuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tIFwiLi4vc3JjL3RlbXBsYXRlXCI7XHJcbmltcG9ydCB7IGZzIH0gZnJvbSBcIi4uL3NyYy9mc2hhcnBcIjtcclxuaW1wb3J0IHsgRG9tIH0gZnJvbSBcIi4uL3NyYy9kb21cIjtcclxuaW1wb3J0IHsgUmVhY3RpdmUgYXMgUmUgfSBmcm9tICcuLi9zcmMvcmVhY3RpdmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlcyB9IGZyb20gJy4uL3NyYy9vYnNlcnZhYmxlcyc7XHJcblxyXG5pbnRlcmZhY2UgSVBlcnNvbiB7IGZpcnN0TmFtZTogc3RyaW5nOyBsYXN0TmFtZTogc3RyaW5nOyBhZHVsdDogYm9vbGVhbiwgYWdlOiBudW1iZXIsIHJvbGVzOiBzdHJpbmdbXSB9XHJcblxyXG52YXIgaWJyYWhpbTogSVBlcnNvbiwgcmFteTogSVBlcnNvbjtcclxuXHJcbmNsYXNzIFJvb3REb20ge1xyXG4gICAgcHJpdmF0ZSBkb20gPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XHJcblxyXG4gICAgaW5zZXJ0KGJpbmRpbmcsIGRvbSwgaW5zZXJ0QXQpIHtcclxuICAgICAgICBpZiAoaW5zZXJ0QXQgPCB0aGlzLmRvbS5jaGlsZE5vZGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICB2YXIgYmVmb3JlRWxlbWVudCA9IHRoaXMuZG9tLmNoaWxkTm9kZXNbaW5zZXJ0QXRdO1xyXG4gICAgICAgICAgICB0aGlzLmRvbS5pbnNlcnRCZWZvcmUoZG9tLCBiZWZvcmVFbGVtZW50KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmRvbS5hcHBlbmRDaGlsZChkb20pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXQgY2hpbGROb2RlcygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kb20uY2hpbGROb2RlcztcclxuICAgIH1cclxufVxyXG5cclxuZGVzY3JpYmUoXCJ0ZW1wbGF0aW5nXCIsXHJcbiAgICAoKSA9PiB7XHJcblxyXG4gICAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgICAgICBpYnJhaGltID0ge1xyXG4gICAgICAgICAgICAgICAgYWdlOiAzNixcclxuICAgICAgICAgICAgICAgIGZpcnN0TmFtZTogXCJJYnJhaGltXCIsXHJcbiAgICAgICAgICAgICAgICBsYXN0TmFtZTogXCJiZW4gU2FsYWhcIixcclxuICAgICAgICAgICAgICAgIGFkdWx0OiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgcm9sZXM6IFtcImRldmVsb3BlclwiXVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICByYW15ID0ge1xyXG4gICAgICAgICAgICAgICAgYWdlOiA1LFxyXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiBcIlJhbXlcIixcclxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiBcImJlbiBTYWxhaFwiLFxyXG4gICAgICAgICAgICAgICAgYWR1bHQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgcm9sZXM6IFtdXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICBpdChcInRleHQgYmluZGluZ1wiLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RvcmUgPSBuZXcgUmUuU3RvcmUoeyBwOiBpYnJhaGltIH0pO1xyXG4gICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBuZXcgRG9tLlRleHRCaW5kaW5nKGZzKFwicC5maXJzdE5hbWVcIikpLnVwZGF0ZShzdG9yZSk7XHJcblxyXG4gICAgICAgICAgICAgICAgc3RvcmUuZ2V0KFwicFwiKS5nZXQoXCJmaXJzdE5hbWVcIikuc2V0KFwiYmxhXCIpO1xyXG5cclxuICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nLnRleHROb2RlLnRleHRDb250ZW50KS50b0JlKFwiYmxhXCIpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcuZGVwZW5kZW5jaWVzLmxlbmd0aCkudG9CZSgyKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KFwiY29udGVudCBiaW5kaW5nXCIsXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHZhciBzdG9yZSA9IG5ldyBSZS5TdG9yZSh7IHBlb3BsZTogW2licmFoaW0sIHJhbXldIH0pO1xyXG4gICAgICAgICAgICAgICAgdmFyIGZyYWdtZW50ID0gbmV3IFJvb3REb20oKTtcclxuICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gbmV3IERvbS5GcmFnbWVudEJpbmRpbmcoZnMoXCJmb3IgcCBpbiBwZW9wbGVcIiksXHJcbiAgICAgICAgICAgICAgICAgICAgW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgVGVtcGxhdGUuVGV4dFRlbXBsYXRlKGZzKFwicC5maXJzdE5hbWUgKyAnICcgKyBwLmxhc3ROYW1lXCIpKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFRlbXBsYXRlLkZyYWdtZW50VGVtcGxhdGUoZnMoXCJmb3IgciBpbiBwLnJvbGVzXCIpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNoaWxkKG5ldyBUZW1wbGF0ZS5UZXh0VGVtcGxhdGUoZnMoXCInOjogJyArIHJcIikpKVxyXG4gICAgICAgICAgICAgICAgICAgIF0pXHJcbiAgICAgICAgICAgICAgICAgICAgLm1hcChmcmFnbWVudClcclxuICAgICAgICAgICAgICAgICAgICAudXBkYXRlKHN0b3JlKTtcclxuXHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGgpLnRvQmUoMyk7XHJcblxyXG4gICAgICAgICAgICAgICAgc3RvcmUuZ2V0KFwicGVvcGxlXCIpLmdldCgxKS5nZXQoXCJyb2xlc1wiKS5zZXQoW1wiem9vblwiXSk7XHJcblxyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGZyYWdtZW50LmNoaWxkTm9kZXMubGVuZ3RoKS50b0JlKDQpO1xyXG5cclxuICAgICAgICAgICAgICAgIHN0b3JlLmdldChcInBlb3BsZVwiKS5nZXQoMCkuZ2V0KFwicm9sZXNcIikuc2V0KFtcInBhcGFcIl0pO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoXCJ0YWcgY2xhc3MgYmluZGluZ1wiLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IG5ldyBEb20uVGFnQmluZGluZyhcImRpdlwiKVxyXG4gICAgICAgICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgZnMoXCJwLmZpcnN0TmFtZVwiKSlcclxuICAgICAgICAgICAgICAgICAgICAuYXR0cihcImNsYXNzLmFkdWx0LXBlcnNvblwiLCBmcyhcInAuYWR1bHRcIikpO1xyXG5cclxuICAgICAgICAgICAgICAgIGJpbmRpbmcudXBkYXRlKG5ldyBSZS5TdG9yZSh7IHA6IGlicmFoaW0gfSkpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcudGFnTm9kZS5jbGFzc05hbWUpLnRvQmUoXCJJYnJhaGltIGFkdWx0LXBlcnNvblwiKTtcclxuXHJcbiAgICAgICAgICAgICAgICBiaW5kaW5nLnVwZGF0ZShuZXcgUmUuU3RvcmUoeyBwOiByYW15IH0pKTtcclxuICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nLnRhZ05vZGUuY2xhc3NOYW1lKS50b0JlKFwiUmFteVwiKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGl0KFwidGFnIGF0dHJpYnV0ZSBiaW5kaW5nXCIsXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gbmV3IERvbS5UYWdCaW5kaW5nKFwiZGl2XCIpXHJcbiAgICAgICAgICAgICAgICAgICAgLmF0dHIoXCJpZFwiLCBmcygncC5hZ2UnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgYmluZGluZy51cGRhdGUobmV3IFJlLlN0b3JlKHsgcDogaWJyYWhpbSB9KSk7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZy50YWdOb2RlLmlkKS50b0JlKCczNicpO1xyXG5cclxuICAgICAgICAgICAgICAgIGJpbmRpbmcudXBkYXRlKG5ldyBSZS5TdG9yZSh7IHA6IHJhbXkgfSkpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcudGFnTm9kZS5pZCkudG9CZSgnNScpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoXCJ0YWcgY2hpbGRyZW4gYmluZGluZ1wiLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RvcmUgPSBuZXcgUmUuU3RvcmUoeyBwOiBpYnJhaGltIH0pO1xyXG4gICAgICAgICAgICAgICAgdmFyIGRpdiA9IG5ldyBEb20uVGFnQmluZGluZyhcImRpdlwiKVxyXG4gICAgICAgICAgICAgICAgICAgIC5jaGlsZChuZXcgRG9tLlRleHRCaW5kaW5nKGZzKFwicC5maXJzdE5hbWVcIikpKVxyXG4gICAgICAgICAgICAgICAgICAgIC5hdHRyKFwiZGF0YS1hZ2VcIiwgZnMoXCJwLmFnZVwiKSk7XHJcbiAgICAgICAgICAgICAgICBkaXYudXBkYXRlKHN0b3JlKTtcclxuXHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZGl2LnRhZ05vZGUuY2hpbGROb2Rlcy5sZW5ndGgpLnRvQmUoMSk7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZGl2LnRhZ05vZGUudGV4dENvbnRlbnQpLnRvQmUoJ0licmFoaW0nKTtcclxuXHJcbiAgICAgICAgICAgICAgICBzdG9yZS5nZXQoJ3AnKS5nZXQoJ2ZpcnN0TmFtZScpLnNldCgnSUJSQUhJTScpO1xyXG5cclxuICAgICAgICAgICAgICAgIGV4cGVjdChkaXYudGFnTm9kZS50ZXh0Q29udGVudCkudG9CZSgnSUJSQUhJTScpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIGl0KFwidGFnIGV2ZW50IGJpbmRpbmdcIixcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdmFyIHN0b3JlID0gbmV3IFJlLlN0b3JlKHtcclxuICAgICAgICAgICAgICAgICAgICBwOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNheUhlbGxvKHVzZXIgPSAnSmFzbWluZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZSA9IFwiSGVsbG8sIFwiICsgdXNlciArIFwiIVwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgYnV0dG9uID0gbmV3IERvbS5UYWdCaW5kaW5nKFwiYnV0dG9uXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgLm9uKFwiY2xpY2tcIiwgZnMoXCJwLnNheUhlbGxvXCIpKVxyXG4gICAgICAgICAgICAgICAgICAgIC51cGRhdGUoc3RvcmUpO1xyXG5cclxuICAgICAgICAgICAgICAgIGJ1dHRvbi50cmlnZ2VyKCdjbGljaycpO1xyXG5cclxuICAgICAgICAgICAgICAgIGV4cGVjdChzdG9yZS5nZXQoJ3AnKS5nZXQoJ21lc3NhZ2UnKS52YWx1ZU9mKCkpLnRvQmUoXCJIZWxsbywgSmFzbWluZSFcIik7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdChcInN1cHBvcnRzIHN0cmVhbXNcIixcclxuICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdmFyIHN0cmVhbSA9IG5ldyBPYnNlcnZhYmxlcy5PYnNlcnZhYmxlPG51bWJlcj4oKTtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IG5ldyBEb20uVGV4dEJpbmRpbmcoZnMoXCJhd2FpdCB2YWx1ZVwiKSkudXBkYXRlKG5ldyBSZS5TdG9yZSh7IHZhbHVlOiBzdHJlYW0gfSkpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcudGV4dE5vZGUudGV4dENvbnRlbnQpLnRvQmUoXCJcIik7XHJcblxyXG4gICAgICAgICAgICAgICAgc3RyZWFtLm9uTmV4dCgxMjMpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcudGV4dE5vZGUudGV4dENvbnRlbnQpLnRvQmUoXCIxMjNcIik7XHJcblxyXG4gICAgICAgICAgICAgICAgc3RyZWFtLm9uTmV4dCg0NTYpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcudGV4dE5vZGUudGV4dENvbnRlbnQpLnRvQmUoXCI0NTZcIik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfSk7Il19