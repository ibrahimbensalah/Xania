"use strict";
var compile_1 = require("../src/compile");
var dom_1 = require("../src/dom");
var reactive_1 = require("../src/reactive");
var observables_1 = require("../src/observables");
var ibrahim, ramy;
var RootDom = (function () {
    function RootDom() {
        this.dom = document.createDocumentFragment();
    }
    RootDom.prototype.insert = function (binding, dom, insertAt) {
        if (insertAt < this.dom.childNodes.length) {
            var beforeElement = this.dom.childNodes[insertAt];
            this.dom.insertBefore(dom, beforeElement);
        }
        else {
            this.dom.appendChild(dom);
        }
    };
    Object.defineProperty(RootDom.prototype, "childNodes", {
        get: function () {
            return this.dom.childNodes;
        },
        enumerable: true,
        configurable: true
    });
    return RootDom;
}());
describe("templating", function () {
    beforeEach(function () {
        ibrahim = {
            age: 36,
            firstName: "Ibrahim",
            lastName: "ben Salah",
            adult: true,
            roles: ["developer"]
        };
        ramy = {
            age: 5,
            firstName: "Ramy",
            lastName: "ben Salah",
            adult: false,
            roles: []
        };
    });
    it("text binding", function () {
        var store = new reactive_1.Reactive.Store({ p: ibrahim });
        var binding = new dom_1.Dom.TextBinding(compile_1.default("p.firstName")).update(store, null);
        store.get("p").get("firstName").set("bla");
        expect(binding.textNode.textContent).toBe("bla");
    });
    it("content binding", function () {
        var store = new reactive_1.Reactive.Store({ people: [ibrahim, ramy] });
        var fragment = new RootDom();
        expect(fragment.childNodes.length).toBe(3);
        store.get("people").get(1).get("roles").set(["zoon"]);
        expect(fragment.childNodes.length).toBe(4);
        store.get("people").get(0).get("roles").set(["papa"]);
    });
    it("tag class binding", function () {
        var binding = new dom_1.Dom.TagBinding("div")
            .attr("class", compile_1.default("p.firstName"))
            .attr("class.adult-person", compile_1.default("p.adult"));
        binding.update(new reactive_1.Reactive.Store({ p: ibrahim }), null);
        expect(binding.tagNode.className).toBe("Ibrahim adult-person");
        binding.update(new reactive_1.Reactive.Store({ p: ramy }), null);
        expect(binding.tagNode.className).toBe("Ramy");
    });
    it("tag attribute binding", function () {
        var binding = new dom_1.Dom.TagBinding("div")
            .attr("id", compile_1.default('p.age'));
        binding.update(new reactive_1.Reactive.Store({ p: ibrahim }), null);
        expect(binding.tagNode.id).toBe('36');
        binding.update(new reactive_1.Reactive.Store({ p: ramy }), null);
        expect(binding.tagNode.id).toBe('5');
    });
    it("tag children binding", function () {
        var store = new reactive_1.Reactive.Store({ p: ibrahim });
        var div = new dom_1.Dom.TagBinding("div")
            .child(new dom_1.Dom.TextBinding(compile_1.default("p.firstName")))
            .attr("data-age", compile_1.default("p.age"));
        div.update(store, null);
        expect(div.tagNode.childNodes.length).toBe(1);
        expect(div.tagNode.textContent).toBe('Ibrahim');
        store.get('p').get('firstName').set('IBRAHIM');
        expect(div.tagNode.textContent).toBe('IBRAHIM');
    });
    it("tag event binding", function () {
        var store = new reactive_1.Reactive.Store({
            p: {
                message: null,
                sayHello: function (user) {
                    if (user === void 0) { user = 'Jasmine'; }
                    this.message = "Hello, " + user + "!";
                }
            }
        });
        var button = new dom_1.Dom.TagBinding("button")
            .attr("onclick", compile_1.default("p.sayHello"))
            .update(store, null);
        button.trigger('click');
        expect(store.get('p').get('message').valueOf()).toBe("Hello, Jasmine!");
    });
    it("supports streams", function () {
        var stream = new observables_1.Observables.Observable();
        var binding = new dom_1.Dom.TextBinding(compile_1.default("await stream"))
            .update(new reactive_1.Reactive.Store({ stream: stream }), null);
        expect(binding.textNode.textContent).toBe("");
        stream.notify(123);
        expect(binding.textNode.textContent).toBe("123");
        stream.notify(456);
        expect(binding.textNode.textContent).toBe("456");
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcGxhdGVTcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVtcGxhdGVTcGVjLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFHQSwwQ0FBcUM7QUFDckMsa0NBQWlDO0FBQ2pDLDRDQUFpRDtBQUNqRCxrREFBaUQ7QUFJakQsSUFBSSxPQUFnQixFQUFFLElBQWEsQ0FBQztBQUVwQztJQUFBO1FBQ1ksUUFBRyxHQUFHLFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0lBY3BELENBQUM7SUFaRyx3QkFBTSxHQUFOLFVBQU8sT0FBTyxFQUFFLEdBQUcsRUFBRSxRQUFRO1FBQ3pCLEVBQUUsQ0FBQyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3hDLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2xELElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM5QyxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5QixDQUFDO0lBQ0wsQ0FBQztJQUVELHNCQUFJLCtCQUFVO2FBQWQ7WUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7UUFDL0IsQ0FBQzs7O09BQUE7SUFDTCxjQUFDO0FBQUQsQ0FBQyxBQWZELElBZUM7QUFFRCxRQUFRLENBQUMsWUFBWSxFQUNqQjtJQUVJLFVBQVUsQ0FBQztRQUNQLE9BQU8sR0FBRztZQUNOLEdBQUcsRUFBRSxFQUFFO1lBQ1AsU0FBUyxFQUFFLFNBQVM7WUFDcEIsUUFBUSxFQUFFLFdBQVc7WUFDckIsS0FBSyxFQUFFLElBQUk7WUFDWCxLQUFLLEVBQUUsQ0FBQyxXQUFXLENBQUM7U0FDdkIs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bEQsSUFBSSxPQUFPLEdBQUcsSUFBSSxTQUFHLENBQUMsV0FBVyxDQUFDLGlCQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7YUFDckQsTUFBTSxDQUFDLElBQUksbUJBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxNQUFNLFFBQUEsRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDNUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRTlDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWpELE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JELENBQUMsQ0FBQyxDQUFDO0FBQ1gsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vbm9kZV9tb2R1bGVzL0B0eXBlcy9qYXNtaW5lL2luZGV4LmQudHNcIiAvPlxyXG5cclxuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tIFwiLi4vc3JjL3RlbXBsYXRlXCI7XHJcbmltcG9ydCBjb21waWxlIGZyb20gXCIuLi9zcmMvY29tcGlsZVwiO1xyXG5pbXBvcnQgeyBEb20gfSBmcm9tIFwiLi4vc3JjL2RvbVwiO1xyXG5pbXBvcnQgeyBSZWFjdGl2ZSBhcyBSZSB9IGZyb20gJy4uL3NyYy9yZWFjdGl2ZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGVzIH0gZnJvbSAnLi4vc3JjL29ic2VydmFibGVzJztcclxuXHJcbmludGVyZmFjZSBJUGVyc29uIHsgZmlyc3ROYW1lOiBzdHJpbmc7IGxhc3ROYW1lOiBzdHJpbmc7IGFkdWx0OiBib29sZWFuLCBhZ2U6IG51bWJlciwgcm9sZXM6IHN0cmluZ1tdIH1cclxuXHJcbnZhciBpYnJhaGltOiBJUGVyc29uLCByYW15OiBJUGVyc29uO1xyXG5cclxuY2xhc3MgUm9vdERvbSB7XHJcbiAgICBwcml2YXRlIGRvbSA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTtcclxuXHJcbiAgICBpbnNlcnQoYmluZGluZywgZG9tLCBpbnNlcnRBdCkge1xyXG4gICAgICAgIGlmIChpbnNlcnRBdCA8IHRoaXMuZG9tLmNoaWxkTm9kZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHZhciBiZWZvcmVFbGVtZW50ID0gdGhpcy5kb20uY2hpbGROb2Rlc1tpbnNlcnRBdF07XHJcbiAgICAgICAgICAgIHRoaXMuZG9tLmluc2VydEJlZm9yZShkb20sIGJlZm9yZUVsZW1lbnQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZG9tLmFwcGVuZENoaWxkKGRvbSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldCBjaGlsZE5vZGVzKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRvbS5jaGlsZE5vZGVzO1xyXG4gICAgfVxyXG59XHJcblxyXG5kZXNjcmliZShcInRlbXBsYXRpbmdcIixcclxuICAgICgpID0+IHtcclxuXHJcbiAgICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGlicmFoaW0gPSB7XHJcbiAgICAgICAgICAgICAgICBhZ2U6IDM2LFxyXG4gICAgICAgICAgICAgICAgZmlyc3ROYW1lOiBcIklicmFoaW1cIixcclxuICAgICAgICAgICAgICAgIGxhc3ROYW1lOiBcImJlbiBTYWxhaFwiLFxyXG4gICAgICAgICAgICAgICAgYWR1bHQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgICByb2xlczogW1wiZGV2ZWxvcGVyXCJdXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHJhbXkgPSB7XHJcbiAgICAgICAgICAgICAgICBhZ2U6IDUsXHJcbiAgICAgICAgICAgICAgICBmaXJzdE5hbWU6IFwiUmFteVwiLFxyXG4gICAgICAgICAgICAgICAgbGFzdE5hbWU6IFwiYmVuIFNhbGFoXCIsXHJcbiAgICAgICAgICAgICAgICBhZHVsdDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICByb2xlczogW11cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIGl0KFwidGV4dCBiaW5kaW5nXCIsXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHZhciBzdG9yZSA9IG5ldyBSZS5TdG9yZSh7IHA6IGlicmFoaW0gfSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IG5ldyBEb20uVGV4dEJpbmRpbmcoY29tcGlsZShcInAuZmlyc3ROYW1lXCIpKS51cGRhdGUoc3RvcmUsIG51bGwpO1xyXG5cclxuICAgICAgICAgICAgICAgIHN0b3JlLmdldChcInBcIikuZ2V0KFwiZmlyc3ROYW1lXCIpLnNldChcImJsYVwiKTtcclxuXHJcbiAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZy50ZXh0Tm9kZS50ZXh0Q29udGVudCkudG9CZShcImJsYVwiKTtcclxuICAgICAgICAgICAgICAgIC8vIGV4cGVjdChiaW5kaW5nLmRlcGVuZGVuY2llcy5sZW5ndGgpLnRvQmUoMik7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdChcImNvbnRlbnQgYmluZGluZ1wiLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RvcmUgPSBuZXcgUmUuU3RvcmUoeyBwZW9wbGU6IFtpYnJhaGltLCByYW15XSB9KTtcclxuICAgICAgICAgICAgICAgIHZhciBmcmFnbWVudCA9IG5ldyBSb290RG9tKCk7XHJcbiAgICAgICAgICAgICAgICAvL3ZhciBiaW5kaW5nID0gbmV3IEZyYWdtZW50QmluZGluZyhjb21waWxlKFwiZm9yIHAgaW4gcGVvcGxlXCIpLFxyXG4gICAgICAgICAgICAgICAgLy8gICAgW1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgIC8vbmV3IFRlbXBsYXRlLlRleHRUZW1wbGF0ZShjb21waWxlKFwicC5maXJzdE5hbWUgKyAnICcgKyBwLmxhc3ROYW1lXCIpKSxcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAvL25ldyBUZW1wbGF0ZS5GcmFnbWVudFRlbXBsYXRlKGNvbXBpbGUoXCJmb3IgciBpbiBwLnJvbGVzXCIpKVxyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgIC8vICAgIC5jaGlsZChuZXcgVGVtcGxhdGUuVGV4dFRlbXBsYXRlKGNvbXBpbGUoXCInOjogJyArIHJcIikpKVxyXG4gICAgICAgICAgICAgICAgLy8gICAgXSlcclxuICAgICAgICAgICAgICAgIC8vICAgIC51cGRhdGUoc3RvcmUsIGZyYWdtZW50KTtcclxuXHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGgpLnRvQmUoMyk7XHJcblxyXG4gICAgICAgICAgICAgICAgc3RvcmUuZ2V0KFwicGVvcGxlXCIpLmdldCgxKS5nZXQoXCJyb2xlc1wiKS5zZXQoW1wiem9vblwiXSk7XHJcblxyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGZyYWdtZW50LmNoaWxkTm9kZXMubGVuZ3RoKS50b0JlKDQpO1xyXG5cclxuICAgICAgICAgICAgICAgIHN0b3JlLmdldChcInBlb3BsZVwiKS5nZXQoMCkuZ2V0KFwicm9sZXNcIikuc2V0KFtcInBhcGFcIl0pO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoXCJ0YWcgY2xhc3MgYmluZGluZ1wiLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IG5ldyBEb20uVGFnQmluZGluZyhcImRpdlwiKVxyXG4gICAgICAgICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgY29tcGlsZShcInAuZmlyc3ROYW1lXCIpKVxyXG4gICAgICAgICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3MuYWR1bHQtcGVyc29uXCIsIGNvbXBpbGUoXCJwLmFkdWx0XCIpKTtcclxuXHJcbiAgICAgICAgICAgICAgICBiaW5kaW5nLnVwZGF0ZShuZXcgUmUuU3RvcmUoeyBwOiBpYnJhaGltIH0pLCBudWxsKTtcclxuICAgICAgICAgICAgICAgIGV4cGVjdChiaW5kaW5nLnRhZ05vZGUuY2xhc3NOYW1lKS50b0JlKFwiSWJyYWhpbSBhZHVsdC1wZXJzb25cIik7XHJcblxyXG4gICAgICAgICAgICAgICAgYmluZGluZy51cGRhdGUobmV3IFJlLlN0b3JlKHsgcDogcmFteSB9KSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZy50YWdOb2RlLmNsYXNzTmFtZSkudG9CZShcIlJhbXlcIik7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpdChcInRhZyBhdHRyaWJ1dGUgYmluZGluZ1wiLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IG5ldyBEb20uVGFnQmluZGluZyhcImRpdlwiKVxyXG4gICAgICAgICAgICAgICAgICAgIC5hdHRyKFwiaWRcIiwgY29tcGlsZSgncC5hZ2UnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgYmluZGluZy51cGRhdGUobmV3IFJlLlN0b3JlKHsgcDogaWJyYWhpbSB9KSwgbnVsbCk7XHJcbiAgICAgICAgICAgICAgICBleHBlY3QoYmluZGluZy50YWdOb2RlLmlkKS50b0JlKCczNicpO1xyXG5cclxuICAgICAgICAgICAgICAgIGJpbmRpbmcudXBkYXRlKG5ldyBSZS5TdG9yZSh7IHA6IHJhbXkgfSksIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcudGFnTm9kZS5pZCkudG9CZSgnNScpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoXCJ0YWcgY2hpbGRyZW4gYmluZGluZ1wiLFxyXG4gICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgc3RvcmUgPSBuZXcgUmUuU3RvcmUoeyBwOiBpYnJhaGltIH0pO1xyXG4gICAgICAgICAgICAgICAgdmFyIGRpdiA9IG5ldyBEb20uVGFnQmluZGluZyhcImRpdlwiKVxyXG4gICAgICAgICAgICAgICAgICAgIC5jaGlsZChuZXcgRG9tLlRleHRCaW5kaW5nKGNvbXBpbGUoXCJwLmZpcnN0TmFtZVwiKSkpXHJcbiAgICAgICAgICAgICAgICAgICAgLmF0dHIoXCJkYXRhLWFnZVwiLCBjb21waWxlKFwicC5hZ2VcIikpO1xyXG4gICAgICAgICAgICAgICAgZGl2LnVwZGF0ZShzdG9yZSwgbnVsbCk7XHJcblxyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGRpdi50YWdOb2RlLmNoaWxkTm9kZXMubGVuZ3RoKS50b0JlKDEpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGRpdi50YWdOb2RlLnRleHRDb250ZW50KS50b0JlKCdJYnJhaGltJyk7XHJcblxyXG4gICAgICAgICAgICAgICAgc3RvcmUuZ2V0KCdwJykuZ2V0KCdmaXJzdE5hbWUnKS5zZXQoJ0lCUkFISU0nKTtcclxuXHJcbiAgICAgICAgICAgICAgICBleHBlY3QoZGl2LnRhZ05vZGUudGV4dENvbnRlbnQpLnRvQmUoJ0lCUkFISU0nKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICBpdChcInRhZyBldmVudCBiaW5kaW5nXCIsXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHZhciBzdG9yZSA9IG5ldyBSZS5TdG9yZSh7XHJcbiAgICAgICAgICAgICAgICAgICAgcDoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzYXlIZWxsbyh1c2VyID0gJ0phc21pbmUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1lc3NhZ2UgPSBcIkhlbGxvLCBcIiArIHVzZXIgKyBcIiFcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdmFyIGJ1dHRvbiA9IG5ldyBEb20uVGFnQmluZGluZyhcImJ1dHRvblwiKVxyXG4gICAgICAgICAgICAgICAgICAgIC5hdHRyKFwib25jbGlja1wiLCBjb21waWxlKFwicC5zYXlIZWxsb1wiKSlcclxuICAgICAgICAgICAgICAgICAgICAudXBkYXRlKHN0b3JlLCBudWxsKTtcclxuXHJcbiAgICAgICAgICAgICAgICBidXR0b24udHJpZ2dlcignY2xpY2snKTtcclxuXHJcbiAgICAgICAgICAgICAgICBleHBlY3Qoc3RvcmUuZ2V0KCdwJykuZ2V0KCdtZXNzYWdlJykudmFsdWVPZigpKS50b0JlKFwiSGVsbG8sIEphc21pbmUhXCIpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgaXQoXCJzdXBwb3J0cyBzdHJlYW1zXCIsXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHZhciBzdHJlYW0gPSBuZXcgT2JzZXJ2YWJsZXMuT2JzZXJ2YWJsZTxudW1iZXI+KCk7XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBuZXcgRG9tLlRleHRCaW5kaW5nKGNvbXBpbGUoXCJhd2FpdCBzdHJlYW1cIikpXHJcbiAgICAgICAgICAgICAgICAgICAgLnVwZGF0ZShuZXcgUmUuU3RvcmUoeyBzdHJlYW0gfSksIG51bGwpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcudGV4dE5vZGUudGV4dENvbnRlbnQpLnRvQmUoXCJcIik7XHJcblxyXG4gICAgICAgICAgICAgICAgc3RyZWFtLm5vdGlmeSgxMjMpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcudGV4dE5vZGUudGV4dENvbnRlbnQpLnRvQmUoXCIxMjNcIik7XHJcblxyXG4gICAgICAgICAgICAgICAgc3RyZWFtLm5vdGlmeSg0NTYpO1xyXG4gICAgICAgICAgICAgICAgZXhwZWN0KGJpbmRpbmcudGV4dE5vZGUudGV4dENvbnRlbnQpLnRvQmUoXCI0NTZcIik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfSk7Il19