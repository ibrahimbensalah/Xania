"use strict";
var peg = require("./fsharp.peg");
var WHERE = 1;
var QUERY = 2;
var IDENT = 3;
var MEMBER = 4;
var APP = 5;
var SELECT = 6;
var CONST = 7;
var RANGE = 8;
var BINARY = 9;
var AWAIT = 10;
function accept(ast, visitor, context) {
    switch (ast.type) {
        case IDENT:
            return visitor.member(context, ast.name);
        case MEMBER:
            return visitor.member(accept(ast.target, visitor, context), accept(ast.member, visitor, context));
        case CONST:
            return visitor.const(ast.value);
        case BINARY:
            var left = accept(ast.left, visitor, context);
            var right = accept(ast.right, visitor, context);
            if (left === void 0 || right === void 0)
                return undefined;
            return visitor.app(ast.op, [right, left]);
        case APP:
            var args = [];
            for (var i = 0; i < ast.args.length; i++) {
                var arg = accept(ast.args[i], visitor, context);
                if (arg === void 0)
                    return arg;
                args.push(arg);
            }
            return visitor.app(accept(ast.fun, visitor, context), args);
        case QUERY:
            return visitor.query(ast.param, accept(ast.source, visitor, context));
        case SELECT:
            return visitor.select(accept(ast.source, visitor, context), function (s) { return accept(ast.selector, visitor, s); });
        case WHERE:
            return visitor.where(accept(ast.source, visitor, context), accept(ast.predicate, visitor, context));
        case RANGE:
            var first = accept(ast.from, visitor, context);
            var last = accept(ast.to, visitor, context);
            if (first === void 0 || last === void 0)
                return first;
            return new Range(first.valueOf(), last.valueOf());
        case AWAIT:
            return visitor.await(accept(ast.expr, visitor, context));
        default:
            return ast;
    }
}
exports.accept = accept;
var Range = (function () {
    function Range(first, last) {
        this.first = first;
        this.last = last;
    }
    Range.prototype.map = function (fn) {
        var result = [], last = this.last;
        for (var i = this.first; i <= last; i++) {
            result.push(fn(i));
        }
        return result;
    };
    return Range;
}());
exports.fsharp = peg.parse;
function fs(expr) {
    return new Expression(peg.parse(expr));
}
exports.fs = fs;
var Expression = (function () {
    function Expression(ast) {
        this.ast = ast;
    }
    Expression.prototype.execute = function (binding, context) {
        return accept(this.ast, binding, context);
    };
    return Expression;
}());
var empty = "";
function parseTpl(text) {
    var parts = [];
    var appendText = function (x) {
        var s = x.trim();
        if (s.length > 0) {
            parts.push(x);
        }
    };
    var offset = 0, textlength = text.length;
    while (offset < textlength) {
        var begin = text.indexOf("{{", offset);
        if (begin >= 0) {
            if (begin > offset)
                appendText(text.substring(offset, begin));
            offset = begin + 2;
            var end = text.indexOf("}}", offset);
            if (end >= 0) {
                parts.push(peg.parse(text.substring(offset, end)));
                offset = end + 2;
            }
            else {
                throw new SyntaxError("Expected '}}' but not found starting from index: " + offset);
            }
        }
        else {
            appendText(text.substring(offset));
            break;
        }
    }
    if (parts.length === 0)
        return null;
    if (parts.length === 1) {
        var part = parts[0];
        if (typeof part === "string")
            return part;
        return new Expression(part);
    }
    return {
        parts: parts,
        execute: function (visitor, context) {
            var result = empty, parts = this.parts, length = parts.length, acc = accept;
            for (var i = 0; i < length; i++) {
                var p = acc(parts[i], visitor, context);
                if (p === void 0 || p === null)
                    return p;
                var inner = p.valueOf();
                if (inner === void 0)
                    return inner;
                if (inner !== null)
                    result += inner;
            }
            return result;
        }
    };
}
exports.parseTpl = parseTpl;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnNoYXJwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2ZzaGFycC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBWUEsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBS2xDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztBQUNaLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztBQUdmLGdCQUF1QixHQUFRLEVBQUUsT0FBb0IsRUFBRSxPQUFPO0lBQzFELE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2YsS0FBSyxLQUFLO1lBQ04sTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QyxLQUFLLE1BQU07WUFDUCxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDdEcsS0FBSyxLQUFLO1lBQ04sTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3BDLEtBQUssTUFBTTtZQUNQLElBQUksSUFBSSxH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QUMsQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLENBQUM7b0JBQ2pCLE1BQU0sQ0FBQyxLQUFLLENBQUM7Z0JBQ2pCLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUM7b0JBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQztZQUN4QixDQUFDO1lBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUNsQixDQUFDO0tBQ0csQ0FBQztBQUNiLENBQUM7QUE5REQsNEJBOERDIiwic291cmNlc0NvbnRlbnQiOlsiaW50ZXJmYWNlIElBc3RWaXNpdG9yIHtcclxuICAgIHdoZXJlKHNvdXJjZSwgcHJlZGljYXRlKTtcclxuICAgIHNlbGVjdChzb3VyY2UsIHNlbGVjdG9yKTtcclxuICAgIHF1ZXJ5KHBhcmFtLCBzb3VyY2UpO1xyXG4gICAgbWVtYmVyKHRhcmdldCwgbmFtZSk7XHJcbiAgICBhcHAoZnVuLCBhcmdzOiBhbnlbXSk7XHJcbiAgICBhd2FpdChvYnNlcnZhYmxlKTtcclxuICAgIGNvbnN0KHZhbHVlKTtcclxufVxyXG5cclxuZGVjbGFyZSBmdW5jdGlvbiByZXF1aXJlKG1vZHVsZTogc3RyaW5nKTtcclxuXHJcbnZhciBwZWcgPSByZXF1aXJlKFwiLi9mc2hhcnAucGVnXCIpO1xyXG5cclxuLy8gdmFyIGZzaGFycCA9IHBlZy5wYXJzZTtcclxuXHJcbi8vIFJlU2hhcnBlciBkaXNhYmxlIEluY29uc2lzdGVudE5hbWluZ1xyXG52YXIgV0hFUkUgPSAxO1xyXG52YXIgUVVFUlkgPSAyO1xyXG52YXIgSURFTlQgPSAzO1xyXG52YXIgTUVNQkVSID0gNDtcclxudmFyIEFQUCA9IDU7XHJcbnZhciBTRUxFQ1QgPSA2O1xyXG52YXIgQ09OU1QgPSA3O1xyXG52YXIgUkFOR0UgPSA4O1xyXG52YXIgQklOQVJZID0gOTtcclxudmFyIEFXQUlUID0gMTA7XHJcbi8vIFJlU2hhcnBlciByZXN0b3JlIEluY29uc2lzdGVudE5hbWluZ1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFjY2VwdChhc3Q6IGFueSwgdmlzaXRvcjogSUFzdFZpc2l0b3IsIGNvbnRleHQpIHtcclxuICAgIHN3aXRjaCAoYXN0LnR5cGUpIHtcclxuICAgICAgICBjYXNlIElERU5UOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5tZW1iZXIoY29udGV4dCwgYXN0Lm5hbWUpO1xyXG4gICAgICAgIGNhc2UgTUVNQkVSOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5tZW1iZXIoYWNjZXB0KGFzdC50YXJnZXQsIHZpc2l0b3IsIGNvbnRleHQpLCBhY2NlcHQoYXN0Lm1lbWJlciwgdmlzaXRvciwgY29udGV4dCkpO1xyXG4gICAgICAgIGNhc2UgQ09OU1Q6XHJcbiAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLmNvbnN0KGFzdC52YWx1ZSk7XHJcbiAgICAgICAgY2FzZSBCSU5BUlk6XHJcbiAgICAgICAgICAgIHZhciBsZWZ0ID0gYWNjZXB0KGFzdC5sZWZ0LCB2aXNpdG9yLCBjb250ZXh0KTtcclxuICAgICAgICAgICAgdmFyIHJpZ2h0ID0gYWNjZXB0KGFzdC5yaWdodCwgdmlzaXRvciwgY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICBpZiAobGVmdCA9PT0gdm9pZCAwIHx8IHJpZ2h0ID09PSB2b2lkIDApXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3IuYXBwKGFzdC5vcCwgW3JpZ2h0LCBsZWZ0XSk7XHJcbiAgICAgICAgY2FzZSBBUFA6XHJcbiAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSBbXTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhc3QuYXJncy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdmFyIGFyZyA9IGFjY2VwdChhc3QuYXJnc1tpXSwgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXJnID09PSB2b2lkIDApXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFyZztcclxuICAgICAgICAgICAgICAgIGFyZ3MucHVzaChhcmcpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLmFwcChhY2NlcHQoYXN0LmZ1biwgdmlzaXRvciwgY29udGV4dCksIGFyZ3MpO1xyXG4gICAgICAgIGNhc2UgUVVFUlk6XHJcbiAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLnF1ZXJ5KGFzdC5wYXJhbSwgYWNjZXB0KGFzdC5zb3VyY2UsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBjYXNlIFNFTEVDVDpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3Iuc2VsZWN0KGFjY2VwdChhc3Quc291cmNlLCB2aXNpdG9yLCBjb250ZXh0KSwgcyA9PiBhY2NlcHQoYXN0LnNlbGVjdG9yLCB2aXNpdG9yLCBzKSk7XHJcbiAgICAgICAgY2FzZSBXSEVSRTpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3Iud2hlcmUoYWNjZXB0KGFzdC5zb3VyY2UsIHZpc2l0b3IsIGNvbnRleHQpLCBhY2NlcHQoYXN0LnByZWRpY2F0ZSwgdmlzaXRvciwgY29udGV4dCkpO1xyXG4gICAgICAgIGNhc2UgUkFOR0U6XHJcbiAgICAgICAgICAgIHZhciBmaXJzdCA9IGFjY2VwdChhc3QuZnJvbSwgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgIHZhciBsYXN0ID0gYWNjZXB0KGFzdC50bywgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgIGlmIChmaXJzdCA9PT0gdm9pZCAwIHx8IGxhc3QgPT09IHZvaWQgMClcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdDtcclxuICAgICAgICAgICAgLy8gVE9ETyBsYXp5IGltcGxcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBSYW5nZShmaXJzdC52YWx1ZU9mKCksIGxhc3QudmFsdWVPZigpKTtcclxuICAgICAgICBjYXNlIEFXQUlUOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5hd2FpdChhY2NlcHQoYXN0LmV4cHIsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICByZXR1cm4gYXN0O1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBSYW5nZSB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZpcnN0LCBwcml2YXRlIGxhc3QpIHtcclxuICAgIH1cclxuXHJcbiAgICBtYXAoZm4pIHtcclxuICAgICAgICB2YXIgcmVzdWx0ID0gW10sIGxhc3QgPSB0aGlzLmxhc3Q7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuZmlyc3Q7IGkgPD0gbGFzdDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGZuKGkpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IHZhciBmc2hhcnAgPSBwZWcucGFyc2U7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZnMoZXhwcikge1xyXG4gICAgcmV0dXJuIG5ldyBFeHByZXNzaW9uKHBlZy5wYXJzZShleHByKSk7XHJcbn1cclxuXHJcbmNsYXNzIEV4cHJlc3Npb24ge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhc3QpIHtcclxuICAgIH1cclxuICAgIGV4ZWN1dGUoYmluZGluZzogSUFzdFZpc2l0b3IsIGNvbnRleHQ6IGFueSkge1xyXG4gICAgICAgIHJldHVybiBhY2NlcHQodGhpcy5hc3QsIGJpbmRpbmcsIGNvbnRleHQpO1xyXG4gICAgfVxyXG59XHJcblxyXG52YXIgZW1wdHkgPSBcIlwiO1xyXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VUcGwodGV4dCk6IHsgZXhlY3V0ZSh2aXNpdG9yOiBJQXN0VmlzaXRvciwgY29udGV4dCk7IH0gfCBzdHJpbmcge1xyXG4gICAgdmFyIHBhcnRzOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgIHZhciBhcHBlbmRUZXh0ID0gKHgpID0+IHtcclxuICAgICAgICB2YXIgcyA9IHgudHJpbSgpO1xyXG4gICAgICAgIGlmIChzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcGFydHMucHVzaCh4KTtcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIHZhciBvZmZzZXQgPSAwLCB0ZXh0bGVuZ3RoID0gdGV4dC5sZW5ndGg7XHJcbiAgICB3aGlsZSAob2Zmc2V0IDwgdGV4dGxlbmd0aCkge1xyXG4gICAgICAgIHZhciBiZWdpbiA9IHRleHQuaW5kZXhPZihcInt7XCIsIG9mZnNldCk7XHJcbiAgICAgICAgaWYgKGJlZ2luID49IDApIHtcclxuICAgICAgICAgICAgaWYgKGJlZ2luID4gb2Zmc2V0KVxyXG4gICAgICAgICAgICAgICAgYXBwZW5kVGV4dCh0ZXh0LnN1YnN0cmluZyhvZmZzZXQsIGJlZ2luKSk7XHJcblxyXG4gICAgICAgICAgICBvZmZzZXQgPSBiZWdpbiArIDI7XHJcbiAgICAgICAgICAgIGNvbnN0IGVuZCA9IHRleHQuaW5kZXhPZihcIn19XCIsIG9mZnNldCk7XHJcbiAgICAgICAgICAgIGlmIChlbmQgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgcGFydHMucHVzaChwZWcucGFyc2UodGV4dC5zdWJzdHJpbmcob2Zmc2V0LCBlbmQpKSk7XHJcbiAgICAgICAgICAgICAgICBvZmZzZXQgPSBlbmQgKyAyO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFwiRXhwZWN0ZWQgJ319JyBidXQgbm90IGZvdW5kIHN0YXJ0aW5nIGZyb20gaW5kZXg6IFwiICsgb2Zmc2V0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGFwcGVuZFRleHQodGV4dC5zdWJzdHJpbmcob2Zmc2V0KSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAocGFydHMubGVuZ3RoID09PSAwKVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG5cclxuICAgIGlmIChwYXJ0cy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICBjb25zdCBwYXJ0ID0gcGFydHNbMF07XHJcbiAgICAgICAgaWYgKHR5cGVvZiBwYXJ0ID09PSBcInN0cmluZ1wiKVxyXG4gICAgICAgICAgICByZXR1cm4gcGFydDtcclxuICAgICAgICByZXR1cm4gbmV3IEV4cHJlc3Npb24ocGFydCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgICBwYXJ0cyxcclxuICAgICAgICBleGVjdXRlKHZpc2l0b3IsIGNvbnRleHQpIHtcclxuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGVtcHR5LFxyXG4gICAgICAgICAgICAgICAgcGFydHMgPSB0aGlzLnBhcnRzLFxyXG4gICAgICAgICAgICAgICAgbGVuZ3RoID0gcGFydHMubGVuZ3RoLFxyXG4gICAgICAgICAgICAgICAgYWNjID0gYWNjZXB0O1xyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdmFyIHAgPSBhY2MocGFydHNbaV0sIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHAgPT09IHZvaWQgMCB8fCBwID09PSBudWxsKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBwO1xyXG4gICAgICAgICAgICAgICAgdmFyIGlubmVyID0gcC52YWx1ZU9mKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5uZXIgPT09IHZvaWQgMClcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5uZXI7XHJcbiAgICAgICAgICAgICAgICBpZiAoaW5uZXIgIT09IG51bGwpXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9IGlubmVyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfVxyXG4gICAgfSBhcyBhbnk7XHJcbn1cclxuXHJcbiJdfQ==