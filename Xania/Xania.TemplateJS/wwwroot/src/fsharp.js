"use strict";
var peg = require("./fsharp.peg");
var WHERE = "where";
var QUERY = "query";
var IDENT = "ident";
var MEMBER = "member";
var APP = "app";
var SELECT = "select";
var CONST = "const";
var RANGE = "range";
var BINARY = "binary";
var AWAIT = "await";
function accept(ast, visitor, context) {
    if (ast.type === undefined)
        return ast;
    switch (ast.type) {
        case WHERE:
            return visitor.where(accept(ast.source, visitor, context), accept(ast.predicate, visitor, context));
        case QUERY:
            return visitor.query(ast.param, accept(ast.source, visitor, context));
        case IDENT:
            return visitor.member(context, ast.name);
        case MEMBER:
            return visitor.member(accept(ast.target, visitor, context), accept(ast.member, visitor, context));
        case APP:
            var args = [];
            for (var i_1 = 0; i_1 < ast.args.length; i_1++) {
                var arg = accept(ast.args[i_1], visitor, context);
                if (arg === void 0)
                    return arg;
                args.push(arg);
            }
            return visitor.app(accept(ast.fun, visitor, context), args);
        case SELECT:
            return visitor.select(accept(ast.source, visitor, context), function (s) { return accept(ast.selector, visitor, s); });
        case CONST:
            return visitor.const(ast.value);
        case RANGE:
            var first = accept(ast.from, visitor, context);
            var last = accept(ast.to, visitor, context);
            if (first === void 0 || last === void 0)
                return undefined;
            var arr = [];
            for (var i = first; i <= last; i++)
                arr.push(i);
            return arr;
        case BINARY:
            var left = accept(ast.left, visitor, context);
            var right = accept(ast.right, visitor, context);
            if (left === void 0 || right === void 0)
                return undefined;
            return visitor.app(ast.op, [right, left]);
        case AWAIT:
            return visitor.await(accept(ast.expr, visitor, context));
        default:
            throw new Error("not supported type " + ast.type);
    }
}
exports.accept = accept;
exports.fsharp = peg.parse;
function fs(expr) {
    return {
        ast: peg.parse(expr),
        execute: function (binding, context) {
            return accept(this.ast, binding, context);
        }
    };
}
exports.fs = fs;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnNoYXJwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2ZzaGFycC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBWUEsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBS2xDLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQztBQUN0QixJQUFNLEtBQUssR0FBRyxPQUFPLENBQUM7QUFDdEIsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDO0FBQ3RCLElBQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQztBQUN4QixJQUFNLEdBQUcsR0FBRyxLQUFLLENBQUM7QUFDbEIsSUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDO0FBQ3hCLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQztBQUN0QixJQUFNLEtBQUssR0FBRyxPQUFPLENBQUM7QUFDdEIsSUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDO0FBQ3hCLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQztBQUd0QixnQkFBdUIsR0FBUSxFQUFFLE9BQW9CLEVBQUUsT0FBTztJQUMxRCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQztRQUN2QixNQUFNLENBQUMsR0FBRyxDQUFDO0lBRWYsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDZixLQUFLLEtBQUs7WUFDTixNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDeEcsS0FBSyxLQUFLO1lBQ04sTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVB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SSxDQUFDLENBQUMsQ0FBQztRQUM5QyxLQUFLLEtBQUs7WUFDTixNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUM3RDtZQUNJLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXNCLEdBQUcsQ0FBQyxJQUFNLENBQUMsQ0FBQztJQUMxRCxDQUFDO0FBQ0wsQ0FBQztBQWhERCx3QkFnREM7QUFFVSxRQUFBLE1BQU0sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO0FBRTlCLFlBQW1CLElBQUk7SUFDbkIsTUFBTSxDQUFDO1FBQ0gsR0FBRyxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBQ3BCLE9BQU8sWUFBQyxPQUFvQixFQUFFLE9BQVk7WUFDdEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM5QyxDQUFDO0tBQ0osQ0FBQTtBQUNMLENBQUM7QUFQRCxnQkFPQyIsInNvdXJjZXNDb250ZW50IjpbImludGVyZmFjZSBJQXN0VmlzaXRvciB7XHJcbiAgICB3aGVyZShzb3VyY2UsIHByZWRpY2F0ZSk7XHJcbiAgICBzZWxlY3Qoc291cmNlLCBzZWxlY3Rvcik7XHJcbiAgICBxdWVyeShwYXJhbSwgc291cmNlKTtcclxuICAgIG1lbWJlcih0YXJnZXQsIG5hbWUpO1xyXG4gICAgYXBwKGZ1biwgYXJnczogYW55W10pO1xyXG4gICAgYXdhaXQob2JzZXJ2YWJsZSk7XHJcbiAgICBjb25zdCh2YWx1ZSk7XHJcbn1cclxuXHJcbmRlY2xhcmUgZnVuY3Rpb24gcmVxdWlyZShtb2R1bGU6IHN0cmluZyk7XHJcblxyXG52YXIgcGVnID0gcmVxdWlyZShcIi4vZnNoYXJwLnBlZ1wiKTtcclxuXHJcbi8vIHZhciBmc2hhcnAgPSBwZWcucGFyc2U7XHJcblxyXG4vLyBSZVNoYXJwZXIgZGlzYWJsZSBJbmNvbnNpc3RlbnROYW1pbmdcclxuY29uc3QgV0hFUkUgPSBcIndoZXJlXCI7XHJcbmNvbnN0IFFVRVJZID0gXCJxdWVyeVwiO1xyXG5jb25zdCBJREVOVCA9IFwiaWRlbnRcIjtcclxuY29uc3QgTUVNQkVSID0gXCJtZW1iZXJcIjtcclxuY29uc3QgQVBQID0gXCJhcHBcIjtcclxuY29uc3QgU0VMRUNUID0gXCJzZWxlY3RcIjtcclxuY29uc3QgQ09OU1QgPSBcImNvbnN0XCI7XHJcbmNvbnN0IFJBTkdFID0gXCJyYW5nZVwiO1xyXG5jb25zdCBCSU5BUlkgPSBcImJpbmFyeVwiO1xyXG5jb25zdCBBV0FJVCA9IFwiYXdhaXRcIjtcclxuLy8gUmVTaGFycGVyIHJlc3RvcmUgSW5jb25zaXN0ZW50TmFtaW5nXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gYWNjZXB0KGFzdDogYW55LCB2aXNpdG9yOiBJQXN0VmlzaXRvciwgY29udGV4dCkge1xyXG4gICAgaWYgKGFzdC50eXBlID09PSB1bmRlZmluZWQpXHJcbiAgICAgICAgcmV0dXJuIGFzdDtcclxuXHJcbiAgICBzd2l0Y2ggKGFzdC50eXBlKSB7XHJcbiAgICAgICAgY2FzZSBXSEVSRTpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3Iud2hlcmUoYWNjZXB0KGFzdC5zb3VyY2UsIHZpc2l0b3IsIGNvbnRleHQpLCBhY2NlcHQoYXN0LnByZWRpY2F0ZSwgdmlzaXRvciwgY29udGV4dCkpO1xyXG4gICAgICAgIGNhc2UgUVVFUlk6XHJcbiAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLnF1ZXJ5KGFzdC5wYXJhbSwgYWNjZXB0KGFzdC5zb3VyY2UsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBjYXNlIElERU5UOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5tZW1iZXIoY29udGV4dCwgYXN0Lm5hbWUpO1xyXG4gICAgICAgIGNhc2UgTUVNQkVSOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5tZW1iZXIoYWNjZXB0KGFzdC50YXJnZXQsIHZpc2l0b3IsIGNvbnRleHQpLCBhY2NlcHQoYXN0Lm1lbWJlciwgdmlzaXRvciwgY29udGV4dCkpO1xyXG4gICAgICAgIGNhc2UgQVBQOlxyXG4gICAgICAgICAgICBjb25zdCBhcmdzID0gW107XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXN0LmFyZ3MubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBhcmcgPSBhY2NlcHQoYXN0LmFyZ3NbaV0sIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFyZyA9PT0gdm9pZCAwKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmc7XHJcbiAgICAgICAgICAgICAgICBhcmdzLnB1c2goYXJnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5hcHAoYWNjZXB0KGFzdC5mdW4sIHZpc2l0b3IsIGNvbnRleHQpLCBhcmdzKTtcclxuICAgICAgICBjYXNlIFNFTEVDVDpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3Iuc2VsZWN0KGFjY2VwdChhc3Quc291cmNlLCB2aXNpdG9yLCBjb250ZXh0KSwgcyA9PiBhY2NlcHQoYXN0LnNlbGVjdG9yLCB2aXNpdG9yLCBzKSk7XHJcbiAgICAgICAgY2FzZSBDT05TVDpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3IuY29uc3QoYXN0LnZhbHVlKTtcclxuICAgICAgICBjYXNlIFJBTkdFOlxyXG4gICAgICAgICAgICB2YXIgZmlyc3QgPSBhY2NlcHQoYXN0LmZyb20sIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICB2YXIgbGFzdCA9IGFjY2VwdChhc3QudG8sIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICBpZiAoZmlyc3QgPT09IHZvaWQgMCB8fCBsYXN0ID09PSB2b2lkIDApXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB2YXIgYXJyID0gW107XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBmaXJzdDsgaSA8PSBsYXN0OyBpKyspXHJcbiAgICAgICAgICAgICAgICBhcnIucHVzaChpKTtcclxuICAgICAgICAgICAgcmV0dXJuIGFycjtcclxuICAgICAgICBjYXNlIEJJTkFSWTpcclxuICAgICAgICAgICAgdmFyIGxlZnQgPSBhY2NlcHQoYXN0LmxlZnQsIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICB2YXIgcmlnaHQgPSBhY2NlcHQoYXN0LnJpZ2h0LCB2aXNpdG9yLCBjb250ZXh0KTtcclxuXHJcbiAgICAgICAgICAgIGlmIChsZWZ0ID09PSB2b2lkIDAgfHwgcmlnaHQgPT09IHZvaWQgMClcclxuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5hcHAoYXN0Lm9wLCBbcmlnaHQsIGxlZnRdKTtcclxuICAgICAgICBjYXNlIEFXQUlUOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5hd2FpdChhY2NlcHQoYXN0LmV4cHIsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5vdCBzdXBwb3J0ZWQgdHlwZSAke2FzdC50eXBlfWApO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgdmFyIGZzaGFycCA9IHBlZy5wYXJzZTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmcyhleHByKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIGFzdDogcGVnLnBhcnNlKGV4cHIpLFxyXG4gICAgICAgIGV4ZWN1dGUoYmluZGluZzogSUFzdFZpc2l0b3IsIGNvbnRleHQ6IGFueSkge1xyXG4gICAgICAgICAgICByZXR1cm4gYWNjZXB0KHRoaXMuYXN0LCBiaW5kaW5nLCBjb250ZXh0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=