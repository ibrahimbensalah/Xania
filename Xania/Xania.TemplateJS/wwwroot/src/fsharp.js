"use strict";
var peg = require("./fsharp.peg");
function empty(list) {
    return list.length === 0;
}
function not(value) {
    return !value;
}
function count(list) {
    return list.length;
}
var WHERE = 1;
var QUERY = 2;
var IDENT = 3;
var MEMBER = 4;
var APP = 5;
var SELECT = 6;
var CONST = 7;
var RANGE = 8;
var BINARY = 9;
var AWAIT = 10;
var PIPE = 11;
var COMPOSE = 12;
var LAMBDA = 13;
function accept(ast, visitor, context) {
    var length;
    switch (ast.type) {
        case IDENT:
            switch (ast.name) {
                case "null":
                    return null;
                case "true":
                    return true;
                case "false":
                    return false;
                case "no":
                case "empty":
                    return empty;
                case "count":
                    return count;
                case "not":
                    return not;
                default:
                    return visitor.member(context, ast.name);
            }
        case MEMBER:
            return visitor.member(accept(ast.target, visitor, context), accept(ast.member, visitor, context));
        case CONST:
            return visitor.const(ast.value);
        case BINARY:
            var source;
            switch (ast.op) {
                case "->":
                    source = accept(ast.left, visitor, context);
                    if (source === void 0)
                        return void 0;
                    return source.valueOf() ? accept(ast.right, visitor, context) : void 0;
                case WHERE:
                    source = accept(ast.left, visitor, context);
                    length = visitor.member(source, "length").value;
                    var result = [];
                    for (var i = 0; i < length; i++) {
                        var item = visitor.member(source, i);
                        var scope = new Scope(visitor, [item, context]);
                        var b = accept(ast.right, visitor, scope).valueOf();
                        if (b)
                            result.push(item);
                    }
                    return result;
                default:
                    var left = accept(ast.left, visitor, context);
                    var right = accept(ast.right, visitor, context);
                    if (left === void 0 || right === void 0)
                        return void 0;
                    return visitor.app(ast.op, [right, left]);
            }
        case APP:
            var args = void 0;
            length = ast.args.length;
            for (var i_1 = 0; i_1 < length; i_1++) {
                var arg = accept(ast.args[i_1], visitor, context);
                if (arg === void 0)
                    return arg;
                if (!args)
                    args = [arg];
                else
                    args.push(arg);
            }
            var fun = accept(ast.fun, visitor, context);
            if (fun === void 0) {
                console.error("could not resolve expression, " + JSON.stringify(ast.fun));
                return void 0;
            }
            else
                return visitor.app(fun, args);
        case QUERY:
            return visitor.query(ast.param, accept(ast.source, visitor, context));
        case SELECT:
            return visitor.select(accept(ast.source, visitor, context), function (s) { return accept(ast.selector, visitor, s); });
        case WHERE:
            return visitor.where(accept(ast.source, visitor, context), accept(ast.predicate, visitor, context));
        case RANGE:
            var first = accept(ast.from, visitor, context);
            var last = accept(ast.to, visitor, context);
            if (first === void 0 || last === void 0)
                return first;
            return new Range(first.valueOf(), last.valueOf());
        case AWAIT:
            return visitor.await(accept(ast.expr, visitor, context));
        case LAMBDA:
            return function (model) {
                var context = visitor.extend(ast.param, model);
                return accept(ast.body, visitor, context);
            };
        default:
            return ast;
    }
}
exports.accept = accept;
var Range = (function () {
    function Range(first, last) {
        this.first = first;
        this.last = last;
    }
    Range.prototype.map = function (fn) {
        var result = [], last = this.last;
        for (var i = this.first; i <= last; i++) {
            result.push(fn(i));
        }
        return result;
    };
    return Range;
}());
exports.fsharp = peg.parse;
function fs(expr) {
    return new Expression(peg.parse(expr));
}
exports.fs = fs;
var Expression = (function () {
    function Expression(ast) {
        this.ast = ast;
    }
    Expression.prototype.execute = function (binding, context) {
        if (Array.isArray(context))
            return accept(this.ast, binding, new Scope(binding, context));
        else
            return accept(this.ast, binding, context);
    };
    return Expression;
}());
var Scope = (function () {
    function Scope(visitor, contexts) {
        this.visitor = visitor;
        this.contexts = contexts;
    }
    Scope.prototype.get = function (name) {
        var visitor = this.visitor;
        var contexts = this.contexts;
        for (var i = 0; i < this.contexts.length; i++) {
            var value = visitor.member(contexts[i], name);
            if (value !== void 0)
                return value;
        }
        return void 0;
    };
    return Scope;
}());
exports.Scope = Scope;
exports.TOKENS = { WHERE: WHERE, QUERY: QUERY, IDENT: IDENT, MEMBER: MEMBER, APP: APP, SELECT: SELECT, CONST: CONST, RANGE: RANGE, BINARY: BINARY, AWAIT: AWAIT, PIPE: PIPE, COMPOSE: COMPOSE };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnNoYXJwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2ZzaGFycC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBYUEsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBRWxDLGVBQWUsSUFBSTtJQUNmLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBRUQsYUFBYSxLQUFLO0lBQ2QsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ2xCLENBQUM7QUFFRCxlQUFlLElBQUk7SUFDZixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztBQUN2QixDQUFDO0FBR0QsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0FBQ2QsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0FBQ2QsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0FBQ2QsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ2YsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO0FBQ1osSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ2YsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0FBQ2QsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0FBQ2QsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ2YsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO0FBQ2YsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ2QsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDO0FBQ2pCLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztBQUdoQixnQkFBdUIsR0FBUSxFQUFFLE9BQW9CLEVBQUUsT0FBTztJQUMxRCxJQUFJLE1BQU0sQ0FBQztJQUNYLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2YsS0FBSyxLQUFLO1lBQ04sTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFD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O1FBQ3JCLENBQUM7UUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUNMLFlBQUM7QUFBRCxDQUFDLEFBZkQsSUFlQztBQWZZLHNCQUFLO0FBaUJQLFFBQUEsTUFBTSxHQUFHLEVBQUUsS0FBSyxPQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsTUFBTSxRQUFBLEVBQUUsR0FBRyxLQUFBLEVBQUUsTUFBTSxRQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsTUFBTSxRQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsSUFBSSxNQUFBLEVBQUUsT0FBTyxTQUFBLEVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBpbnRlcmZhY2UgSUFzdFZpc2l0b3Ige1xyXG4gICAgd2hlcmUoc291cmNlLCBwcmVkaWNhdGUpO1xyXG4gICAgc2VsZWN0KHNvdXJjZSwgc2VsZWN0b3IpO1xyXG4gICAgcXVlcnkocGFyYW0sIHNvdXJjZSk7XHJcbiAgICBtZW1iZXIodGFyZ2V0LCBuYW1lKTtcclxuICAgIGFwcChmdW4sIGFyZ3M6IGFueVtdKTtcclxuICAgIGV4dGVuZChuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpO1xyXG4gICAgYXdhaXQob2JzZXJ2YWJsZSk7XHJcbiAgICBjb25zdCh2YWx1ZSk7XHJcbn1cclxuXHJcbmRlY2xhcmUgZnVuY3Rpb24gcmVxdWlyZShtb2R1bGU6IHN0cmluZyk7XHJcblxyXG52YXIgcGVnID0gcmVxdWlyZShcIi4vZnNoYXJwLnBlZ1wiKTtcclxuXHJcbmZ1bmN0aW9uIGVtcHR5KGxpc3QpIHtcclxuICAgIHJldHVybiBsaXN0Lmxlbmd0aCA9PT0gMDtcclxufVxyXG5cclxuZnVuY3Rpb24gbm90KHZhbHVlKSB7XHJcbiAgICByZXR1cm4gIXZhbHVlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb3VudChsaXN0KSB7XHJcbiAgICByZXR1cm4gbGlzdC5sZW5ndGg7XHJcbn1cclxuXHJcbi8vIFJlU2hhcnBlciBkaXNhYmxlIEluY29uc2lzdGVudE5hbWluZ1xyXG52YXIgV0hFUkUgPSAxO1xyXG52YXIgUVVFUlkgPSAyO1xyXG52YXIgSURFTlQgPSAzO1xyXG52YXIgTUVNQkVSID0gNDtcclxudmFyIEFQUCA9IDU7XHJcbnZhciBTRUxFQ1QgPSA2O1xyXG52YXIgQ09OU1QgPSA3O1xyXG52YXIgUkFOR0UgPSA4O1xyXG52YXIgQklOQVJZID0gOTtcclxudmFyIEFXQUlUID0gMTA7XHJcbnZhciBQSVBFID0gMTE7XHJcbnZhciBDT01QT1NFID0gMTI7XHJcbnZhciBMQU1CREEgPSAxMztcclxuLy8gUmVTaGFycGVyIHJlc3RvcmUgSW5jb25zaXN0ZW50TmFtaW5nXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gYWNjZXB0KGFzdDogYW55LCB2aXNpdG9yOiBJQXN0VmlzaXRvciwgY29udGV4dCkge1xyXG4gICAgdmFyIGxlbmd0aDtcclxuICAgIHN3aXRjaCAoYXN0LnR5cGUpIHtcclxuICAgICAgICBjYXNlIElERU5UOlxyXG4gICAgICAgICAgICBzd2l0Y2ggKGFzdC5uYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwibnVsbFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcInRydWVcIjpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJmYWxzZVwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJub1wiOlxyXG4gICAgICAgICAgICAgICAgY2FzZSBcImVtcHR5XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5O1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImNvdW50XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvdW50O1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcIm5vdFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBub3Q7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLm1lbWJlcihjb250ZXh0LCBhc3QubmFtZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICBjYXNlIE1FTUJFUjpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3IubWVtYmVyKGFjY2VwdChhc3QudGFyZ2V0LCB2aXNpdG9yLCBjb250ZXh0KSwgYWNjZXB0KGFzdC5tZW1iZXIsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBjYXNlIENPTlNUOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5jb25zdChhc3QudmFsdWUpO1xyXG4gICAgICAgIGNhc2UgQklOQVJZOlxyXG4gICAgICAgICAgICB2YXIgc291cmNlO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGFzdC5vcCkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcIi0+XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgc291cmNlID0gYWNjZXB0KGFzdC5sZWZ0LCB2aXNpdG9yLCBjb250ZXh0KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gdm9pZCAwKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc291cmNlLnZhbHVlT2YoKSA/IGFjY2VwdChhc3QucmlnaHQsIHZpc2l0b3IsIGNvbnRleHQpIDogdm9pZCAwO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBXSEVSRTpcclxuICAgICAgICAgICAgICAgICAgICBzb3VyY2UgPSBhY2NlcHQoYXN0LmxlZnQsIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHZpc2l0b3IubWVtYmVyKHNvdXJjZSwgXCJsZW5ndGhcIikudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB2aXNpdG9yLm1lbWJlcihzb3VyY2UsIGkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSBuZXcgU2NvcGUodmlzaXRvciwgW2l0ZW0sIGNvbnRleHRdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSBhY2NlcHQoYXN0LnJpZ2h0LCB2aXNpdG9yLCBzY29wZSkudmFsdWVPZigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbGVmdCA9IGFjY2VwdChhc3QubGVmdCwgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJpZ2h0ID0gYWNjZXB0KGFzdC5yaWdodCwgdmlzaXRvciwgY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChsZWZ0ID09PSB2b2lkIDAgfHwgcmlnaHQgPT09IHZvaWQgMClcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3IuYXBwKGFzdC5vcCwgW3JpZ2h0LCBsZWZ0XSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgY2FzZSBBUFA6XHJcbiAgICAgICAgICAgIGxldCBhcmdzO1xyXG4gICAgICAgICAgICBsZW5ndGggPSBhc3QuYXJncy5sZW5ndGg7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBhcmcgPSBhY2NlcHQoYXN0LmFyZ3NbaV0sIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFyZyA9PT0gdm9pZCAwKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmc7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWFyZ3MpIGFyZ3MgPSBbYXJnXTtcclxuICAgICAgICAgICAgICAgIGVsc2UgYXJncy5wdXNoKGFyZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGZ1biA9IGFjY2VwdChhc3QuZnVuLCB2aXNpdG9yLCBjb250ZXh0KTtcclxuICAgICAgICAgICAgaWYgKGZ1biA9PT0gdm9pZCAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiY291bGQgbm90IHJlc29sdmUgZXhwcmVzc2lvbiwgXCIgKyBKU09OLnN0cmluZ2lmeShhc3QuZnVuKSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xyXG4gICAgICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLmFwcChmdW4sIGFyZ3MpO1xyXG4gICAgICAgIGNhc2UgUVVFUlk6XHJcbiAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLnF1ZXJ5KGFzdC5wYXJhbSwgYWNjZXB0KGFzdC5zb3VyY2UsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBjYXNlIFNFTEVDVDpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3Iuc2VsZWN0KGFjY2VwdChhc3Quc291cmNlLCB2aXNpdG9yLCBjb250ZXh0KSwgcyA9PiBhY2NlcHQoYXN0LnNlbGVjdG9yLCB2aXNpdG9yLCBzKSk7XHJcbiAgICAgICAgY2FzZSBXSEVSRTpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3Iud2hlcmUoYWNjZXB0KGFzdC5zb3VyY2UsIHZpc2l0b3IsIGNvbnRleHQpLCBhY2NlcHQoYXN0LnByZWRpY2F0ZSwgdmlzaXRvciwgY29udGV4dCkpO1xyXG4gICAgICAgIGNhc2UgUkFOR0U6XHJcbiAgICAgICAgICAgIHZhciBmaXJzdCA9IGFjY2VwdChhc3QuZnJvbSwgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgIHZhciBsYXN0ID0gYWNjZXB0KGFzdC50bywgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgIGlmIChmaXJzdCA9PT0gdm9pZCAwIHx8IGxhc3QgPT09IHZvaWQgMClcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaXJzdDtcclxuICAgICAgICAgICAgcmV0dXJuIG5ldyBSYW5nZShmaXJzdC52YWx1ZU9mKCksIGxhc3QudmFsdWVPZigpKTtcclxuICAgICAgICBjYXNlIEFXQUlUOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5hd2FpdChhY2NlcHQoYXN0LmV4cHIsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBjYXNlIExBTUJEQTpcclxuICAgICAgICAgICAgcmV0dXJuIG1vZGVsID0+IHtcclxuICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gdmlzaXRvci5leHRlbmQoYXN0LnBhcmFtLCBtb2RlbCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYWNjZXB0KGFzdC5ib2R5LCB2aXNpdG9yLCBjb250ZXh0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIHJldHVybiBhc3Q7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIFJhbmdlIHtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZmlyc3QsIHByaXZhdGUgbGFzdCkge1xyXG4gICAgfVxyXG5cclxuICAgIG1hcChmbikge1xyXG4gICAgICAgIHZhciByZXN1bHQgPSBbXSwgbGFzdCA9IHRoaXMubGFzdDtcclxuICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5maXJzdDsgaSA8PSBsYXN0OyBpKyspIHtcclxuICAgICAgICAgICAgcmVzdWx0LnB1c2goZm4oaSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgdmFyIGZzaGFycCA9IHBlZy5wYXJzZTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmcyhleHByKSB7XHJcbiAgICByZXR1cm4gbmV3IEV4cHJlc3Npb24ocGVnLnBhcnNlKGV4cHIpKTtcclxufVxyXG5cclxuY2xhc3MgRXhwcmVzc2lvbiB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFzdCkge1xyXG4gICAgfVxyXG4gICAgZXhlY3V0ZShiaW5kaW5nOiBJQXN0VmlzaXRvciwgY29udGV4dDogYW55KSB7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29udGV4dCkpXHJcbiAgICAgICAgICAgIHJldHVybiBhY2NlcHQodGhpcy5hc3QsIGJpbmRpbmcsIG5ldyBTY29wZShiaW5kaW5nLCBjb250ZXh0KSk7XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gYWNjZXB0KHRoaXMuYXN0LCBiaW5kaW5nLCBjb250ZXh0KTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFNjb3BlIHtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgdmlzaXRvcjogSUFzdFZpc2l0b3IsIHByaXZhdGUgY29udGV4dHM6IGFueVtdKSB7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0KG5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIHZhciB2aXNpdG9yID0gdGhpcy52aXNpdG9yO1xyXG4gICAgICAgIHZhciBjb250ZXh0cyA9IHRoaXMuY29udGV4dHM7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNvbnRleHRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZpc2l0b3IubWVtYmVyKGNvbnRleHRzW2ldLCBuYW1lKTtcclxuICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB2b2lkIDApXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdm9pZCAwO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgdmFyIFRPS0VOUyA9IHsgV0hFUkUsIFFVRVJZLCBJREVOVCwgTUVNQkVSLCBBUFAsIFNFTEVDVCwgQ09OU1QsIFJBTkdFLCBCSU5BUlksIEFXQUlULCBQSVBFLCBDT01QT1NFIH1cclxuIl19