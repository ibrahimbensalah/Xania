"use strict";
var peg = require("./fsharp.peg");
function empty(list) {
    return list.length === 0;
}
function not(value) {
    return !value;
}
function count(list) {
    return list.length;
}
var WHERE = 1;
var QUERY = 2;
var IDENT = 3;
var MEMBER = 4;
var APP = 5;
var SELECT = 6;
var CONST = 7;
var RANGE = 8;
var BINARY = 9;
var AWAIT = 10;
var PIPE = 11;
var COMPOSE = 12;
var LAMBDA = 13;
function accept(ast, visitor, context) {
    var length;
    switch (ast.type) {
        case IDENT:
            switch (ast.name) {
                case "null":
                    return null;
                case "true":
                    return true;
                case "false":
                    return false;
                case "no":
                case "empty":
                    return empty;
                case "count":
                    return count;
                case "not":
                    return not;
                default:
                    return visitor.member(context, ast.name);
            }
        case MEMBER:
            var target = accept(ast.target, visitor, context);
            var name = accept(ast.member, visitor, context);
            return visitor.member(target, name);
        case CONST:
            return visitor.const(ast.value);
        case BINARY:
            var source;
            switch (ast.op) {
                case "->":
                    source = accept(ast.left, visitor, context);
                    if (source === void 0)
                        return void 0;
                    return source.valueOf() ? accept(ast.right, visitor, context) : void 0;
                case WHERE:
                    source = accept(ast.left, visitor, context);
                    length = source.length;
                    var result = [];
                    for (var i = 0; i < length; i++) {
                        var item = visitor.member(source, i);
                        var scope = new Scope(visitor, [item, context]);
                        var b = accept(ast.right, visitor, scope).valueOf();
                        if (b)
                            result.push(item);
                    }
                    return result;
                default:
                    var left = accept(ast.left, visitor, context);
                    var right = accept(ast.right, visitor, context);
                    if (left === void 0 || right === void 0)
                        return void 0;
                    return visitor.app(ast.op, [right, left]);
            }
        case APP:
            var args = void 0;
            length = ast.args.length;
            for (var i_1 = 0; i_1 < length; i_1++) {
                var arg = accept(ast.args[i_1], visitor, context);
                if (arg === void 0)
                    return arg;
                if (!args)
                    args = [arg];
                else
                    args.push(arg);
            }
            var fun = accept(ast.fun, visitor, context);
            if (fun === void 0) {
                console.error("could not resolve expression, " + JSON.stringify(ast.fun));
                return void 0;
            }
            else
                return visitor.app(fun, args);
        case QUERY:
            return visitor.query(ast.param, accept(ast.source, visitor, context));
        case SELECT:
            return visitor.select(accept(ast.source, visitor, context), function (s) { return accept(ast.selector, visitor, s); });
        case WHERE:
            return visitor.where(accept(ast.source, visitor, context), accept(ast.predicate, visitor, context));
        case RANGE:
            var first = accept(ast.from, visitor, context);
            var last = accept(ast.to, visitor, context);
            if (first === void 0 || last === void 0)
                return void 0;
            return new Range(first.valueOf(), last.valueOf());
        case AWAIT:
            return visitor.await(accept(ast.expr, visitor, context));
        case LAMBDA:
            return function (model) {
                var context = visitor.extend(ast.param, model);
                return accept(ast.body, visitor, context);
            };
        default:
            return ast;
    }
}
exports.accept = accept;
var Range = (function () {
    function Range(first, last) {
        this.first = first;
        this.last = last;
    }
    Range.prototype.map = function (fn) {
        var result = [], last = this.last;
        for (var i = this.first; i <= last; i++) {
            result.push(fn(i));
        }
        return result;
    };
    return Range;
}());
exports.fsharp = peg.parse;
function fs(expr) {
    return new Expression(peg.parse(expr));
}
exports.fs = fs;
var Expression = (function () {
    function Expression(ast) {
        this.ast = ast;
    }
    Expression.prototype.execute = function (binding, context) {
        if (Array.isArray(context))
            return accept(this.ast, binding, new Scope(binding, context));
        else
            return accept(this.ast, binding, context);
    };
    return Expression;
}());
var Scope = (function () {
    function Scope(visitor, contexts) {
        this.visitor = visitor;
        this.contexts = contexts;
    }
    Scope.prototype.get = function (name) {
        var visitor = this.visitor;
        var contexts = this.contexts;
        for (var i = 0; i < this.contexts.length; i++) {
            var value = visitor.member(contexts[i], name);
            if (value !== void 0)
                return value;
        }
        return void 0;
    };
    return Scope;
}());
exports.Scope = Scope;
exports.TOKENS = { WHERE: WHERE, QUERY: QUERY, IDENT: IDENT, MEMBER: MEMBER, APP: APP, SELECT: SELECT, CONST: CONST, RANGE: RANGE, BINARY: BINARY, AWAIT: AWAIT, PIPE: PIPE, COMPOSE: COMPOSE };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnNoYXJwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZnNoYXJwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFhQSxJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFFbEMsZUFBZSxJQUFJO0lBQ2YsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDO0FBQzdCLENBQUM7QUFFRCxhQUFhLEtBQUs7SUFDZCxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDbEIsQ0FBQztBQUVELGVBQWUsSUFBSTtJQUNmLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO0FBQ3ZCLENBQUM7QUFHRCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFDZCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFDZCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFDZCxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7QUFDZixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7QUFDWixJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7QUFDZixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFDZCxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7QUFDZCxJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7QUFDZixJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7QUFDZixJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7QUFDZCxJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFDakIsSUFBSSxNQUFNLEdBQUcsRUFBRSxDQUFDO0FBR2hCLGdCQUF1QixHQUFRLEVBQUUsT0FBb0IsRUFBRSxPQUFPO0lBQzFELElBQUksTUFBTSxDQUFDO0lBQ1gsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDZixLQUFLLEtBQUs7WUFDTixNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFD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akIsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNyQixDQUFDO1FBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFDTCxZQUFDO0FBQUQsQ0FBQyxBQWZELElBZUM7QUFmWSxzQkFBSztBQWlCUCxRQUFBLE1BQU0sR0FBRyxFQUFFLEtBQUssT0FBQSxFQUFFLEtBQUssT0FBQSxFQUFFLEtBQUssT0FBQSxFQUFFLE1BQU0sUUFBQSxFQUFFLEdBQUcsS0FBQSxFQUFFLE1BQU0sUUFBQSxFQUFFLEtBQUssT0FBQSxFQUFFLEtBQUssT0FBQSxFQUFFLE1BQU0sUUFBQSxFQUFFLEtBQUssT0FBQSxFQUFFLElBQUksTUFBQSxFQUFFLE9BQU8sU0FBQSxFQUFFLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJleHBvcnQgaW50ZXJmYWNlIElBc3RWaXNpdG9yIHtcclxuICAgIHdoZXJlKHNvdXJjZSwgcHJlZGljYXRlKTtcclxuICAgIHNlbGVjdChzb3VyY2UsIHNlbGVjdG9yKTtcclxuICAgIHF1ZXJ5KHBhcmFtLCBzb3VyY2UpO1xyXG4gICAgbWVtYmVyKHRhcmdldCwgbmFtZSk7XHJcbiAgICBhcHAoZnVuLCBhcmdzOiBhbnlbXSk7XHJcbiAgICBleHRlbmQobmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KTtcclxuICAgIGF3YWl0KG9ic2VydmFibGUpO1xyXG4gICAgY29uc3QodmFsdWUpO1xyXG59XHJcblxyXG5kZWNsYXJlIGZ1bmN0aW9uIHJlcXVpcmUobW9kdWxlOiBzdHJpbmcpO1xyXG5cclxudmFyIHBlZyA9IHJlcXVpcmUoXCIuL2ZzaGFycC5wZWdcIik7XHJcblxyXG5mdW5jdGlvbiBlbXB0eShsaXN0KSB7XHJcbiAgICByZXR1cm4gbGlzdC5sZW5ndGggPT09IDA7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG5vdCh2YWx1ZSkge1xyXG4gICAgcmV0dXJuICF2YWx1ZTtcclxufVxyXG5cclxuZnVuY3Rpb24gY291bnQobGlzdCkge1xyXG4gICAgcmV0dXJuIGxpc3QubGVuZ3RoO1xyXG59XHJcblxyXG4vLyBSZVNoYXJwZXIgZGlzYWJsZSBJbmNvbnNpc3RlbnROYW1pbmdcclxudmFyIFdIRVJFID0gMTtcclxudmFyIFFVRVJZID0gMjtcclxudmFyIElERU5UID0gMztcclxudmFyIE1FTUJFUiA9IDQ7XHJcbnZhciBBUFAgPSA1O1xyXG52YXIgU0VMRUNUID0gNjtcclxudmFyIENPTlNUID0gNztcclxudmFyIFJBTkdFID0gODtcclxudmFyIEJJTkFSWSA9IDk7XHJcbnZhciBBV0FJVCA9IDEwO1xyXG52YXIgUElQRSA9IDExO1xyXG52YXIgQ09NUE9TRSA9IDEyO1xyXG52YXIgTEFNQkRBID0gMTM7XHJcbi8vIFJlU2hhcnBlciByZXN0b3JlIEluY29uc2lzdGVudE5hbWluZ1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFjY2VwdChhc3Q6IGFueSwgdmlzaXRvcjogSUFzdFZpc2l0b3IsIGNvbnRleHQpIHtcclxuICAgIHZhciBsZW5ndGg7XHJcbiAgICBzd2l0Y2ggKGFzdC50eXBlKSB7XHJcbiAgICAgICAgY2FzZSBJREVOVDpcclxuICAgICAgICAgICAgc3dpdGNoIChhc3QubmFtZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcIm51bGxcIjpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJ0cnVlXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiZmFsc2VcIjpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwibm9cIjpcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJlbXB0eVwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlbXB0eTtcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJjb3VudFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjb3VudDtcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJub3RcIjpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbm90O1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmlzaXRvci5tZW1iZXIoY29udGV4dCwgYXN0Lm5hbWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgY2FzZSBNRU1CRVI6XHJcbiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBhY2NlcHQoYXN0LnRhcmdldCwgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgIHZhciBuYW1lID0gYWNjZXB0KGFzdC5tZW1iZXIsIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5tZW1iZXIodGFyZ2V0LCBuYW1lKTtcclxuICAgICAgICBjYXNlIENPTlNUOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5jb25zdChhc3QudmFsdWUpO1xyXG4gICAgICAgIGNhc2UgQklOQVJZOlxyXG4gICAgICAgICAgICB2YXIgc291cmNlO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGFzdC5vcCkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcIi0+XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgc291cmNlID0gYWNjZXB0KGFzdC5sZWZ0LCB2aXNpdG9yLCBjb250ZXh0KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdXJjZSA9PT0gdm9pZCAwKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc291cmNlLnZhbHVlT2YoKSA/IGFjY2VwdChhc3QucmlnaHQsIHZpc2l0b3IsIGNvbnRleHQpIDogdm9pZCAwO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBXSEVSRTpcclxuICAgICAgICAgICAgICAgICAgICBzb3VyY2UgPSBhY2NlcHQoYXN0LmxlZnQsIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHNvdXJjZS5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSB2aXNpdG9yLm1lbWJlcihzb3VyY2UsIGkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2NvcGUgPSBuZXcgU2NvcGUodmlzaXRvciwgW2l0ZW0sIGNvbnRleHRdKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSBhY2NlcHQoYXN0LnJpZ2h0LCB2aXNpdG9yLCBzY29wZSkudmFsdWVPZigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbGVmdCA9IGFjY2VwdChhc3QubGVmdCwgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJpZ2h0ID0gYWNjZXB0KGFzdC5yaWdodCwgdmlzaXRvciwgY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChsZWZ0ID09PSB2b2lkIDAgfHwgcmlnaHQgPT09IHZvaWQgMClcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3IuYXBwKGFzdC5vcCwgW3JpZ2h0LCBsZWZ0XSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgY2FzZSBBUFA6XHJcbiAgICAgICAgICAgIGxldCBhcmdzO1xyXG4gICAgICAgICAgICBsZW5ndGggPSBhc3QuYXJncy5sZW5ndGg7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBhcmcgPSBhY2NlcHQoYXN0LmFyZ3NbaV0sIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFyZyA9PT0gdm9pZCAwKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmc7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWFyZ3MpIGFyZ3MgPSBbYXJnXTtcclxuICAgICAgICAgICAgICAgIGVsc2UgYXJncy5wdXNoKGFyZyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGZ1biA9IGFjY2VwdChhc3QuZnVuLCB2aXNpdG9yLCBjb250ZXh0KTtcclxuICAgICAgICAgICAgaWYgKGZ1biA9PT0gdm9pZCAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiY291bGQgbm90IHJlc29sdmUgZXhwcmVzc2lvbiwgXCIgKyBKU09OLnN0cmluZ2lmeShhc3QuZnVuKSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdm9pZCAwO1xyXG4gICAgICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLmFwcChmdW4sIGFyZ3MpO1xyXG4gICAgICAgIGNhc2UgUVVFUlk6XHJcbiAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLnF1ZXJ5KGFzdC5wYXJhbSwgYWNjZXB0KGFzdC5zb3VyY2UsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBjYXNlIFNFTEVDVDpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3Iuc2VsZWN0KGFjY2VwdChhc3Quc291cmNlLCB2aXNpdG9yLCBjb250ZXh0KSwgcyA9PiBhY2NlcHQoYXN0LnNlbGVjdG9yLCB2aXNpdG9yLCBzKSk7XHJcbiAgICAgICAgY2FzZSBXSEVSRTpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3Iud2hlcmUoYWNjZXB0KGFzdC5zb3VyY2UsIHZpc2l0b3IsIGNvbnRleHQpLCBhY2NlcHQoYXN0LnByZWRpY2F0ZSwgdmlzaXRvciwgY29udGV4dCkpO1xyXG4gICAgICAgIGNhc2UgUkFOR0U6XHJcbiAgICAgICAgICAgIHZhciBmaXJzdCA9IGFjY2VwdChhc3QuZnJvbSwgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgIHZhciBsYXN0ID0gYWNjZXB0KGFzdC50bywgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgIGlmIChmaXJzdCA9PT0gdm9pZCAwIHx8IGxhc3QgPT09IHZvaWQgMClcclxuICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUmFuZ2UoZmlyc3QudmFsdWVPZigpLCBsYXN0LnZhbHVlT2YoKSk7XHJcbiAgICAgICAgY2FzZSBBV0FJVDpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3IuYXdhaXQoYWNjZXB0KGFzdC5leHByLCB2aXNpdG9yLCBjb250ZXh0KSk7XHJcbiAgICAgICAgY2FzZSBMQU1CREE6XHJcbiAgICAgICAgICAgIHJldHVybiBtb2RlbCA9PiB7XHJcbiAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IHZpc2l0b3IuZXh0ZW5kKGFzdC5wYXJhbSwgbW9kZWwpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjY2VwdChhc3QuYm9keSwgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICByZXR1cm4gYXN0O1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBSYW5nZSB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZpcnN0LCBwcml2YXRlIGxhc3QpIHtcclxuICAgIH1cclxuXHJcbiAgICBtYXAoZm4pIHtcclxuICAgICAgICB2YXIgcmVzdWx0ID0gW10sIGxhc3QgPSB0aGlzLmxhc3Q7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IHRoaXMuZmlyc3Q7IGkgPD0gbGFzdDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKGZuKGkpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IHZhciBmc2hhcnAgPSBwZWcucGFyc2U7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZnMoZXhwcikge1xyXG4gICAgcmV0dXJuIG5ldyBFeHByZXNzaW9uKHBlZy5wYXJzZShleHByKSk7XHJcbn1cclxuXHJcbmNsYXNzIEV4cHJlc3Npb24ge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhc3QpIHtcclxuICAgIH1cclxuICAgIGV4ZWN1dGUoYmluZGluZzogSUFzdFZpc2l0b3IsIGNvbnRleHQ6IGFueSkge1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbnRleHQpKVxyXG4gICAgICAgICAgICByZXR1cm4gYWNjZXB0KHRoaXMuYXN0LCBiaW5kaW5nLCBuZXcgU2NvcGUoYmluZGluZywgY29udGV4dCkpO1xyXG4gICAgICAgIGVsc2VcclxuICAgICAgICAgICAgcmV0dXJuIGFjY2VwdCh0aGlzLmFzdCwgYmluZGluZywgY29udGV4dCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBTY29wZSB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHZpc2l0b3I6IElBc3RWaXNpdG9yLCBwcml2YXRlIGNvbnRleHRzOiBhbnlbXSkge1xyXG4gICAgfVxyXG5cclxuICAgIGdldChuYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICB2YXIgdmlzaXRvciA9IHRoaXMudmlzaXRvcjtcclxuICAgICAgICB2YXIgY29udGV4dHMgPSB0aGlzLmNvbnRleHRzO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jb250ZXh0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICB2YXIgdmFsdWUgPSB2aXNpdG9yLm1lbWJlcihjb250ZXh0c1tpXSwgbmFtZSk7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdm9pZCAwKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHZvaWQgMDtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IHZhciBUT0tFTlMgPSB7IFdIRVJFLCBRVUVSWSwgSURFTlQsIE1FTUJFUiwgQVBQLCBTRUxFQ1QsIENPTlNULCBSQU5HRSwgQklOQVJZLCBBV0FJVCwgUElQRSwgQ09NUE9TRSB9XHJcbiJdfQ==