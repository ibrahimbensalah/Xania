"use strict";
var peg = require("./fsharp.peg");
var WHERE = 1;
var QUERY = 2;
var IDENT = 3;
var MEMBER = 4;
var APP = 5;
var SELECT = 6;
var CONST = 7;
var RANGE = 8;
var BINARY = 9;
var AWAIT = 10;
var PIPE = 11;
var COMPOSE = 12;
function accept(ast, visitor, context) {
    switch (ast.type) {
        case IDENT:
            return visitor.member(context, ast.name);
        case MEMBER:
            return visitor.member(accept(ast.target, visitor, context), accept(ast.member, visitor, context));
        case CONST:
            return visitor.const(ast.value);
        case BINARY:
            var left = accept(ast.left, visitor, context);
            var right = accept(ast.right, visitor, context);
            if (left === void 0 || right === void 0)
                return undefined;
            return visitor.app(ast.op, [right, left]);
        case APP:
            var args = [];
            for (var i = 0; i < ast.args.length; i++) {
                var arg = accept(ast.args[i], visitor, context);
                if (arg === void 0)
                    return arg;
                args.push(arg);
            }
            return visitor.app(accept(ast.fun, visitor, context), args);
        case QUERY:
            return visitor.query(ast.param, accept(ast.source, visitor, context));
        case SELECT:
            return visitor.select(accept(ast.source, visitor, context), function (s) { return accept(ast.selector, visitor, s); });
        case WHERE:
            return visitor.where(accept(ast.source, visitor, context), accept(ast.predicate, visitor, context));
        case RANGE:
            var first = accept(ast.from, visitor, context);
            var last = accept(ast.to, visitor, context);
            if (first === void 0 || last === void 0)
                return first;
            return new Range(first.valueOf(), last.valueOf());
        case AWAIT:
            return visitor.await(accept(ast.expr, visitor, context));
        default:
            return ast;
    }
}
exports.accept = accept;
var Range = (function () {
    function Range(first, last) {
        this.first = first;
        this.last = last;
    }
    Range.prototype.map = function (fn) {
        var result = [], last = this.last;
        for (var i = this.first; i <= last; i++) {
            result.push(fn(i));
        }
        return result;
    };
    return Range;
}());
exports.fsharp = peg.parse;
function fs(expr) {
    return new Expression(peg.parse(expr));
}
exports.fs = fs;
var Expression = (function () {
    function Expression(ast) {
        this.ast = ast;
    }
    Expression.prototype.execute = function (binding, context) {
        return accept(this.ast, binding, context);
    };
    return Expression;
}());
exports.TYPES = { WHERE: WHERE, QUERY: QUERY, IDENT: IDENT, MEMBER: MEMBER, APP: APP, SELECT: SELECT, CONST: CONST, RANGE: RANGE, BINARY: BINARY, AWAIT: AWAIT, PIPE: PIPE, COMPOSE: COMPOSE };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnNoYXJwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2ZzaGFycC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBWUEsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0FBS2xDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztBQUNaLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztBQUNmLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUNkLElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQztBQUdqQixnQkFBdUIsR0FBUSxFQUFFLE9BQW9CLEVBQUUsT0FBTztJQUMxRCxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNmLEtBQUssS0FBSztZQUNOLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0MsS0FBSyxNQUFNO1lBQ1AsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBQyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3RHLEtBQUssS0FBSztZQUNOLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxD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RSxLQUFLLE9BQUEsRUFBRSxNQUFNLFFBQUEsRUFBRSxHQUFHLEtBQUEsRUFBRSxNQUFNLFFBQUEsRUFBRSxLQUFLLE9BQUEsRUFBRSxLQUFLLE9BQUEsRUFBRSxNQUFNLFFBQUEsRUFBRSxLQUFLLE9BQUEsRUFBRSxJQUFJLE1BQUEsRUFBRSxPQUFPLFNBQUEsRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGludGVyZmFjZSBJQXN0VmlzaXRvciB7XHJcbiAgICB3aGVyZShzb3VyY2UsIHByZWRpY2F0ZSk7XHJcbiAgICBzZWxlY3Qoc291cmNlLCBzZWxlY3Rvcik7XHJcbiAgICBxdWVyeShwYXJhbSwgc291cmNlKTtcclxuICAgIG1lbWJlcih0YXJnZXQsIG5hbWUpO1xyXG4gICAgYXBwKGZ1biwgYXJnczogYW55W10pO1xyXG4gICAgYXdhaXQob2JzZXJ2YWJsZSk7XHJcbiAgICBjb25zdCh2YWx1ZSk7XHJcbn1cclxuXHJcbmRlY2xhcmUgZnVuY3Rpb24gcmVxdWlyZShtb2R1bGU6IHN0cmluZyk7XHJcblxyXG52YXIgcGVnID0gcmVxdWlyZShcIi4vZnNoYXJwLnBlZ1wiKTtcclxuXHJcbi8vIHZhciBmc2hhcnAgPSBwZWcucGFyc2U7XHJcblxyXG4vLyBSZVNoYXJwZXIgZGlzYWJsZSBJbmNvbnNpc3RlbnROYW1pbmdcclxudmFyIFdIRVJFID0gMTtcclxudmFyIFFVRVJZID0gMjtcclxudmFyIElERU5UID0gMztcclxudmFyIE1FTUJFUiA9IDQ7XHJcbnZhciBBUFAgPSA1O1xyXG52YXIgU0VMRUNUID0gNjtcclxudmFyIENPTlNUID0gNztcclxudmFyIFJBTkdFID0gODtcclxudmFyIEJJTkFSWSA9IDk7XHJcbnZhciBBV0FJVCA9IDEwO1xyXG52YXIgUElQRSA9IDExO1xyXG52YXIgQ09NUE9TRSA9IDEyO1xyXG4vLyBSZVNoYXJwZXIgcmVzdG9yZSBJbmNvbnNpc3RlbnROYW1pbmdcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBhY2NlcHQoYXN0OiBhbnksIHZpc2l0b3I6IElBc3RWaXNpdG9yLCBjb250ZXh0KSB7XHJcbiAgICBzd2l0Y2ggKGFzdC50eXBlKSB7XHJcbiAgICAgICAgY2FzZSBJREVOVDpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3IubWVtYmVyKGNvbnRleHQsIGFzdC5uYW1lKTtcclxuICAgICAgICBjYXNlIE1FTUJFUjpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3IubWVtYmVyKGFjY2VwdChhc3QudGFyZ2V0LCB2aXNpdG9yLCBjb250ZXh0KSwgYWNjZXB0KGFzdC5tZW1iZXIsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBjYXNlIENPTlNUOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5jb25zdChhc3QudmFsdWUpO1xyXG4gICAgICAgIGNhc2UgQklOQVJZOlxyXG4gICAgICAgICAgICB2YXIgbGVmdCA9IGFjY2VwdChhc3QubGVmdCwgdmlzaXRvciwgY29udGV4dCk7XHJcbiAgICAgICAgICAgIHZhciByaWdodCA9IGFjY2VwdChhc3QucmlnaHQsIHZpc2l0b3IsIGNvbnRleHQpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGxlZnQgPT09IHZvaWQgMCB8fCByaWdodCA9PT0gdm9pZCAwKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLmFwcChhc3Qub3AsIFtyaWdodCwgbGVmdF0pO1xyXG4gICAgICAgIGNhc2UgQVBQOlxyXG4gICAgICAgICAgICBjb25zdCBhcmdzID0gW107XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXN0LmFyZ3MubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBhcmcgPSBhY2NlcHQoYXN0LmFyZ3NbaV0sIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFyZyA9PT0gdm9pZCAwKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhcmc7XHJcbiAgICAgICAgICAgICAgICBhcmdzLnB1c2goYXJnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5hcHAoYWNjZXB0KGFzdC5mdW4sIHZpc2l0b3IsIGNvbnRleHQpLCBhcmdzKTtcclxuICAgICAgICBjYXNlIFFVRVJZOlxyXG4gICAgICAgICAgICByZXR1cm4gdmlzaXRvci5xdWVyeShhc3QucGFyYW0sIGFjY2VwdChhc3Quc291cmNlLCB2aXNpdG9yLCBjb250ZXh0KSk7XHJcbiAgICAgICAgY2FzZSBTRUxFQ1Q6XHJcbiAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLnNlbGVjdChhY2NlcHQoYXN0LnNvdXJjZSwgdmlzaXRvciwgY29udGV4dCksIHMgPT4gYWNjZXB0KGFzdC5zZWxlY3RvciwgdmlzaXRvciwgcykpO1xyXG4gICAgICAgIGNhc2UgV0hFUkU6XHJcbiAgICAgICAgICAgIHJldHVybiB2aXNpdG9yLndoZXJlKGFjY2VwdChhc3Quc291cmNlLCB2aXNpdG9yLCBjb250ZXh0KSwgYWNjZXB0KGFzdC5wcmVkaWNhdGUsIHZpc2l0b3IsIGNvbnRleHQpKTtcclxuICAgICAgICBjYXNlIFJBTkdFOlxyXG4gICAgICAgICAgICB2YXIgZmlyc3QgPSBhY2NlcHQoYXN0LmZyb20sIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICB2YXIgbGFzdCA9IGFjY2VwdChhc3QudG8sIHZpc2l0b3IsIGNvbnRleHQpO1xyXG4gICAgICAgICAgICBpZiAoZmlyc3QgPT09IHZvaWQgMCB8fCBsYXN0ID09PSB2b2lkIDApXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmlyc3Q7XHJcbiAgICAgICAgICAgIC8vIFRPRE8gbGF6eSBpbXBsXHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgUmFuZ2UoZmlyc3QudmFsdWVPZigpLCBsYXN0LnZhbHVlT2YoKSk7XHJcbiAgICAgICAgY2FzZSBBV0FJVDpcclxuICAgICAgICAgICAgcmV0dXJuIHZpc2l0b3IuYXdhaXQoYWNjZXB0KGFzdC5leHByLCB2aXNpdG9yLCBjb250ZXh0KSk7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgcmV0dXJuIGFzdDtcclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgUmFuZ2Uge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBmaXJzdCwgcHJpdmF0ZSBsYXN0KSB7XHJcbiAgICB9XHJcblxyXG4gICAgbWFwKGZuKSB7XHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IFtdLCBsYXN0ID0gdGhpcy5sYXN0O1xyXG4gICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmZpcnN0OyBpIDw9IGxhc3Q7IGkrKykge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChmbihpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCB2YXIgZnNoYXJwID0gcGVnLnBhcnNlO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZzKGV4cHIpIHtcclxuICAgIHJldHVybiBuZXcgRXhwcmVzc2lvbihwZWcucGFyc2UoZXhwcikpO1xyXG59XHJcblxyXG5jbGFzcyBFeHByZXNzaW9uIHtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXN0KSB7XHJcbiAgICB9XHJcbiAgICBleGVjdXRlKGJpbmRpbmc6IElBc3RWaXNpdG9yLCBjb250ZXh0OiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gYWNjZXB0KHRoaXMuYXN0LCBiaW5kaW5nLCBjb250ZXh0KTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IHZhciBUWVBFUyA9IHsgV0hFUkUsIFFVRVJZLCBJREVOVCwgTUVNQkVSLCBBUFAsIFNFTEVDVCwgQ09OU1QsIFJBTkdFLCBCSU5BUlksIEFXQUlULCBQSVBFLCBDT01QT1NFIH1cclxuIl19