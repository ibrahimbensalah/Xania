"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var reactive_1 = require("./reactive");
var fsharp_1 = require("./fsharp");
var Dom;
(function (Dom) {
    var document = window.document;
    var ContentBinding = (function (_super) {
        __extends(ContentBinding, _super);
        function ContentBinding(ast, parentInsert, children) {
            var _this = _super.call(this) || this;
            _this.ast = ast;
            _this.parentInsert = parentInsert;
            _this.children = children;
            _this.fragments = [];
            return _this;
        }
        ContentBinding.prototype.render = function () {
            var stream = this.ast === null ? [this.context] : fsharp_1.accept(this.ast, this, this.context);
            var offset = 0;
            for (var i = 0; i < stream.length; i++) {
                var context = stream[i];
                var fragment = null;
                for (var e = i; e < this.fragments.length; e++) {
                    var f = this.fragments[e];
                    if (f.context === context) {
                        fragment = f;
                        if (e !== i) {
                            this.fragments.splice(e, 1);
                        }
                    }
                }
                if (fragment === null) {
                    fragment = new ContentFragment(this, context, offset);
                }
                if (i < this.fragments.length) {
                    this.fragments.splice(i, 0, fragment);
                }
                else {
                    this.fragments.push(fragment);
                }
                offset += this.children.length;
            }
            return stream;
        };
        ContentBinding.prototype.text = function (ast, options) {
            var binding = new TextBinding(ast);
            options.fragment.insert(binding.dom, options.child);
            return binding;
        };
        ContentBinding.prototype.content = function (ast, children, options) {
            var binding = new ContentBinding(ast, function (dom) { return options.fragment.insert(dom, options.child); }, children);
            return binding;
        };
        ContentBinding.prototype.tag = function (tagName, ns, attrs, events, options) {
            var tag = new TagBinding(tagName, ns);
            for (var i = 0; i < attrs.length; i++) {
                tag.attr(attrs[i].name, attrs[i].tpl);
            }
            options.fragment.insert(tag.dom, options.child);
            return tag;
        };
        return ContentBinding;
    }(reactive_1.Reactive.Binding));
    Dom.ContentBinding = ContentBinding;
    var ContentFragment = (function () {
        function ContentFragment(owner, context, offset) {
            this.owner = owner;
            this.context = context;
            this.offset = offset;
            this.bindings = [];
            for (var e = 0; e < owner.children.length; e++) {
                this.bindings[e] =
                    owner.children[e].accept(owner, { fragment: this, child: e }).update(context);
            }
        }
        ContentFragment.prototype.insert = function (dom, index) {
            this.owner.parentInsert(dom, this.offset + index);
        };
        return ContentFragment;
    }());
    var TextBinding = (function (_super) {
        __extends(TextBinding, _super);
        function TextBinding(expr) {
            var _this = _super.call(this) || this;
            _this.expr = expr;
            _this.dom = document.createTextNode("");
            return _this;
        }
        TextBinding.prototype.render = function () {
            var result = this.evaluate(fsharp_1.accept, this.expr);
            if (result === undefined) {
            }
            else {
                this.dom.textContent = result && result.valueOf();
            }
        };
        TextBinding.prototype.onNext = function (newValue) {
            this.execute();
        };
        return TextBinding;
    }(reactive_1.Reactive.Binding));
    Dom.TextBinding = TextBinding;
    var TagBinding = (function (_super) {
        __extends(TagBinding, _super);
        function TagBinding(tagName, ns) {
            if (ns === void 0) { ns = null; }
            var _this = _super.call(this) || this;
            _this.ns = ns;
            _this.attributeBindings = [];
            _this.childBindings = [];
            _this.events = {};
            _this.appendChild = function (dom) { return _this.dom.appendChild(dom); };
            _this.classBinding = new ClassBinding(_this);
            if (ns === null)
                _this.dom = document.createElement(tagName);
            else {
                _this.dom = document.createElementNS(ns, tagName.toLowerCase());
            }
            _this.dom.attributes["__binding"] = _this;
            return _this;
        }
        TagBinding.prototype.attr = function (name, ast) {
            if (name === "class") {
                this.classBinding.setBaseClass(ast);
            }
            else if (name.startsWith("class.")) {
                this.classBinding.addClass(name.substr(6), ast);
            }
            else {
                var attrBinding = new AttributeBinding(this, name, ast);
                this.attributeBindings.push(attrBinding);
            }
            return this;
        };
        TagBinding.prototype.on = function (name, ast) {
            this.events[name] = ast;
            return this;
        };
        TagBinding.prototype.text = function (ast) {
            var binding = new TextBinding(ast);
            this.childBindings.push(binding);
            if (!!this.context)
                binding.update(this.context);
            this.appendChild(binding.dom);
            return binding;
        };
        TagBinding.prototype.content = function (ast, children) {
            var binding = new ContentBinding(ast, this.appendChild, children).update(this.context);
            this.childBindings.push(binding);
            return binding;
        };
        TagBinding.prototype.tag = function (tagName, ns, attrs, events, options) {
            var tag = new TagBinding(tagName, ns);
            this.childBindings.push(tag);
            for (var i = 0; i < attrs.length; i++) {
                tag.attr(attrs[i].name, attrs[i].tpl);
            }
            this.appendChild(tag.dom);
            return tag;
        };
        TagBinding.prototype.update = function (context) {
            _super.prototype.update.call(this, context);
            this.classBinding.update(context);
            for (var e = 0; e < this.attributeBindings.length; e++) {
                this.attributeBindings[e].update(context);
            }
            for (var i = 0; i < this.childBindings.length; i++) {
                this.childBindings[i].update(context);
            }
            return this;
        };
        TagBinding.prototype.render = function (context) {
            return this.dom;
        };
        TagBinding.prototype.trigger = function (name) {
            var handler = this.events[name];
            if (!!handler) {
                var result = fsharp_1.accept(handler, this, this.context);
                if (typeof result === "function")
                    result();
            }
        };
        return TagBinding;
    }(reactive_1.Reactive.Binding));
    Dom.TagBinding = TagBinding;
    var ClassBinding = (function (_super) {
        __extends(ClassBinding, _super);
        function ClassBinding(parent) {
            var _this = _super.call(this) || this;
            _this.parent = parent;
            _this.conditions = [];
            return _this;
        }
        ClassBinding.prototype.setBaseClass = function (tpl) {
            this.baseClassTpl = tpl;
        };
        ClassBinding.prototype.addClass = function (className, condition) {
            this.conditions.push({ className: className, condition: condition });
        };
        ClassBinding.prototype.render = function (context) {
            this.context = context;
            var classes = [];
            if (!!this.baseClassTpl) {
                var value = fsharp_1.accept(this.baseClassTpl, this, context).valueOf();
                classes.push(value);
            }
            for (var i = 0; i < this.conditions.length; i++) {
                var _a = this.conditions[i], className = _a.className, condition = _a.condition;
                if (!!fsharp_1.accept(condition, this, context).valueOf()) {
                    classes.push(className);
                }
            }
            this.setAttribute("class", classes.length > 0 ? join(" ", classes) : null);
        };
        ClassBinding.prototype.setAttribute = function (attrName, newValue) {
            var oldValue = this.oldValue;
            var tag = this.parent.dom;
            if (typeof newValue === "undefined" || newValue === null) {
                tag[attrName] = void 0;
                tag.removeAttribute(attrName);
            }
            else {
                if (typeof oldValue === "undefined") {
                    var attr = document.createAttribute(attrName);
                    attr.value = newValue;
                    tag.setAttributeNode(attr);
                }
                else {
                    tag.className = newValue;
                }
            }
            this.oldValue = newValue;
        };
        return ClassBinding;
    }(reactive_1.Reactive.Binding));
    Dom.ClassBinding = ClassBinding;
    var AttributeBinding = (function (_super) {
        __extends(AttributeBinding, _super);
        function AttributeBinding(parent, name, expr) {
            var _this = _super.call(this) || this;
            _this.parent = parent;
            _this.name = name;
            _this.expr = expr;
            return _this;
        }
        AttributeBinding.prototype.onNext = function () {
            this.execute();
        };
        AttributeBinding.prototype.render = function () {
            var value = this.evaluate(fsharp_1.accept, this.expr);
            if (value !== null && value !== void 0 && !!value.valueOf)
                value = value.valueOf();
            var newValue;
            if (this.name === "checked") {
                newValue = !!value ? "checked" : null;
            }
            else {
                newValue = value;
            }
            var oldValue = this.oldValue;
            var attrName = this.name;
            var tag = this.parent.dom;
            if (typeof newValue === "undefined" || newValue === null) {
                tag[attrName] = void 0;
                tag.removeAttribute(attrName);
            }
            else {
                if (typeof oldValue === "undefined") {
                    var attr = document.createAttribute(attrName);
                    attr.value = newValue;
                    tag.setAttributeNode(attr);
                }
                else {
                    tag.setAttribute(attrName, newValue);
                }
            }
            this.oldValue = newValue;
        };
        return AttributeBinding;
    }(reactive_1.Reactive.Binding));
    Dom.AttributeBinding = AttributeBinding;
})(Dom = exports.Dom || (exports.Dom = {}));
function join(separator, value) {
    if (Array.isArray(value)) {
        return value.length > 0 ? value.sort().join(separator) : null;
    }
    return value;
}
exports.join = join;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2RvbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSx1Q0FBMkM7QUFDM0MsbUNBQWlDO0FBR2pDLElBQWMsR0FBRyxDQW1rQmhCO0FBbmtCRCxXQUFjLEdBQUc7SUFFYixJQUFJLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0lBSy9CO1FBQW9DLGtDQUFVO1FBRzFDLHdCQUFvQixHQUFHLEVBQVMsWUFBNEMsRUFBUyxRQUEwQjtZQUEvRyxZQUNJLGlCQUFPLFNBQ1Y7WUFGbUIsU0FBRyxHQUFILEdBQUcsQ0FBQTtZQUFTLGtCQUFZLEdBQVosWUFBWSxDQUFnQztZQUFTLGNBQVEsR0FBUixRQUFRLENBQWtCO1lBRnZHLGVBQVMsR0FBc0IsRUFBRSxDQUFDOztRQUkxQyxDQUFDO1FBRUQsK0JBQU0sR0FBTjtZQUNJLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLEtBQUssSUFBSSxHQUFHLENBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBRSxHQUFHLGVBQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFekYsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2YsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3JDLElBQUksT0FBTyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFeEIsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDO2dCQUNwQixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7b0JBQzdDLElBQUksQ0FBQyxH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LENBQUMsQ0FBQztvQkFDbEMsSUFBSSxJQUFJLEdBQUcsUUFBUSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDOUMsSUFBSSxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUM7b0JBQ3RCLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDL0IsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFFSixHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDekMsQ0FBQztZQUNMLENBQUM7WUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUM3QixDQUFDO1FBQ0wsdUJBQUM7SUFBRCxDQUFDLEFBNUNELENBQXNDLG1CQUFFLENBQUMsT0FBTyxHQTRDL0M7SUE1Q1ksb0JBQWdCLG1CQTRDNUIsQ0FBQTtBQXFRTCxDQUFDLEVBbmtCYSxHQUFHLEdBQUgsV0FBRyxLQUFILFdBQUcsUUFta0JoQjtBQUVELGNBQXFCLFNBQWlCLEVBQUUsS0FBSztJQUN6QyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2QixNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDbEUsQ0FBQztJQUNELE1BQU0sQ0FBQyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQUxELG9CQUtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29yZSB9IGZyb20gJy4vY29yZSdcclxuaW1wb3J0IHsgUmVhY3RpdmUgYXMgUmUgfSBmcm9tICcuL3JlYWN0aXZlJ1xyXG5pbXBvcnQgeyBhY2NlcHQgfSBmcm9tICcuL2ZzaGFycCdcclxuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuL3RlbXBsYXRlJ1xyXG5cclxuZXhwb3J0IG1vZHVsZSBEb20ge1xyXG5cclxuICAgIHZhciBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDtcclxuXHJcbiAgICBpbnRlcmZhY2UgSVZpc2l0b3IgZXh0ZW5kcyBUZW1wbGF0ZS5JVmlzaXRvcjxSZS5CaW5kaW5nPiB7XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGNsYXNzIENvbnRlbnRCaW5kaW5nIGV4dGVuZHMgUmUuQmluZGluZyBpbXBsZW1lbnRzIElWaXNpdG9yIHtcclxuICAgICAgICBwcml2YXRlIGZyYWdtZW50czogQ29udGVudEZyYWdtZW50W10gPSBbXTtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSBhc3QsIHB1YmxpYyBwYXJlbnRJbnNlcnQ6IChuOiBOb2RlLCBpZHg6IG51bWJlcikgPT4gdm9pZCwgcHVibGljIGNoaWxkcmVuOiBUZW1wbGF0ZS5JTm9kZVtdKSB7XHJcbiAgICAgICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZW5kZXIoKSB7XHJcbiAgICAgICAgICAgIHZhciBzdHJlYW0gPSB0aGlzLmFzdCA9PT0gbnVsbCA/IFsgdGhpcy5jb250ZXh0IF0gOiBhY2NlcHQodGhpcy5hc3QsIHRoaXMsIHRoaXMuY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICB2YXIgb2Zmc2V0ID0gMDtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHJlYW0ubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gc3RyZWFtW2ldO1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciBmcmFnbWVudCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBlID0gaTsgZSA8IHRoaXMuZnJhZ21lbnRzLmxlbmd0aDsgZSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGYgPSB0aGlzLmZyYWdtZW50c1tlXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZi5jb250ZXh0ID09PSBjb250ZXh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gZjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUgIT09IGkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIGZvdW5kIGZyYWdtZW50IGF0IGUgYnkgc2hvdWxkIGJlIGxvY2F0ZWQgYXQgaSAqL1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFnbWVudHMuc3BsaWNlKGUsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChmcmFnbWVudCA9PT0gbnVsbCAvKiBub3QgZm91bmQgKi8pIHtcclxuICAgICAgICAgICAgICAgICAgICBmcmFnbWVudCA9IG5ldyBDb250ZW50RnJhZ21lbnQodGhpcywgY29udGV4dCwgb2Zmc2V0KTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoaSA8IHRoaXMuZnJhZ21lbnRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZnJhZ21lbnRzLnNwbGljZShpLCAwLCBmcmFnbWVudCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZnJhZ21lbnRzLnB1c2goZnJhZ21lbnQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIG9mZnNldCArPSB0aGlzLmNoaWxkcmVuLmxlbmd0aDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHN0cmVhbTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyB0ZXh0KGFzdCwgb3B0aW9uczogeyBmcmFnbWVudDogQ29udGVudEZyYWdtZW50LCBjaGlsZDogbnVtYmVyIH0pOiBUZXh0QmluZGluZyB7XHJcbiAgICAgICAgICAgIHZhciBiaW5kaW5nID0gbmV3IFRleHRCaW5kaW5nKGFzdCk7XHJcbiAgICAgICAgICAgIG9wdGlvbnMuZnJhZ21lbnQuaW5zZXJ0KGJpbmRpbmcuZG9tLCBvcHRpb25zLmNoaWxkKTtcclxuICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgY29udGVudChhc3QsIGNoaWxkcmVuLCBvcHRpb25zOiB7IGZyYWdtZW50OiBDb250ZW50RnJhZ21lbnQsIGNoaWxkOiBudW1iZXIgfSk6IENvbnRlbnRCaW5kaW5nIHtcclxuICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBuZXcgQ29udGVudEJpbmRpbmcoYXN0LCBkb20gPT4gb3B0aW9ucy5mcmFnbWVudC5pbnNlcnQoZG9tLCBvcHRpb25zLmNoaWxkKSwgY2hpbGRyZW4pO1xyXG4gICAgICAgICAgICByZXR1cm4gYmluZGluZztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyB0YWcodGFnTmFtZTogc3RyaW5nLCBuczogc3RyaW5nLCBhdHRycywgZXZlbnRzLCBvcHRpb25zOiBhbnkpIDogVGFnQmluZGluZyB7XHJcbiAgICAgICAgICAgIHZhciB0YWcgPSBuZXcgVGFnQmluZGluZyh0YWdOYW1lLCBucyk7XHJcblxyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGF0dHJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0YWcuYXR0cihhdHRyc1tpXS5uYW1lLCBhdHRyc1tpXS50cGwpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBvcHRpb25zLmZyYWdtZW50Lmluc2VydCh0YWcuZG9tLCBvcHRpb25zLmNoaWxkKTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0YWc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNsYXNzIENvbnRlbnRGcmFnbWVudCB7XHJcbiAgICAgICAgcHVibGljIGJpbmRpbmdzOiBSZS5CaW5kaW5nW10gPSBbXTtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSBvd25lcjogQ29udGVudEJpbmRpbmcsIHB1YmxpYyBjb250ZXh0LCBwcml2YXRlIG9mZnNldDogbnVtYmVyKSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGUgPSAwOyBlIDwgb3duZXIuY2hpbGRyZW4ubGVuZ3RoOyBlKyspIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYmluZGluZ3NbZV0gPVxyXG4gICAgICAgICAgICAgICAgICAgIG93bmVyLmNoaWxkcmVuW2VdLmFjY2VwdChvd25lciBhcyBJVmlzaXRvciwgeyBmcmFnbWVudDogdGhpcywgY2hpbGQ6IGUgfSkudXBkYXRlKGNvbnRleHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpbnNlcnQoZG9tLCBpbmRleCkge1xyXG4gICAgICAgICAgICB0aGlzLm93bmVyLnBhcmVudEluc2VydChkb20sIHRoaXMub2Zmc2V0ICsgaW5kZXgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgY2xhc3MgVGV4dEJpbmRpbmcgZXh0ZW5kcyBSZS5CaW5kaW5nIHtcclxuICAgICAgICBwdWJsaWMgZG9tO1xyXG5cclxuICAgICAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGV4cHIpIHtcclxuICAgICAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICAgICAgdGhpcy5kb20gPSAoPGFueT5kb2N1bWVudCkuY3JlYXRlVGV4dE5vZGUoXCJcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZW5kZXIoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZXZhbHVhdGUoYWNjZXB0LCB0aGlzLmV4cHIpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAvLyB0aGlzLmRvbS5kZXRhY2goKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tLnRleHRDb250ZW50ID0gcmVzdWx0ICYmIHJlc3VsdC52YWx1ZU9mKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG9uTmV4dChuZXdWYWx1ZSkge1xyXG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGNsYXNzIFRhZ0JpbmRpbmcgZXh0ZW5kcyBSZS5CaW5kaW5nIGltcGxlbWVudHMgSVZpc2l0b3Ige1xyXG4gICAgICAgIHB1YmxpYyBkb207XHJcbiAgICAgICAgcHJpdmF0ZSBhdHRyaWJ1dGVCaW5kaW5ncyA9IFtdO1xyXG4gICAgICAgIHByaXZhdGUgY2hpbGRCaW5kaW5nczogUmUuQmluZGluZ1tdID0gW107XHJcbiAgICAgICAgcHJpdmF0ZSBldmVudHMgPSB7fTtcclxuICAgICAgICBwcml2YXRlIGFwcGVuZENoaWxkID0gZG9tID0+IHRoaXMuZG9tLmFwcGVuZENoaWxkKGRvbSk7XHJcbiAgICAgICAgcHJpdmF0ZSBjbGFzc0JpbmRpbmcgPSBuZXcgQ2xhc3NCaW5kaW5nKHRoaXMpO1xyXG5cclxuICAgICAgICBjb25zdHJ1Y3Rvcih0YWdOYW1lOiBzdHJpbmcsIHByaXZhdGUgbnM6IHN0cmluZyA9IG51bGwpIHtcclxuICAgICAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICAgICAgaWYgKG5zID09PSBudWxsKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5kb20gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpO1xyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tID0gKDxhbnk+ZG9jdW1lbnQpLmNyZWF0ZUVsZW1lbnROUyhucywgdGFnTmFtZS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5kb20uYXR0cmlidXRlc1tcIl9fYmluZGluZ1wiXSA9IHRoaXM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBhdHRyKG5hbWUsIGFzdCk6IHRoaXMge1xyXG4gICAgICAgICAgICBpZiAobmFtZSA9PT0gXCJjbGFzc1wiKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsYXNzQmluZGluZy5zZXRCYXNlQ2xhc3MoYXN0KTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lLnN0YXJ0c1dpdGgoXCJjbGFzcy5cIikpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xhc3NCaW5kaW5nLmFkZENsYXNzKG5hbWUuc3Vic3RyKDYpLCBhc3QpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGF0dHJCaW5kaW5nID0gbmV3IEF0dHJpYnV0ZUJpbmRpbmcodGhpcywgbmFtZSwgYXN0KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlQmluZGluZ3MucHVzaChhdHRyQmluZGluZyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9jaGlsZChjaGlsZDogUmUuQmluZGluZyk6IHRoaXMge1xyXG4gICAgICAgIC8vICAgIGlmICghIXRoaXMuY29udGV4dClcclxuICAgICAgICAvLyAgICAgICAgY2hpbGQudXBkYXRlKHRoaXMuY29udGV4dCk7XHJcblxyXG4gICAgICAgIC8vICAgIHRoaXMuY2hpbGRCaW5kaW5ncy5wdXNoKGNoaWxkKTtcclxuICAgICAgICAvLyAgICB0aGlzLmFwcGVuZENoaWxkKGNoaWxkLmRvbSk7XHJcbiAgICAgICAgLy8gICAgcmV0dXJuIHRoaXM7XHJcbiAgICAgICAgLy99XHJcblxyXG4gICAgICAgIG9uKG5hbWUsIGFzdCkgOiB0aGlzIHtcclxuICAgICAgICAgICAgdGhpcy5ldmVudHNbbmFtZV0gPSBhc3Q7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyB0ZXh0KGFzdCk6IFRleHRCaW5kaW5nIHtcclxuICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBuZXcgVGV4dEJpbmRpbmcoYXN0KTtcclxuICAgICAgICAgICAgdGhpcy5jaGlsZEJpbmRpbmdzLnB1c2goYmluZGluZyk7XHJcblxyXG4gICAgICAgICAgICBpZiAoISF0aGlzLmNvbnRleHQpXHJcbiAgICAgICAgICAgICAgICBiaW5kaW5nLnVwZGF0ZSh0aGlzLmNvbnRleHQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5hcHBlbmRDaGlsZChiaW5kaW5nLmRvbSk7XHJcbiAgICAgICAgICAgIHJldHVybiBiaW5kaW5nO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIGNvbnRlbnQoYXN0LCBjaGlsZHJlbjogVGVtcGxhdGUuSU5vZGVbXSk6IENvbnRlbnRCaW5kaW5nIHtcclxuICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBuZXcgQ29udGVudEJpbmRpbmcoYXN0LCB0aGlzLmFwcGVuZENoaWxkLCBjaGlsZHJlbikudXBkYXRlKHRoaXMuY29udGV4dCk7XHJcbiAgICAgICAgICAgIHRoaXMuY2hpbGRCaW5kaW5ncy5wdXNoKGJpbmRpbmcpO1xyXG4gICAgICAgICAgICByZXR1cm4gYmluZGluZztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyB0YWcodGFnTmFtZTogc3RyaW5nLCBuczogc3RyaW5nLCBhdHRycywgZXZlbnRzLCBvcHRpb25zOiBhbnkpOiBUYWdCaW5kaW5nIHtcclxuICAgICAgICAgICAgdmFyIHRhZyA9IG5ldyBUYWdCaW5kaW5nKHRhZ05hbWUsIG5zKTtcclxuICAgICAgICAgICAgdGhpcy5jaGlsZEJpbmRpbmdzLnB1c2godGFnKTtcclxuXHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXR0cnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHRhZy5hdHRyKGF0dHJzW2ldLm5hbWUsIGF0dHJzW2ldLnRwbCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuYXBwZW5kQ2hpbGQodGFnLmRvbSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0YWc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB1cGRhdGUoY29udGV4dCk6IHRoaXMge1xyXG4gICAgICAgICAgICBzdXBlci51cGRhdGUoY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNsYXNzQmluZGluZy51cGRhdGUoY29udGV4dCk7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGUgPSAwOyBlIDwgdGhpcy5hdHRyaWJ1dGVCaW5kaW5ncy5sZW5ndGg7IGUrKykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGVCaW5kaW5nc1tlXS51cGRhdGUoY29udGV4dCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZEJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkQmluZGluZ3NbaV0udXBkYXRlKGNvbnRleHQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlbmRlcihjb250ZXh0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRvbTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRyaWdnZXIobmFtZSkge1xyXG4gICAgICAgICAgICB2YXIgaGFuZGxlciA9IHRoaXMuZXZlbnRzW25hbWVdO1xyXG4gICAgICAgICAgICBpZiAoISFoYW5kbGVyKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gYWNjZXB0KGhhbmRsZXIsIHRoaXMsIHRoaXMuY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXN1bHQgPT09IFwiZnVuY3Rpb25cIilcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgY2xhc3MgQ2xhc3NCaW5kaW5nIGV4dGVuZHMgUmUuQmluZGluZyB7XHJcbiAgICAgICAgcHVibGljIGRvbTtcclxuICAgICAgICBwcml2YXRlIGNvbmRpdGlvbnMgPSBbXTtcclxuICAgICAgICBwcml2YXRlIG9sZFZhbHVlO1xyXG4gICAgICAgIHByaXZhdGUgYmFzZUNsYXNzVHBsO1xyXG5cclxuICAgICAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBhcmVudDogVGFnQmluZGluZykge1xyXG4gICAgICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgc2V0QmFzZUNsYXNzKHRwbCkge1xyXG4gICAgICAgICAgICB0aGlzLmJhc2VDbGFzc1RwbCA9IHRwbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGFkZENsYXNzKGNsYXNzTmFtZSwgY29uZGl0aW9uKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29uZGl0aW9ucy5wdXNoKHsgY2xhc3NOYW1lLCBjb25kaXRpb24gfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZW5kZXIoY29udGV4dCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xyXG4gICAgICAgICAgICBjb25zdCBjbGFzc2VzID0gW107XHJcbiAgICAgICAgICAgIGlmICghIXRoaXMuYmFzZUNsYXNzVHBsKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBhY2NlcHQodGhpcy5iYXNlQ2xhc3NUcGwsIHRoaXMsIGNvbnRleHQpLnZhbHVlT2YoKTtcclxuICAgICAgICAgICAgICAgIGNsYXNzZXMucHVzaCh2YWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jb25kaXRpb25zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgeyBjbGFzc05hbWUsIGNvbmRpdGlvbiB9ID0gdGhpcy5jb25kaXRpb25zW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYgKCEhYWNjZXB0KGNvbmRpdGlvbiwgdGhpcywgY29udGV4dCkudmFsdWVPZigpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKGNsYXNzTmFtZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKFwiY2xhc3NcIiwgY2xhc3Nlcy5sZW5ndGggPiAwID8gam9pbihcIiBcIiwgY2xhc3NlcykgOiBudWxsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHB1YmxpYyBzZXRBdHRyaWJ1dGUoYXR0ck5hbWU6IHN0cmluZywgbmV3VmFsdWUpIHtcclxuICAgICAgICAgICAgdmFyIG9sZFZhbHVlID0gdGhpcy5vbGRWYWx1ZTtcclxuXHJcbiAgICAgICAgICAgIHZhciB0YWcgPSB0aGlzLnBhcmVudC5kb207XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VmFsdWUgPT09IFwidW5kZWZpbmVkXCIgfHwgbmV3VmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHRhZ1thdHRyTmFtZV0gPSB2b2lkIDA7XHJcbiAgICAgICAgICAgICAgICB0YWcucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2xkVmFsdWUgPT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ciA9IGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZShhdHRyTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYXR0ci52YWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHRhZy5zZXRBdHRyaWJ1dGVOb2RlKGF0dHIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0YWcuY2xhc3NOYW1lID0gbmV3VmFsdWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5vbGRWYWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGNsYXNzIEF0dHJpYnV0ZUJpbmRpbmcgZXh0ZW5kcyBSZS5CaW5kaW5nIHtcclxuICAgICAgICBwdWJsaWMgZG9tO1xyXG4gICAgICAgIHByaXZhdGUgb2xkVmFsdWU7XHJcblxyXG4gICAgICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcGFyZW50OiBUYWdCaW5kaW5nLCBwcml2YXRlIG5hbWUsIHByaXZhdGUgZXhwcikge1xyXG4gICAgICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgb25OZXh0KCkge1xyXG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGUoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlbmRlcigpIHtcclxuICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5ldmFsdWF0ZShhY2NlcHQsIHRoaXMuZXhwcik7XHJcblxyXG4gICAgICAgICAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHZvaWQgMCAmJiAhIXZhbHVlLnZhbHVlT2YpXHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnZhbHVlT2YoKTtcclxuXHJcbiAgICAgICAgICAgIHZhciBuZXdWYWx1ZTtcclxuICAgICAgICAgICAgaWYgKHRoaXMubmFtZSA9PT0gXCJjaGVja2VkXCIpIHtcclxuICAgICAgICAgICAgICAgIG5ld1ZhbHVlID0gISF2YWx1ZSA/IFwiY2hlY2tlZFwiIDogbnVsbDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG5ld1ZhbHVlID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMub2xkVmFsdWU7XHJcblxyXG4gICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSB0aGlzLm5hbWU7XHJcbiAgICAgICAgICAgIHZhciB0YWcgPSB0aGlzLnBhcmVudC5kb207XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VmFsdWUgPT09IFwidW5kZWZpbmVkXCIgfHwgbmV3VmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHRhZ1thdHRyTmFtZV0gPSB2b2lkIDA7XHJcbiAgICAgICAgICAgICAgICB0YWcucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2xkVmFsdWUgPT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ciA9IGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZShhdHRyTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYXR0ci52YWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHRhZy5zZXRBdHRyaWJ1dGVOb2RlKGF0dHIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyB0YWdbYXR0ck5hbWVdID0gbmV3VmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFnLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgbmV3VmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMub2xkVmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy9jbGFzcyBSZWFjdGl2ZUJpbmRpbmcgZXh0ZW5kcyBEb21CaW5kaW5nIHtcclxuICAgIC8vICAgIHByaXZhdGUgYmluZGluZ3MgPSBbXTtcclxuICAgIC8vICAgIHByaXZhdGUgc3RyZWFtO1xyXG4gICAgLy8gICAgcHJpdmF0ZSBsZW5ndGg7XHJcblxyXG4gICAgLy8gICAgY29uc3RydWN0b3IocHJpdmF0ZSB0cGw6IFRlbXBsYXRlLklOb2RlLCBwcml2YXRlIHRhcmdldCwgcHJpdmF0ZSBvZmZzZXQpIHtcclxuICAgIC8vICAgICAgICBzdXBlcigpO1xyXG4gICAgLy8gICAgfVxyXG5cclxuICAgIC8vICAgIHJlbmRlcihjb250ZXh0KSB7XHJcbiAgICAvLyAgICAgICAgdmFyIHsgYmluZGluZ3MsIHRhcmdldCwgdHBsIH0gPSB0aGlzO1xyXG4gICAgLy8gICAgICAgIGlmICghIXRwbC5tb2RlbEFjY2Vzc29yKSB7XHJcbiAgICAvLyAgICAgICAgICAgIHZhciBzdHJlYW0gPSB0cGwubW9kZWxBY2Nlc3Nvci5leGVjdXRlKGNvbnRleHQsIHRoaXMpO1xyXG4gICAgLy8gICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDA7XHJcblxyXG4gICAgLy8gICAgICAgICAgICBzdHJlYW0uZm9yRWFjaCgoY3R4LCBpZHgpID0+IHtcclxuICAgIC8vICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gaWR4ICsgMTtcclxuICAgIC8vICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYmluZGluZ3MubGVuZ3RoOyBpKyspIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICB2YXIgYmluZGluZyA9IGJpbmRpbmdzW2ldO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIGlmIChiaW5kaW5nLmNvbnRleHQudmFsdWUgPT09IGN0eC52YWx1ZSkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSAhPT0gaWR4KSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nc1tpXSA9IGJpbmRpbmdzW2lkeF07XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaW5kaW5nc1tpZHhdID0gYmluZGluZztcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgICAgdGhpcy5leGVjdXRlKGN0eCwgaWR4KTtcclxuICAgIC8vICAgICAgICAgICAgfSk7XHJcbiAgICAvLyAgICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgdGhpcy5leGVjdXRlKGNvbnRleHQsIDApO1xyXG4gICAgLy8gICAgICAgICAgICB0aGlzLmxlbmd0aCA9IDE7XHJcbiAgICAvLyAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICB3aGlsZSAoYmluZGluZ3MubGVuZ3RoID4gdGhpcy5sZW5ndGgpIHtcclxuICAgIC8vICAgICAgICAgICAgY29uc3Qgb2xkQmluZGluZyA9IGJpbmRpbmdzLnBvcCgpO1xyXG4gICAgLy8gICAgICAgICAgICB0YXJnZXQucmVtb3ZlQ2hpbGQob2xkQmluZGluZy5kb20pO1xyXG4gICAgLy8gICAgICAgIH1cclxuXHJcbiAgICAvLyAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgZXhlY3V0ZShyZXN1bHQsIGlkeCkge1xyXG4gICAgLy8gICAgICAgIHRoaXMuYWRkQmluZGluZyh0aGlzLnRwbC5iaW5kKHJlc3VsdCksIGlkeCk7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgYWRkQmluZGluZyhuZXdCaW5kaW5nLCBpZHgpIHtcclxuICAgIC8vICAgICAgICB2YXIgeyBvZmZzZXQsIHRhcmdldCwgYmluZGluZ3MgfSA9IHRoaXM7XHJcbiAgICAvLyAgICAgICAgdmFyIGluc2VydEF0ID0gb2Zmc2V0ICsgaWR4O1xyXG5cclxuICAgIC8vICAgICAgICBpZiAoaW5zZXJ0QXQgPCB0YXJnZXQuY2hpbGROb2Rlcy5sZW5ndGgpIHtcclxuICAgIC8vICAgICAgICAgICAgdmFyIGJlZm9yZUVsZW1lbnQgPSB0YXJnZXQuY2hpbGROb2Rlc1tpbnNlcnRBdF07XHJcbiAgICAvLyAgICAgICAgICAgIHRhcmdldC5pbnNlcnRCZWZvcmUobmV3QmluZGluZy5kb20sIGJlZm9yZUVsZW1lbnQpO1xyXG4gICAgLy8gICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgIHRhcmdldC5hcHBlbmRDaGlsZChuZXdCaW5kaW5nLmRvbSk7XHJcbiAgICAvLyAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICBiaW5kaW5ncy5zcGxpY2UoaWR4LCAwLCBuZXdCaW5kaW5nKTtcclxuICAgIC8vICAgIH1cclxuICAgIC8vfVxyXG5cclxuICAgIC8vZXhwb3J0IGZ1bmN0aW9uIGV4ZWN1dGVUZW1wbGF0ZShvYnNlcnZhYmxlLCB0cGw6IFRlbXBsYXRlLklOb2RlLCB0YXJnZXQsIG9mZnNldCkge1xyXG4gICAgLy8gICAgcmV0dXJuIG5ldyBSZWFjdGl2ZUJpbmRpbmcodHBsLCB0YXJnZXQsIG9mZnNldCkudXBkYXRlKG9ic2VydmFibGUpO1xyXG4gICAgLy99XHJcblxyXG4gICAgLy9jbGFzcyBCaW5kZXIge1xyXG4gICAgLy8gICAgcHJpdmF0ZSBjb21waWxlOiBGdW5jdGlvbjtcclxuICAgIC8vICAgIHByaXZhdGUgY29tcGlsZXI6IEFzdC5Db21waWxlcjtcclxuICAgIC8vICAgIHB1YmxpYyBjb250ZXh0czogRGF0YTQuSVZhbHVlW10gPSBbXTtcclxuXHJcbiAgICAvLyAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxpYnM6IGFueVtdKSB7XHJcbiAgICAvLyAgICAgICAgdGhpcy5jb21waWxlciA9IG5ldyBBc3QuQ29tcGlsZXIoKTtcclxuICAgIC8vICAgICAgICB0aGlzLmNvbXBpbGUgPSB0aGlzLmNvbXBpbGVyLnRlbXBsYXRlLmJpbmQodGhpcy5jb21waWxlcik7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgc3RhdGljIGxpc3Rlbih0YXJnZXQsIHN0b3JlOiBEYXRhNS5TdG9yZSkge1xyXG4gICAgLy8gICAgICAgIHZhciBldmVudEhhbmRsZXIgPSAodGFyZ2V0LCBuYW1lKSA9PiB7XHJcbiAgICAvLyAgICAgICAgICAgIHZhciBiaW5kaW5nID0gdGFyZ2V0LmF0dHJpYnV0ZXNbXCJfX2JpbmRpbmdcIl07XHJcbiAgICAvLyAgICAgICAgICAgIGlmICghIWJpbmRpbmcpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIGJpbmRpbmcudHJpZ2dlcihuYW1lKTtcclxuICAgIC8vICAgICAgICAgICAgICAgIHN0b3JlLnVwZGF0ZSgpO1xyXG4gICAgLy8gICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgfTtcclxuXHJcbiAgICAvLyAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBldnQgPT4gZXZlbnRIYW5kbGVyKGV2dC50YXJnZXQsIGV2dC50eXBlKSk7XHJcblxyXG4gICAgLy8gICAgICAgIGNvbnN0IG9uY2hhbmdlID0gZXZ0ID0+IHtcclxuICAgIC8vICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSBldnQudGFyZ2V0LmF0dHJpYnV0ZXNbXCJfX2JpbmRpbmdcIl07XHJcbiAgICAvLyAgICAgICAgICAgIGlmIChiaW5kaW5nICE9IG51bGwpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIGNvbnN0IG5hbWVBdHRyID0gZXZ0LnRhcmdldC5hdHRyaWJ1dGVzW1wibmFtZVwiXTtcclxuICAgIC8vICAgICAgICAgICAgICAgIGlmICghIW5hbWVBdHRyKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgdmFyIGFyciA9IG5hbWVBdHRyLnZhbHVlLnNwbGl0KCcuJyk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSBiaW5kaW5nLmNvbnRleHQ7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHAgPSBhcnJbaV07XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0LmdldChwKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgY29udGV4dC5zZXQoZXZ0LnRhcmdldC52YWx1ZSk7XHJcblxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHN0b3JlLnVwZGF0ZSgpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgfTtcclxuICAgIC8vICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihcImtleXVwXCIsXHJcbiAgICAvLyAgICAgICAgICAgIGV2dCA9PiB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBpZiAoZXZ0LmtleUNvZGUgPT09IDEzKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVyKGV2dC50YXJnZXQsIFwia2V5dXAuZW50ZXJcIik7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIG9uY2hhbmdlKGV2dCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgIH0pO1xyXG4gICAgLy8gICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKFwibW91c2VvdmVyXCIsXHJcbiAgICAvLyAgICAgICAgICAgIGV2dCA9PiB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBldmVudEhhbmRsZXIoZXZ0LnRhcmdldCwgXCJtb3VzZW92ZXJcIik7XHJcbiAgICAvLyAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICApO1xyXG4gICAgLy8gICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKFwibW91c2VvdXRcIixcclxuICAgIC8vICAgICAgICAgICAgZXZ0ID0+IHtcclxuICAgIC8vICAgICAgICAgICAgICAgIGV2ZW50SGFuZGxlcihldnQudGFyZ2V0LCBcIm1vdXNlb3V0XCIpO1xyXG4gICAgLy8gICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgKTtcclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvLyAgICBwdWJsaWMgdXBkYXRlMigpIHtcclxuICAgIC8vICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY29udGV4dHMubGVuZ3RoOyBpKyspIHtcclxuICAgIC8vICAgICAgICAgICAgdmFyIGN0eCA9IHRoaXMuY29udGV4dHNbaV07XHJcbiAgICAvLyAgICAgICAgICAgIGN0eC51cGRhdGUobnVsbCk7XHJcbiAgICAvLyAgICAgICAgfVxyXG4gICAgLy8gICAgfVxyXG5cclxuICAgIC8vICAgIHBhcnNlRG9tKHJvb3REb206IE5vZGUpOiBUZW1wbGF0ZS5JTm9kZSB7XHJcbiAgICAvLyAgICAgICAgY29uc3Qgc3RhY2sgPSBbXTtcclxuICAgIC8vICAgICAgICBsZXQgaTogbnVtYmVyO1xyXG4gICAgLy8gICAgICAgIHZhciByb290VHBsO1xyXG4gICAgLy8gICAgICAgIHN0YWNrLnB1c2goe1xyXG4gICAgLy8gICAgICAgICAgICBub2RlOiByb290RG9tLFxyXG4gICAgLy8gICAgICAgICAgICBwdXNoKGUpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIHJvb3RUcGwgPSBlO1xyXG4gICAgLy8gICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgfSk7XHJcblxyXG4gICAgLy8gICAgICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7XHJcbiAgICAvLyAgICAgICAgICAgIGNvbnN0IGN1ciA9IHN0YWNrLnBvcCgpO1xyXG4gICAgLy8gICAgICAgICAgICBjb25zdCBub2RlOiBOb2RlID0gY3VyLm5vZGU7XHJcbiAgICAvLyAgICAgICAgICAgIGNvbnN0IHB1c2ggPSBjdXIucHVzaDtcclxuXHJcbiAgICAvLyAgICAgICAgICAgIGlmICghIW5vZGVbXCJjb250ZW50XCJdKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBjb25zdCBlbHQgPSA8SFRNTEVsZW1lbnQ+bm9kZVtcImNvbnRlbnRcIl07XHJcbiAgICAvLyAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUuQ29udGVudFRlbXBsYXRlKCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBmb3IgKGkgPSBlbHQuY2hpbGROb2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goeyBub2RlOiBlbHQuY2hpbGROb2Rlc1tpXSwgcHVzaDogdGVtcGxhdGUuYWRkQ2hpbGQuYmluZCh0ZW1wbGF0ZSkgfSk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICBwdXNoKHRlbXBsYXRlKTtcclxuICAgIC8vICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBjb25zdCBlbHQgPSA8SFRNTEVsZW1lbnQ+bm9kZTtcclxuICAgIC8vICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gbmV3IFRlbXBsYXRlLlRhZ1RlbXBsYXRlKGVsdC50YWdOYW1lLCBlbHQubmFtZXNwYWNlVVJJKTtcclxuXHJcbiAgICAvLyAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyAhIWVsdC5hdHRyaWJ1dGVzICYmIGkgPCBlbHQuYXR0cmlidXRlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGUgPSBlbHQuYXR0cmlidXRlc1tpXTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnNlQXR0cih0ZW1wbGF0ZSwgYXR0cmlidXRlKTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAvLyAgICAgICAgICAgICAgICBmb3IgKGkgPSBlbHQuY2hpbGROb2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goeyBub2RlOiBlbHQuY2hpbGROb2Rlc1tpXSwgcHVzaDogdGVtcGxhdGUuYWRkQ2hpbGQuYmluZCh0ZW1wbGF0ZSkgfSk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICBwdXNoKHRlbXBsYXRlKTtcclxuICAgIC8vICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB2YXIgdGV4dENvbnRlbnQgPSBub2RlLnRleHRDb250ZW50O1xyXG4gICAgLy8gICAgICAgICAgICAgICAgaWYgKHRleHRDb250ZW50LnRyaW0oKS5sZW5ndGggPiAwKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgY29uc3QgdHBsID0gdGhpcy5jb21waWxlKHRleHRDb250ZW50KTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICBwdXNoKG5ldyBUZW1wbGF0ZS5UZXh0VGVtcGxhdGUodHBsIHx8IG5vZGUudGV4dENvbnRlbnQpKTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgIH1cclxuXHJcbiAgICAvLyAgICAgICAgcmV0dXJuIHJvb3RUcGw7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgcGFyc2VBdHRyKHRhZ0VsZW1lbnQ6IFRlbXBsYXRlLlRhZ1RlbXBsYXRlLCBhdHRyOiBBdHRyKSB7XHJcbiAgICAvLyAgICAgICAgY29uc3QgbmFtZSA9IGF0dHIubmFtZTtcclxuICAgIC8vICAgICAgICBpZiAobmFtZSA9PT0gXCJjbGlja1wiIHx8IG5hbWUubWF0Y2goL2tleXVwXFwuLykgfHwgbmFtZSA9PT0gXCJtb3VzZW92ZXJcIiB8fCBuYW1lID09PSBcIm1vdXNlb3V0XCIpIHtcclxuICAgIC8vICAgICAgICAgICAgY29uc3QgZm4gPSB0aGlzLmNvbXBpbGUoYXR0ci52YWx1ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIHRhZ0VsZW1lbnQuYWRkRXZlbnQobmFtZSwgZm4pO1xyXG4gICAgLy8gICAgICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gXCJkYXRhLXNlbGVjdFwiIHx8IG5hbWUgPT09IFwiZGF0YS1mcm9tXCIpIHtcclxuICAgIC8vICAgICAgICAgICAgY29uc3QgZm4gPSB0aGlzLmNvbXBpbGUoYXR0ci52YWx1ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIHRhZ0VsZW1lbnQuc2VsZWN0KGZuKTtcclxuICAgIC8vICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICBjb25zdCB0cGwgPSB0aGlzLmNvbXBpbGUoYXR0ci52YWx1ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIHRhZ0VsZW1lbnQuYXR0cihuYW1lLCB0cGwgfHwgYXR0ci52YWx1ZSk7XHJcblxyXG4gICAgLy8gICAgICAgICAgICAvLyBjb252ZW50aW9uc1xyXG4gICAgLy8gICAgICAgICAgICBpZiAoISF0YWdFbGVtZW50Lm5hbWUubWF0Y2goL15pbnB1dCQvaSkgJiZcclxuICAgIC8vICAgICAgICAgICAgICAgICEhYXR0ci5uYW1lLm1hdGNoKC9ebmFtZSQvaSkgJiZcclxuICAgIC8vICAgICAgICAgICAgICAgICF0YWdFbGVtZW50LmdldEF0dHJpYnV0ZShcInZhbHVlXCIpKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZUFjY2Vzc29yID0gdGhpcy5jb21waWxlKGB7eyAke2F0dHIudmFsdWV9IH19YCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB0YWdFbGVtZW50LmF0dHIoXCJ2YWx1ZVwiLCB2YWx1ZUFjY2Vzc29yKTtcclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgIH1cclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvL31cclxuXHJcbiAgICAvL2V4cG9ydCBmdW5jdGlvbiBpbXBvcnRWaWV3KHZpZXc6IHN0cmluZywgLi4uYXJncyk6IGFueSB7XHJcbiAgICAvLyAgICBpZiAoIShcImltcG9ydFwiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJsaW5rXCIpKSkge1xyXG4gICAgLy8gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkhUTUwgaW1wb3J0IGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBicm93c2VyXCIpO1xyXG4gICAgLy8gICAgfVxyXG5cclxuICAgIC8vICAgIHZhciBkZWZlcnJlZCA9IGRlZmVyKCk7XHJcbiAgICAvLyAgICB2YXIgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTtcclxuICAgIC8vICAgIGxpbmsucmVsID0gJ2ltcG9ydCc7XHJcbiAgICAvLyAgICBsaW5rLmhyZWYgPSB2aWV3O1xyXG4gICAgLy8gICAgbGluay5zZXRBdHRyaWJ1dGUoJ2FzeW5jJywgXCJcIik7IC8vIG1ha2UgaXQgYXN5bmMhXHJcbiAgICAvLyAgICBsaW5rLm9ubG9hZCA9IGUgPT4ge1xyXG4gICAgLy8gICAgICAgIHZhciBsaW5rID0gKDxhbnk+ZS50YXJnZXQpO1xyXG4gICAgLy8gICAgICAgIGRlZmVycmVkLm5vdGlmeShsaW5rLmltcG9ydC5xdWVyeVNlbGVjdG9yKFwidGVtcGxhdGVcIikpO1xyXG4gICAgLy8gICAgICAgIGxpbmsub25sb2FkID0gbnVsbDtcclxuICAgIC8vICAgIH1cclxuICAgIC8vICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobGluayk7XHJcblxyXG4gICAgLy8gICAgcmV0dXJuIGRlZmVycmVkO1xyXG4gICAgLy99XHJcblxyXG4gICAgLy9mdW5jdGlvbiBkZWZlcigpIHtcclxuICAgIC8vICAgIHJldHVybiB7XHJcbiAgICAvLyAgICAgICAgdmFsdWU6IHZvaWQgMCxcclxuICAgIC8vICAgICAgICByZXNvbHZlcnM6IFtdLFxyXG4gICAgLy8gICAgICAgIG5vdGlmeSh2YWx1ZSkge1xyXG4gICAgLy8gICAgICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQgMClcclxuICAgIC8vICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInVuZGVmaW5lZCByZXN1bHRcIik7XHJcblxyXG4gICAgLy8gICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7XHJcblxyXG4gICAgLy8gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucmVzb2x2ZXJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB0aGlzLnJlc29sdmVyc1tpXS5jYWxsKG51bGwsIHZhbHVlKTtcclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgIH0sXHJcbiAgICAvLyAgICAgICAgdGhlbihyZXNvbHZlKSB7XHJcbiAgICAvLyAgICAgICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2b2lkIDApIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZXJzLnB1c2gocmVzb2x2ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICByZXNvbHZlLmNhbGwobnVsbCwgdGhpcy52YWx1ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICB9XHJcbiAgICAvLyAgICB9O1xyXG4gICAgLy99XHJcblxyXG4gICAgLy9leHBvcnQgZnVuY3Rpb24gYmluZChkb206IE5vZGUsIHN0b3JlKSB7XHJcblxyXG4gICAgLy8gICAgdmFyIGJpbmRlciA9IG5ldyBCaW5kZXIoW0NvcmUuTGlzdCwgQ29yZS5NYXRoLCBDb3JlLkRhdGVzXSk7XHJcblxyXG4gICAgLy8gICAgbGV0IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO1xyXG4gICAgLy8gICAgRG9tLmV4ZWN1dGVUZW1wbGF0ZShzdG9yZSwgYmluZGVyLnBhcnNlRG9tKGRvbSksIGZyYWdtZW50LCAwKTtcclxuICAgIC8vICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgLy8gICAgICAgIHZhciBjaGlsZCA9IGZyYWdtZW50LmNoaWxkTm9kZXNbaV07XHJcbiAgICAvLyAgICAgICAgQmluZGVyLmxpc3RlbihjaGlsZCwgc3RvcmUpO1xyXG4gICAgLy8gICAgfVxyXG5cclxuICAgIC8vICAgIHJldHVybiBmcmFnbWVudDtcclxuICAgIC8vfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gam9pbihzZXBhcmF0b3I6IHN0cmluZywgdmFsdWUpIHtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG4gICAgICAgIHJldHVybiB2YWx1ZS5sZW5ndGggPiAwID8gdmFsdWUuc29ydCgpLmpvaW4oc2VwYXJhdG9yKSA6IG51bGw7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbn1cclxuXHJcbiAgICAvLyBSZVNoYXJwZXIgcmVzdG9yZSBJbmNvbnNpc3RlbnROYW1pbmdcclxuIl19