"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var rebind_1 = require("./rebind");
var fsharp_1 = require("./fsharp");
var Dom;
(function (Dom) {
    var document = window.document;
    var ContentBinding = (function (_super) {
        __extends(ContentBinding, _super);
        function ContentBinding() {
            var _this = _super.call(this) || this;
            _this.dom = document.createDocumentFragment();
            return _this;
        }
        ContentBinding.prototype.render = function () {
            return this.dom;
        };
        return ContentBinding;
    }(rebind_1.Reactive.Binding));
    Dom.ContentBinding = ContentBinding;
    var TextBinding = (function (_super) {
        __extends(TextBinding, _super);
        function TextBinding(modelAccessor) {
            var _this = _super.call(this) || this;
            _this.modelAccessor = modelAccessor;
            _this.dom = document.createTextNode("");
            return _this;
        }
        TextBinding.prototype.render = function (context) {
            var newValue = fsharp_1.accept(this.modelAccessor, this);
            if (!!newValue && !!newValue.onNext) {
                newValue.subscribe(this);
            }
            else {
                this.onNext(newValue.valueOf());
            }
            return newValue.valueOf();
        };
        TextBinding.prototype.onNext = function (newValue) {
            this.dom.textContent = newValue;
        };
        return TextBinding;
    }(rebind_1.Reactive.Binding));
    Dom.TextBinding = TextBinding;
    var TagBinding = (function (_super) {
        __extends(TagBinding, _super);
        function TagBinding(name, ns, attributes, events) {
            var _this = _super.call(this) || this;
            _this.ns = ns;
            _this.events = events;
            _this.attributeBindings = [];
            if (ns === null)
                _this.dom = document.createElement(name);
            else {
                _this.dom = document.createElementNS(ns, name.toLowerCase());
            }
            _this.dom.attributes["__binding"] = _this;
            var classBinding = new ClassBinding(_this);
            var length = attributes.length;
            for (var i = 0; i < length; i++) {
                var attr = attributes[i];
                var attrTpl = attr.tpl;
                var attrName = attr.name;
                if (attrName === "class") {
                    classBinding.setBaseClass(attrTpl);
                }
                else if (attrName.startsWith("class.")) {
                    classBinding.addClass(attrName.substr(6), attrTpl);
                }
                else {
                    var attrBinding = new AttributeBinding(_this, attrName, attrTpl);
                    _this.attributeBindings.push(attrBinding);
                }
            }
            ;
            _this.attributeBindings.push(classBinding);
            return _this;
        }
        TagBinding.prototype.render = function (context) {
            for (var i = 0; i < this.attributeBindings.length; i++) {
                this.attributeBindings[i].render(context);
            }
            return this.dom;
        };
        TagBinding.prototype.trigger = function (name) {
            var handler = this.events.get(name);
            if (!!handler) {
                var result = handler.execute(this.context, {
                    get: function (obj, name) {
                        return obj.get(name);
                    },
                    set: function (obj, name, value) {
                        obj.get(name).set(value);
                    },
                    invoke: function (_, fn, args) {
                        if (!!fn.invoke) {
                            var xs = args.map(function (x) { return x.valueOf(); });
                            return fn.invoke(xs);
                        }
                        return fn;
                    }
                });
                if (!!result && typeof result.value === "function")
                    result.invoke();
            }
        };
        return TagBinding;
    }(rebind_1.Reactive.Binding));
    Dom.TagBinding = TagBinding;
    var ClassBinding = (function (_super) {
        __extends(ClassBinding, _super);
        function ClassBinding(parent) {
            var _this = _super.call(this) || this;
            _this.parent = parent;
            _this.conditions = [];
            return _this;
        }
        ClassBinding.prototype.setBaseClass = function (tpl) {
            this.baseClassTpl = tpl;
        };
        ClassBinding.prototype.addClass = function (className, condition) {
            this.conditions.push({ className: className, condition: condition });
        };
        ClassBinding.prototype.render = function (context) {
            this.context = context;
            var classes = [];
            if (!!this.baseClassTpl) {
                var value = this.baseClassTpl.execute(context, this).valueOf();
                classes.push(value);
            }
            for (var i = 0; i < this.conditions.length; i++) {
                var _a = this.conditions[i], className = _a.className, condition = _a.condition;
                if (!!condition.execute(context, this).valueOf()) {
                    classes.push(className);
                }
            }
            this.setAttribute("class", classes.length > 0 ? join(" ", classes) : null);
        };
        ClassBinding.prototype.setAttribute = function (attrName, newValue) {
            var oldValue = this.oldValue;
            var tag = this.parent.dom;
            if (typeof newValue === "undefined" || newValue === null) {
                tag[attrName] = void 0;
                tag.removeAttribute(attrName);
            }
            else {
                if (typeof oldValue === "undefined") {
                    var attr = document.createAttribute(attrName);
                    attr.value = newValue;
                    tag.setAttributeNode(attr);
                }
                else {
                    tag.className = newValue;
                }
            }
            this.oldValue = newValue;
        };
        return ClassBinding;
    }(rebind_1.Reactive.Binding));
    Dom.ClassBinding = ClassBinding;
    var AttributeBinding = (function (_super) {
        __extends(AttributeBinding, _super);
        function AttributeBinding(parent, name, tpl) {
            var _this = _super.call(this) || this;
            _this.parent = parent;
            _this.name = name;
            _this.tpl = tpl;
            return _this;
        }
        AttributeBinding.prototype.render = function (context) {
            this.context = context;
            var value = this.tpl.execute(context, this);
            if (!!value && !!value.onNext) {
                value.subscribe(this);
            }
            else {
                this.onNext(value);
            }
        };
        AttributeBinding.prototype.onNext = function (value) {
            if (value !== null && value !== void 0 && !!value.valueOf)
                value = value.valueOf();
            var newValue;
            if (this.name === "checked") {
                newValue = !!value ? "checked" : null;
            }
            else {
                newValue = value;
            }
            var oldValue = this.oldValue;
            var attrName = this.name;
            var tag = this.parent.dom;
            if (typeof newValue === "undefined" || newValue === null) {
                tag[attrName] = void 0;
                tag.removeAttribute(attrName);
            }
            else {
                if (typeof oldValue === "undefined") {
                    var attr = document.createAttribute(attrName);
                    attr.value = newValue;
                    tag.setAttributeNode(attr);
                }
                else {
                    tag[attrName] = newValue;
                    tag.setAttribute(attrName, newValue);
                }
            }
            this.oldValue = newValue;
        };
        return AttributeBinding;
    }(rebind_1.Reactive.Binding));
    Dom.AttributeBinding = AttributeBinding;
})(Dom = exports.Dom || (exports.Dom = {}));
function join(separator, value) {
    if (Array.isArray(value)) {
        return value.length > 0 ? value.sort().join(separator) : null;
    }
    return value;
}
exports.join = join;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2RvbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxtQ0FBeUM7QUFDekMsbUNBQWlDO0FBRWpDLElBQWMsR0FBRyxDQStkaEI7QUEvZEQsV0FBYyxHQUFHO0lBRWIsSUFBSSxRQUFRLEdBQVksTUFBTSxDQUFDLFFBQVEsQ0FBQztJQU14QztRQUFvQyxrQ0FBVTtRQUcxQztZQUFBLFlBQ0ksaUJBQU8sU0FFVjtZQURHLEtBQUksQ0FBQyxHQUFHLEdBQUcsUUFBUSxDQUFDLHNCQUFzQixFQUFFLENBQUM7O1FBQ2pELENBQUM7UUFFRCwrQkFBTSxHQUFOO1lBQ0ksTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDcEIsQ0FBQztRQUNMLHFCQUFDO0lBQUQsQ0FBQyxBQVhELENBQW9DLGlCQUFFLENBQUMsT0FBTyxHQVc3QztJQVhZLGtCQUFjLGlCQVcxQixDQUFBO0lBRUQ7UUFBaUMsK0JBQVU7UUFHdkMscUJBQW9CLGFBQWE7WUFBakMsWUFDSSxpQkFBTyxTQUVWO1lBSG1CLG1CQUFhLEdBQWIsYUFBYSxDQUFBO1lBRTdCLEtBQUksQ0FBQyxHQUFHLEdBQVMsUUFBUyxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQzs7UUFDbEQsQ0FBQztRQUVELDRCQUFNLEdBQU4sVUFBTyxPQUFPO1lBQ1YsSUFBTSxRQUFRLEdBQUcsZUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFbEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDN0IsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8s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QUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkIsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQ2xFLENBQUM7SUFDRCxNQUFNLENBQUMsS0FBSyxDQUFDO0FBQ2pCLENBQUM7QUFMRCxvQkFLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvcmUgfSBmcm9tICcuL2NvcmUnXHJcbmltcG9ydCB7IFJlYWN0aXZlIGFzIFJlIH0gZnJvbSAnLi9yZWJpbmQnXHJcbmltcG9ydCB7IGFjY2VwdCB9IGZyb20gJy4vZnNoYXJwJ1xyXG5cclxuZXhwb3J0IG1vZHVsZSBEb20ge1xyXG5cclxuICAgIHZhciBkb2N1bWVudDpEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDtcclxuXHJcbiAgICBpbnRlcmZhY2UgSUJpbmRpbmcge1xyXG4gICAgICAgIGRvbTtcclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgY2xhc3MgQ29udGVudEJpbmRpbmcgZXh0ZW5kcyBSZS5CaW5kaW5nIGltcGxlbWVudHMgSUJpbmRpbmcge1xyXG4gICAgICAgIHB1YmxpYyBkb207XHJcblxyXG4gICAgICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgICAgICB0aGlzLmRvbSA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlbmRlcigpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgY2xhc3MgVGV4dEJpbmRpbmcgZXh0ZW5kcyBSZS5CaW5kaW5nIGltcGxlbWVudHMgSUJpbmRpbmcge1xyXG4gICAgICAgIHB1YmxpYyBkb207XHJcblxyXG4gICAgICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbW9kZWxBY2Nlc3Nvcikge1xyXG4gICAgICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgICAgICB0aGlzLmRvbSA9ICg8YW55PmRvY3VtZW50KS5jcmVhdGVUZXh0Tm9kZShcIlwiKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlbmRlcihjb250ZXh0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gYWNjZXB0KHRoaXMubW9kZWxBY2Nlc3NvciwgdGhpcyk7XHJcblxyXG4gICAgICAgICAgICBpZiAoISFuZXdWYWx1ZSAmJiAhIW5ld1ZhbHVlLm9uTmV4dCkge1xyXG4gICAgICAgICAgICAgICAgbmV3VmFsdWUuc3Vic2NyaWJlKHRoaXMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbk5leHQobmV3VmFsdWUudmFsdWVPZigpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG5ld1ZhbHVlLnZhbHVlT2YoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIG9uTmV4dChuZXdWYWx1ZSkge1xyXG4gICAgICAgICAgICB0aGlzLmRvbS50ZXh0Q29udGVudCA9IG5ld1ZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgY2xhc3MgVGFnQmluZGluZyBleHRlbmRzIFJlLkJpbmRpbmcgaW1wbGVtZW50cyBJQmluZGluZyB7XHJcbiAgICAgICAgcHVibGljIGRvbTtcclxuICAgICAgICBwcml2YXRlIGF0dHJpYnV0ZUJpbmRpbmdzID0gW107XHJcblxyXG4gICAgICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZywgcHJpdmF0ZSBuczogc3RyaW5nLCBhdHRyaWJ1dGVzOiB7IG5hbWU7IHRwbCB9W10sIHByaXZhdGUgZXZlbnRzKSB7XHJcbiAgICAgICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgICAgIGlmIChucyA9PT0gbnVsbClcclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChuYW1lKTtcclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRvbSA9ICg8YW55PmRvY3VtZW50KS5jcmVhdGVFbGVtZW50TlMobnMsIG5hbWUudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuZG9tLmF0dHJpYnV0ZXNbXCJfX2JpbmRpbmdcIl0gPSB0aGlzO1xyXG5cclxuICAgICAgICAgICAgdmFyIGNsYXNzQmluZGluZyA9IG5ldyBDbGFzc0JpbmRpbmcodGhpcyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IGF0dHJpYnV0ZXMubGVuZ3RoO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXR0ciA9IGF0dHJpYnV0ZXNbaV07XHJcblxyXG4gICAgICAgICAgICAgICAgdmFyIGF0dHJUcGwgPSBhdHRyLnRwbDtcclxuICAgICAgICAgICAgICAgIHZhciBhdHRyTmFtZSA9IGF0dHIubmFtZTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoYXR0ck5hbWUgPT09IFwiY2xhc3NcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzQmluZGluZy5zZXRCYXNlQ2xhc3MoYXR0clRwbCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF0dHJOYW1lLnN0YXJ0c1dpdGgoXCJjbGFzcy5cIikpIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGFzc0JpbmRpbmcuYWRkQ2xhc3MoYXR0ck5hbWUuc3Vic3RyKDYpLCBhdHRyVHBsKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJCaW5kaW5nID0gbmV3IEF0dHJpYnV0ZUJpbmRpbmcodGhpcywgYXR0ck5hbWUsIGF0dHJUcGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlQmluZGluZ3MucHVzaChhdHRyQmluZGluZyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlQmluZGluZ3MucHVzaChjbGFzc0JpbmRpbmcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVuZGVyKGNvbnRleHQpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmF0dHJpYnV0ZUJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmF0dHJpYnV0ZUJpbmRpbmdzW2ldLnJlbmRlcihjb250ZXh0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kb207XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0cmlnZ2VyKG5hbWUpIHtcclxuICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSB0aGlzLmV2ZW50cy5nZXQobmFtZSk7XHJcbiAgICAgICAgICAgIGlmICghIWhhbmRsZXIpIHtcclxuICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBoYW5kbGVyLmV4ZWN1dGUodGhpcy5jb250ZXh0LCB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ2V0KG9iaiwgbmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqLmdldChuYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIHNldChvYmo6IGFueSwgbmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9iai5nZXQobmFtZSkuc2V0KHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGludm9rZShfLCBmbiwgYXJncykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoISFmbi5pbnZva2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB4cyA9IGFyZ3MubWFwKHggPT4geC52YWx1ZU9mKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuLmludm9rZSh4cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghIXJlc3VsdCAmJiB0eXBlb2YgcmVzdWx0LnZhbHVlID09PSBcImZ1bmN0aW9uXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lmludm9rZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBjbGFzcyBDbGFzc0JpbmRpbmcgZXh0ZW5kcyBSZS5CaW5kaW5nIGltcGxlbWVudHMgSUJpbmRpbmcge1xyXG4gICAgICAgIHB1YmxpYyBkb207XHJcbiAgICAgICAgcHJpdmF0ZSBjb25kaXRpb25zID0gW107XHJcbiAgICAgICAgcHJpdmF0ZSBvbGRWYWx1ZTtcclxuICAgICAgICBwcml2YXRlIGJhc2VDbGFzc1RwbDtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSBwYXJlbnQ6IFRhZ0JpbmRpbmcpIHtcclxuICAgICAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHNldEJhc2VDbGFzcyh0cGwpIHtcclxuICAgICAgICAgICAgdGhpcy5iYXNlQ2xhc3NUcGwgPSB0cGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBhZGRDbGFzcyhjbGFzc05hbWUsIGNvbmRpdGlvbikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbmRpdGlvbnMucHVzaCh7IGNsYXNzTmFtZSwgY29uZGl0aW9uIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVuZGVyKGNvbnRleHQpIHtcclxuICAgICAgICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dDtcclxuICAgICAgICAgICAgY29uc3QgY2xhc3NlcyA9IFtdO1xyXG4gICAgICAgICAgICBpZiAoISF0aGlzLmJhc2VDbGFzc1RwbCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gdGhpcy5iYXNlQ2xhc3NUcGwuZXhlY3V0ZShjb250ZXh0LCB0aGlzKS52YWx1ZU9mKCk7XHJcbiAgICAgICAgICAgICAgICBjbGFzc2VzLnB1c2godmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuY29uZGl0aW9ucy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdmFyIHsgY2xhc3NOYW1lLCBjb25kaXRpb24gfSA9IHRoaXMuY29uZGl0aW9uc1tpXTtcclxuICAgICAgICAgICAgICAgIGlmICghIWNvbmRpdGlvbi5leGVjdXRlKGNvbnRleHQsIHRoaXMpLnZhbHVlT2YoKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzZXMucHVzaChjbGFzc05hbWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShcImNsYXNzXCIsIGNsYXNzZXMubGVuZ3RoID4gMCA/IGpvaW4oXCIgXCIsIGNsYXNzZXMpIDogbnVsbCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgc2V0QXR0cmlidXRlKGF0dHJOYW1lOiBzdHJpbmcsIG5ld1ZhbHVlKSB7XHJcbiAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMub2xkVmFsdWU7XHJcblxyXG4gICAgICAgICAgICB2YXIgdGFnID0gdGhpcy5wYXJlbnQuZG9tO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIG5ld1ZhbHVlID09PSBcInVuZGVmaW5lZFwiIHx8IG5ld1ZhbHVlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICB0YWdbYXR0ck5hbWVdID0gdm9pZCAwO1xyXG4gICAgICAgICAgICAgICAgdGFnLnJlbW92ZUF0dHJpYnV0ZShhdHRyTmFtZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9sZFZhbHVlID09PSBcInVuZGVmaW5lZFwiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHIgPSBkb2N1bWVudC5jcmVhdGVBdHRyaWJ1dGUoYXR0ck5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGF0dHIudmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB0YWcuc2V0QXR0cmlidXRlTm9kZShhdHRyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFnLmNsYXNzTmFtZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMub2xkVmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBjbGFzcyBBdHRyaWJ1dGVCaW5kaW5nIGV4dGVuZHMgUmUuQmluZGluZyBpbXBsZW1lbnRzIElCaW5kaW5nIHtcclxuICAgICAgICBwdWJsaWMgZG9tO1xyXG4gICAgICAgIHByaXZhdGUgb2xkVmFsdWU7XHJcblxyXG4gICAgICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcGFyZW50OiBUYWdCaW5kaW5nLCBwcml2YXRlIG5hbWUsIHByaXZhdGUgdHBsKSB7XHJcbiAgICAgICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZW5kZXIoY29udGV4dCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xyXG4gICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLnRwbC5leGVjdXRlKGNvbnRleHQsIHRoaXMpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCEhdmFsdWUgJiYgISF2YWx1ZS5vbk5leHQpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlLnN1YnNjcmliZSh0aGlzKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25OZXh0KHZhbHVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIG9uTmV4dCh2YWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHZvaWQgMCAmJiAhIXZhbHVlLnZhbHVlT2YpXHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnZhbHVlT2YoKTtcclxuXHJcbiAgICAgICAgICAgIHZhciBuZXdWYWx1ZTtcclxuICAgICAgICAgICAgaWYgKHRoaXMubmFtZSA9PT0gXCJjaGVja2VkXCIpIHtcclxuICAgICAgICAgICAgICAgIG5ld1ZhbHVlID0gISF2YWx1ZSA/IFwiY2hlY2tlZFwiIDogbnVsbDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIG5ld1ZhbHVlID0gdmFsdWU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IHRoaXMub2xkVmFsdWU7XHJcblxyXG4gICAgICAgICAgICB2YXIgYXR0ck5hbWUgPSB0aGlzLm5hbWU7XHJcbiAgICAgICAgICAgIHZhciB0YWcgPSB0aGlzLnBhcmVudC5kb207XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3VmFsdWUgPT09IFwidW5kZWZpbmVkXCIgfHwgbmV3VmFsdWUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHRhZ1thdHRyTmFtZV0gPSB2b2lkIDA7XHJcbiAgICAgICAgICAgICAgICB0YWcucmVtb3ZlQXR0cmlidXRlKGF0dHJOYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2xkVmFsdWUgPT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ciA9IGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZShhdHRyTmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYXR0ci52YWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHRhZy5zZXRBdHRyaWJ1dGVOb2RlKGF0dHIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0YWdbYXR0ck5hbWVdID0gbmV3VmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFnLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgbmV3VmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMub2xkVmFsdWUgPSBuZXdWYWx1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy9jbGFzcyBSZWFjdGl2ZUJpbmRpbmcgZXh0ZW5kcyBEb21CaW5kaW5nIHtcclxuICAgIC8vICAgIHByaXZhdGUgYmluZGluZ3MgPSBbXTtcclxuICAgIC8vICAgIHByaXZhdGUgc3RyZWFtO1xyXG4gICAgLy8gICAgcHJpdmF0ZSBsZW5ndGg7XHJcblxyXG4gICAgLy8gICAgY29uc3RydWN0b3IocHJpdmF0ZSB0cGw6IFRlbXBsYXRlLklOb2RlVGVtcGxhdGUsIHByaXZhdGUgdGFyZ2V0LCBwcml2YXRlIG9mZnNldCkge1xyXG4gICAgLy8gICAgICAgIHN1cGVyKCk7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgcmVuZGVyKGNvbnRleHQpIHtcclxuICAgIC8vICAgICAgICB2YXIgeyBiaW5kaW5ncywgdGFyZ2V0LCB0cGwgfSA9IHRoaXM7XHJcbiAgICAvLyAgICAgICAgaWYgKCEhdHBsLm1vZGVsQWNjZXNzb3IpIHtcclxuICAgIC8vICAgICAgICAgICAgdmFyIHN0cmVhbSA9IHRwbC5tb2RlbEFjY2Vzc29yLmV4ZWN1dGUoY29udGV4dCwgdGhpcyk7XHJcbiAgICAvLyAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMDtcclxuXHJcbiAgICAvLyAgICAgICAgICAgIHN0cmVhbS5mb3JFYWNoKChjdHgsIGlkeCkgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgdGhpcy5sZW5ndGggPSBpZHggKyAxO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBiaW5kaW5ncy5sZW5ndGg7IGkrKykge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gYmluZGluZ3NbaV07XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmcuY29udGV4dC52YWx1ZSA9PT0gY3R4LnZhbHVlKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpICE9PSBpZHgpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzW2ldID0gYmluZGluZ3NbaWR4XTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzW2lkeF0gPSBiaW5kaW5nO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGUoY3R4LCBpZHgpO1xyXG4gICAgLy8gICAgICAgICAgICB9KTtcclxuICAgIC8vICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICB0aGlzLmV4ZWN1dGUoY29udGV4dCwgMCk7XHJcbiAgICAvLyAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMTtcclxuICAgIC8vICAgICAgICB9XHJcblxyXG4gICAgLy8gICAgICAgIHdoaWxlIChiaW5kaW5ncy5sZW5ndGggPiB0aGlzLmxlbmd0aCkge1xyXG4gICAgLy8gICAgICAgICAgICBjb25zdCBvbGRCaW5kaW5nID0gYmluZGluZ3MucG9wKCk7XHJcbiAgICAvLyAgICAgICAgICAgIHRhcmdldC5yZW1vdmVDaGlsZChvbGRCaW5kaW5nLmRvbSk7XHJcbiAgICAvLyAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvLyAgICBleGVjdXRlKHJlc3VsdCwgaWR4KSB7XHJcbiAgICAvLyAgICAgICAgdGhpcy5hZGRCaW5kaW5nKHRoaXMudHBsLmJpbmQocmVzdWx0KSwgaWR4KTtcclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvLyAgICBhZGRCaW5kaW5nKG5ld0JpbmRpbmcsIGlkeCkge1xyXG4gICAgLy8gICAgICAgIHZhciB7IG9mZnNldCwgdGFyZ2V0LCBiaW5kaW5ncyB9ID0gdGhpcztcclxuICAgIC8vICAgICAgICB2YXIgaW5zZXJ0QXQgPSBvZmZzZXQgKyBpZHg7XHJcblxyXG4gICAgLy8gICAgICAgIGlmIChpbnNlcnRBdCA8IHRhcmdldC5jaGlsZE5vZGVzLmxlbmd0aCkge1xyXG4gICAgLy8gICAgICAgICAgICB2YXIgYmVmb3JlRWxlbWVudCA9IHRhcmdldC5jaGlsZE5vZGVzW2luc2VydEF0XTtcclxuICAgIC8vICAgICAgICAgICAgdGFyZ2V0Lmluc2VydEJlZm9yZShuZXdCaW5kaW5nLmRvbSwgYmVmb3JlRWxlbWVudCk7XHJcbiAgICAvLyAgICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgdGFyZ2V0LmFwcGVuZENoaWxkKG5ld0JpbmRpbmcuZG9tKTtcclxuICAgIC8vICAgICAgICB9XHJcblxyXG4gICAgLy8gICAgICAgIGJpbmRpbmdzLnNwbGljZShpZHgsIDAsIG5ld0JpbmRpbmcpO1xyXG4gICAgLy8gICAgfVxyXG4gICAgLy99XHJcblxyXG4gICAgLy9leHBvcnQgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKG9ic2VydmFibGUsIHRwbDogVGVtcGxhdGUuSU5vZGVUZW1wbGF0ZSwgdGFyZ2V0LCBvZmZzZXQpIHtcclxuICAgIC8vICAgIHJldHVybiBuZXcgUmVhY3RpdmVCaW5kaW5nKHRwbCwgdGFyZ2V0LCBvZmZzZXQpLnVwZGF0ZShvYnNlcnZhYmxlKTtcclxuICAgIC8vfVxyXG5cclxuICAgIC8vY2xhc3MgQmluZGVyIHtcclxuICAgIC8vICAgIHByaXZhdGUgY29tcGlsZTogRnVuY3Rpb247XHJcbiAgICAvLyAgICBwcml2YXRlIGNvbXBpbGVyOiBBc3QuQ29tcGlsZXI7XHJcbiAgICAvLyAgICBwdWJsaWMgY29udGV4dHM6IERhdGE0LklWYWx1ZVtdID0gW107XHJcblxyXG4gICAgLy8gICAgY29uc3RydWN0b3IocHJpdmF0ZSBsaWJzOiBhbnlbXSkge1xyXG4gICAgLy8gICAgICAgIHRoaXMuY29tcGlsZXIgPSBuZXcgQXN0LkNvbXBpbGVyKCk7XHJcbiAgICAvLyAgICAgICAgdGhpcy5jb21waWxlID0gdGhpcy5jb21waWxlci50ZW1wbGF0ZS5iaW5kKHRoaXMuY29tcGlsZXIpO1xyXG4gICAgLy8gICAgfVxyXG5cclxuICAgIC8vICAgIHN0YXRpYyBsaXN0ZW4odGFyZ2V0LCBzdG9yZTogRGF0YTUuU3RvcmUpIHtcclxuICAgIC8vICAgICAgICB2YXIgZXZlbnRIYW5kbGVyID0gKHRhcmdldCwgbmFtZSkgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICB2YXIgYmluZGluZyA9IHRhcmdldC5hdHRyaWJ1dGVzW1wiX19iaW5kaW5nXCJdO1xyXG4gICAgLy8gICAgICAgICAgICBpZiAoISFiaW5kaW5nKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBiaW5kaW5nLnRyaWdnZXIobmFtZSk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBzdG9yZS51cGRhdGUoKTtcclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgIH07XHJcblxyXG4gICAgLy8gICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgZXZ0ID0+IGV2ZW50SGFuZGxlcihldnQudGFyZ2V0LCBldnQudHlwZSkpO1xyXG5cclxuICAgIC8vICAgICAgICBjb25zdCBvbmNoYW5nZSA9IGV2dCA9PiB7XHJcbiAgICAvLyAgICAgICAgICAgIHZhciBiaW5kaW5nID0gZXZ0LnRhcmdldC5hdHRyaWJ1dGVzW1wiX19iaW5kaW5nXCJdO1xyXG4gICAgLy8gICAgICAgICAgICBpZiAoYmluZGluZyAhPSBudWxsKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBjb25zdCBuYW1lQXR0ciA9IGV2dC50YXJnZXQuYXR0cmlidXRlc1tcIm5hbWVcIl07XHJcbiAgICAvLyAgICAgICAgICAgICAgICBpZiAoISFuYW1lQXR0cikge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHZhciBhcnIgPSBuYW1lQXR0ci52YWx1ZS5zcGxpdCgnLicpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gYmluZGluZy5jb250ZXh0O1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwID0gYXJyW2ldO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5nZXQocCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIGNvbnRleHQuc2V0KGV2dC50YXJnZXQudmFsdWUpO1xyXG5cclxuICAgIC8vICAgICAgICAgICAgICAgICAgICBzdG9yZS51cGRhdGUoKTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgIH07XHJcbiAgICAvLyAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJrZXl1cFwiLFxyXG4gICAgLy8gICAgICAgICAgICBldnQgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgaWYgKGV2dC5rZXlDb2RlID09PSAxMykge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIGV2ZW50SGFuZGxlcihldnQudGFyZ2V0LCBcImtleXVwLmVudGVyXCIpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICBvbmNoYW5nZShldnQpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICB9KTtcclxuICAgIC8vICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlb3ZlclwiLFxyXG4gICAgLy8gICAgICAgICAgICBldnQgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVyKGV2dC50YXJnZXQsIFwibW91c2VvdmVyXCIpO1xyXG4gICAgLy8gICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgKTtcclxuICAgIC8vICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihcIm1vdXNlb3V0XCIsXHJcbiAgICAvLyAgICAgICAgICAgIGV2dCA9PiB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBldmVudEhhbmRsZXIoZXZ0LnRhcmdldCwgXCJtb3VzZW91dFwiKTtcclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICk7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgcHVibGljIHVwZGF0ZTIoKSB7XHJcbiAgICAvLyAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNvbnRleHRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAvLyAgICAgICAgICAgIHZhciBjdHggPSB0aGlzLmNvbnRleHRzW2ldO1xyXG4gICAgLy8gICAgICAgICAgICBjdHgudXBkYXRlKG51bGwpO1xyXG4gICAgLy8gICAgICAgIH1cclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvLyAgICBwYXJzZURvbShyb290RG9tOiBOb2RlKTogVGVtcGxhdGUuSU5vZGVUZW1wbGF0ZSB7XHJcbiAgICAvLyAgICAgICAgY29uc3Qgc3RhY2sgPSBbXTtcclxuICAgIC8vICAgICAgICBsZXQgaTogbnVtYmVyO1xyXG4gICAgLy8gICAgICAgIHZhciByb290VHBsO1xyXG4gICAgLy8gICAgICAgIHN0YWNrLnB1c2goe1xyXG4gICAgLy8gICAgICAgICAgICBub2RlOiByb290RG9tLFxyXG4gICAgLy8gICAgICAgICAgICBwdXNoKGUpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIHJvb3RUcGwgPSBlO1xyXG4gICAgLy8gICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgfSk7XHJcblxyXG4gICAgLy8gICAgICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7XHJcbiAgICAvLyAgICAgICAgICAgIGNvbnN0IGN1ciA9IHN0YWNrLnBvcCgpO1xyXG4gICAgLy8gICAgICAgICAgICBjb25zdCBub2RlOiBOb2RlID0gY3VyLm5vZGU7XHJcbiAgICAvLyAgICAgICAgICAgIGNvbnN0IHB1c2ggPSBjdXIucHVzaDtcclxuXHJcbiAgICAvLyAgICAgICAgICAgIGlmICghIW5vZGVbXCJjb250ZW50XCJdKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBjb25zdCBlbHQgPSA8SFRNTEVsZW1lbnQ+bm9kZVtcImNvbnRlbnRcIl07XHJcbiAgICAvLyAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUuQ29udGVudFRlbXBsYXRlKCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBmb3IgKGkgPSBlbHQuY2hpbGROb2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goeyBub2RlOiBlbHQuY2hpbGROb2Rlc1tpXSwgcHVzaDogdGVtcGxhdGUuYWRkQ2hpbGQuYmluZCh0ZW1wbGF0ZSkgfSk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICBwdXNoKHRlbXBsYXRlKTtcclxuICAgIC8vICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBjb25zdCBlbHQgPSA8SFRNTEVsZW1lbnQ+bm9kZTtcclxuICAgIC8vICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gbmV3IFRlbXBsYXRlLlRhZ1RlbXBsYXRlKGVsdC50YWdOYW1lLCBlbHQubmFtZXNwYWNlVVJJKTtcclxuXHJcbiAgICAvLyAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyAhIWVsdC5hdHRyaWJ1dGVzICYmIGkgPCBlbHQuYXR0cmlidXRlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHZhciBhdHRyaWJ1dGUgPSBlbHQuYXR0cmlidXRlc1tpXTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnNlQXR0cih0ZW1wbGF0ZSwgYXR0cmlidXRlKTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAvLyAgICAgICAgICAgICAgICBmb3IgKGkgPSBlbHQuY2hpbGROb2Rlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goeyBub2RlOiBlbHQuY2hpbGROb2Rlc1tpXSwgcHVzaDogdGVtcGxhdGUuYWRkQ2hpbGQuYmluZCh0ZW1wbGF0ZSkgfSk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICBwdXNoKHRlbXBsYXRlKTtcclxuICAgIC8vICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB2YXIgdGV4dENvbnRlbnQgPSBub2RlLnRleHRDb250ZW50O1xyXG4gICAgLy8gICAgICAgICAgICAgICAgaWYgKHRleHRDb250ZW50LnRyaW0oKS5sZW5ndGggPiAwKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgY29uc3QgdHBsID0gdGhpcy5jb21waWxlKHRleHRDb250ZW50KTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICBwdXNoKG5ldyBUZW1wbGF0ZS5UZXh0VGVtcGxhdGUodHBsIHx8IG5vZGUudGV4dENvbnRlbnQpKTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgIH1cclxuXHJcbiAgICAvLyAgICAgICAgcmV0dXJuIHJvb3RUcGw7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgcGFyc2VBdHRyKHRhZ0VsZW1lbnQ6IFRlbXBsYXRlLlRhZ1RlbXBsYXRlLCBhdHRyOiBBdHRyKSB7XHJcbiAgICAvLyAgICAgICAgY29uc3QgbmFtZSA9IGF0dHIubmFtZTtcclxuICAgIC8vICAgICAgICBpZiAobmFtZSA9PT0gXCJjbGlja1wiIHx8IG5hbWUubWF0Y2goL2tleXVwXFwuLykgfHwgbmFtZSA9PT0gXCJtb3VzZW92ZXJcIiB8fCBuYW1lID09PSBcIm1vdXNlb3V0XCIpIHtcclxuICAgIC8vICAgICAgICAgICAgY29uc3QgZm4gPSB0aGlzLmNvbXBpbGUoYXR0ci52YWx1ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIHRhZ0VsZW1lbnQuYWRkRXZlbnQobmFtZSwgZm4pO1xyXG4gICAgLy8gICAgICAgIH0gZWxzZSBpZiAobmFtZSA9PT0gXCJkYXRhLXNlbGVjdFwiIHx8IG5hbWUgPT09IFwiZGF0YS1mcm9tXCIpIHtcclxuICAgIC8vICAgICAgICAgICAgY29uc3QgZm4gPSB0aGlzLmNvbXBpbGUoYXR0ci52YWx1ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIHRhZ0VsZW1lbnQuc2VsZWN0KGZuKTtcclxuICAgIC8vICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICBjb25zdCB0cGwgPSB0aGlzLmNvbXBpbGUoYXR0ci52YWx1ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIHRhZ0VsZW1lbnQuYXR0cihuYW1lLCB0cGwgfHwgYXR0ci52YWx1ZSk7XHJcblxyXG4gICAgLy8gICAgICAgICAgICAvLyBjb252ZW50aW9uc1xyXG4gICAgLy8gICAgICAgICAgICBpZiAoISF0YWdFbGVtZW50Lm5hbWUubWF0Y2goL15pbnB1dCQvaSkgJiZcclxuICAgIC8vICAgICAgICAgICAgICAgICEhYXR0ci5uYW1lLm1hdGNoKC9ebmFtZSQvaSkgJiZcclxuICAgIC8vICAgICAgICAgICAgICAgICF0YWdFbGVtZW50LmdldEF0dHJpYnV0ZShcInZhbHVlXCIpKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZUFjY2Vzc29yID0gdGhpcy5jb21waWxlKGB7eyAke2F0dHIudmFsdWV9IH19YCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB0YWdFbGVtZW50LmF0dHIoXCJ2YWx1ZVwiLCB2YWx1ZUFjY2Vzc29yKTtcclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgIH1cclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvL31cclxuXHJcbiAgICAvL2V4cG9ydCBmdW5jdGlvbiBpbXBvcnRWaWV3KHZpZXc6IHN0cmluZywgLi4uYXJncyk6IGFueSB7XHJcbiAgICAvLyAgICBpZiAoIShcImltcG9ydFwiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJsaW5rXCIpKSkge1xyXG4gICAgLy8gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkhUTUwgaW1wb3J0IGlzIG5vdCBzdXBwb3J0ZWQgaW4gdGhpcyBicm93c2VyXCIpO1xyXG4gICAgLy8gICAgfVxyXG5cclxuICAgIC8vICAgIHZhciBkZWZlcnJlZCA9IGRlZmVyKCk7XHJcbiAgICAvLyAgICB2YXIgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpbmsnKTtcclxuICAgIC8vICAgIGxpbmsucmVsID0gJ2ltcG9ydCc7XHJcbiAgICAvLyAgICBsaW5rLmhyZWYgPSB2aWV3O1xyXG4gICAgLy8gICAgbGluay5zZXRBdHRyaWJ1dGUoJ2FzeW5jJywgXCJcIik7IC8vIG1ha2UgaXQgYXN5bmMhXHJcbiAgICAvLyAgICBsaW5rLm9ubG9hZCA9IGUgPT4ge1xyXG4gICAgLy8gICAgICAgIHZhciBsaW5rID0gKDxhbnk+ZS50YXJnZXQpO1xyXG4gICAgLy8gICAgICAgIGRlZmVycmVkLm5vdGlmeShsaW5rLmltcG9ydC5xdWVyeVNlbGVjdG9yKFwidGVtcGxhdGVcIikpO1xyXG4gICAgLy8gICAgICAgIGxpbmsub25sb2FkID0gbnVsbDtcclxuICAgIC8vICAgIH1cclxuICAgIC8vICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQobGluayk7XHJcblxyXG4gICAgLy8gICAgcmV0dXJuIGRlZmVycmVkO1xyXG4gICAgLy99XHJcblxyXG4gICAgLy9mdW5jdGlvbiBkZWZlcigpIHtcclxuICAgIC8vICAgIHJldHVybiB7XHJcbiAgICAvLyAgICAgICAgdmFsdWU6IHZvaWQgMCxcclxuICAgIC8vICAgICAgICByZXNvbHZlcnM6IFtdLFxyXG4gICAgLy8gICAgICAgIG5vdGlmeSh2YWx1ZSkge1xyXG4gICAgLy8gICAgICAgICAgICBpZiAodmFsdWUgPT09IHZvaWQgMClcclxuICAgIC8vICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInVuZGVmaW5lZCByZXN1bHRcIik7XHJcblxyXG4gICAgLy8gICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7XHJcblxyXG4gICAgLy8gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMucmVzb2x2ZXJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB0aGlzLnJlc29sdmVyc1tpXS5jYWxsKG51bGwsIHZhbHVlKTtcclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgIH0sXHJcbiAgICAvLyAgICAgICAgdGhlbihyZXNvbHZlKSB7XHJcbiAgICAvLyAgICAgICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2b2lkIDApIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZXJzLnB1c2gocmVzb2x2ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICByZXNvbHZlLmNhbGwobnVsbCwgdGhpcy52YWx1ZSk7XHJcbiAgICAvLyAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICB9XHJcbiAgICAvLyAgICB9O1xyXG4gICAgLy99XHJcblxyXG4gICAgLy9leHBvcnQgZnVuY3Rpb24gYmluZChkb206IE5vZGUsIHN0b3JlKSB7XHJcblxyXG4gICAgLy8gICAgdmFyIGJpbmRlciA9IG5ldyBCaW5kZXIoW0NvcmUuTGlzdCwgQ29yZS5NYXRoLCBDb3JlLkRhdGVzXSk7XHJcblxyXG4gICAgLy8gICAgbGV0IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO1xyXG4gICAgLy8gICAgRG9tLmV4ZWN1dGVUZW1wbGF0ZShzdG9yZSwgYmluZGVyLnBhcnNlRG9tKGRvbSksIGZyYWdtZW50LCAwKTtcclxuICAgIC8vICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgLy8gICAgICAgIHZhciBjaGlsZCA9IGZyYWdtZW50LmNoaWxkTm9kZXNbaV07XHJcbiAgICAvLyAgICAgICAgQmluZGVyLmxpc3RlbihjaGlsZCwgc3RvcmUpO1xyXG4gICAgLy8gICAgfVxyXG5cclxuICAgIC8vICAgIHJldHVybiBmcmFnbWVudDtcclxuICAgIC8vfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gam9pbihzZXBhcmF0b3I6IHN0cmluZywgdmFsdWUpIHtcclxuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG4gICAgICAgIHJldHVybiB2YWx1ZS5sZW5ndGggPiAwID8gdmFsdWUuc29ydCgpLmpvaW4oc2VwYXJhdG9yKSA6IG51bGw7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdmFsdWU7XHJcbn1cclxuXHJcbiAgICAvLyBSZVNoYXJwZXIgcmVzdG9yZSBJbmNvbnNpc3RlbnROYW1pbmdcclxuIl19