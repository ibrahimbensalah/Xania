"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var reactive_1 = require("./reactive");
var fsharp_1 = require("./fsharp");
var Dom;
(function (Dom) {
    var document = window.document;
    var ContentBinding = (function (_super) {
        __extends(ContentBinding, _super);
        function ContentBinding(ast, parentInsert, children) {
            var _this = _super.call(this) || this;
            _this.ast = ast;
            _this.parentInsert = parentInsert;
            _this.children = children;
            _this.fragments = [];
            return _this;
        }
        ContentBinding.prototype.render = function () {
            var stream = this.ast === null ? [this.context] : fsharp_1.accept(this.ast, this, this.context);
            var offset = 0;
            for (var i = 0; i < stream.length; i++) {
                var context = stream[i];
                var fragment = null;
                for (var e = i; e < this.fragments.length; e++) {
                    var f = this.fragments[e];
                    if (f.context === context) {
                        fragment = f;
                        if (e !== i) {
                            this.fragments.splice(e, 1);
                        }
                    }
                }
                if (fragment === null) {
                    fragment = new ContentFragment(this, context, offset);
                }
                if (i < this.fragments.length) {
                    this.fragments.splice(i, 0, fragment);
                }
                else {
                    this.fragments.push(fragment);
                }
                offset += this.children.length;
            }
            return stream;
        };
        ContentBinding.prototype.text = function (ast, options) {
            var binding = new TextBinding(ast);
            options.fragment.insert(binding.dom, options.child);
            return binding;
        };
        ContentBinding.prototype.content = function (ast, children, options) {
            var binding = new ContentBinding(ast, function (dom) { return options.fragment.insert(dom, options.child); }, children);
            return binding;
        };
        ContentBinding.prototype.tag = function (tagName, ns, attrs, events, children, options) {
            var tag = new TagBinding(tagName, ns);
            for (var i = 0; i < attrs.length; i++) {
                tag.attr(attrs[i].name, attrs[i].tpl);
            }
            for (var e = 0; e < children.length; e++) {
                tag.child(children[e]);
            }
            options.fragment.insert(tag.dom, options.child);
            return tag;
        };
        return ContentBinding;
    }(reactive_1.Reactive.Binding));
    Dom.ContentBinding = ContentBinding;
    var ContentFragment = (function () {
        function ContentFragment(owner, context, offset) {
            this.owner = owner;
            this.context = context;
            this.offset = offset;
            this.bindings = [];
            for (var e = 0; e < owner.children.length; e++) {
                this.bindings[e] =
                    owner.children[e].accept(owner, { fragment: this, child: e }).update(context);
            }
        }
        ContentFragment.prototype.insert = function (dom, index) {
            this.owner.parentInsert(dom, this.offset + index);
        };
        return ContentFragment;
    }());
    var TextBinding = (function (_super) {
        __extends(TextBinding, _super);
        function TextBinding(parts) {
            var _this = _super.call(this) || this;
            _this.parts = parts;
            _this.dom = document.createTextNode("");
            return _this;
        }
        TextBinding.prototype.render = function (context) {
            var result = this.evaluate(this.parts, context);
            if (result === undefined) {
                this.dom.detach();
            }
            else {
                var newValue = result && result.valueOf();
                if (!!newValue && !!newValue.onNext) {
                    newValue.subscribe(this);
                }
                else {
                    this.onNext(newValue);
                }
            }
        };
        TextBinding.prototype.onNext = function (newValue) {
            this.dom.textContent = newValue;
        };
        TextBinding.prototype.evaluate = function (parts, context) {
            var _this = this;
            if (this.parts.length === 0)
                return "";
            if (this.parts.length === 1)
                return this.evaluatePart(this.parts[0], context);
            return this.parts.map(function (p) { return _this.evaluatePart(p, context); }).join("");
        };
        TextBinding.prototype.evaluatePart = function (part, context) {
            if (typeof part === "string")
                return part;
            else {
                return fsharp_1.accept(part, this, context);
            }
        };
        return TextBinding;
    }(reactive_1.Reactive.Binding));
    Dom.TextBinding = TextBinding;
    var TagBinding = (function (_super) {
        __extends(TagBinding, _super);
        function TagBinding(tagName, ns) {
            if (ns === void 0) { ns = null; }
            var _this = _super.call(this) || this;
            _this.ns = ns;
            _this.attributeBindings = [];
            _this.childBindings = [];
            _this.events = {};
            _this.appendChild = function (dom) { return _this.dom.appendChild(dom); };
            _this.classBinding = new ClassBinding(_this);
            if (ns === null)
                _this.dom = document.createElement(tagName);
            else {
                _this.dom = document.createElementNS(ns, tagName.toLowerCase());
            }
            _this.dom.attributes["__binding"] = _this;
            return _this;
        }
        TagBinding.prototype.attr = function (name, ast) {
            if (name === "class") {
                this.classBinding.setBaseClass(ast);
            }
            else if (name.startsWith("class.")) {
                this.classBinding.addClass(name.substr(6), ast);
            }
            else {
                var attrBinding = new AttributeBinding(this, name, ast);
                this.attributeBindings.push(attrBinding);
            }
            return this;
        };
        TagBinding.prototype.child = function (child) {
            if (!!this.context)
                child.update(this.context);
            this.childBindings.push(child);
            return this;
        };
        TagBinding.prototype.on = function (name, ast) {
            this.events[name] = ast;
            return this;
        };
        TagBinding.prototype.text = function (ast) {
            var binding = new TextBinding(ast);
            this.appendChild(binding.dom);
            return binding;
        };
        TagBinding.prototype.content = function (ast, children) {
            var binding = new ContentBinding(ast, this.appendChild, children);
            return binding;
        };
        TagBinding.prototype.update = function (context) {
            _super.prototype.update.call(this, context);
            this.classBinding.update(context);
            for (var i = 0; i < this.childBindings.length; i++) {
                this.childBindings[i].update(context);
            }
            for (var e = 0; e < this.attributeBindings.length; e++) {
                this.attributeBindings[e].update(context);
            }
            return this;
        };
        TagBinding.prototype.render = function (context) {
            return this.dom;
        };
        TagBinding.prototype.trigger = function (name) {
            var handler = this.events[name];
            if (!!handler) {
                var result = fsharp_1.accept(handler, this, this.context);
                if (typeof result === "function")
                    result();
            }
        };
        return TagBinding;
    }(reactive_1.Reactive.Binding));
    Dom.TagBinding = TagBinding;
    var ClassBinding = (function (_super) {
        __extends(ClassBinding, _super);
        function ClassBinding(parent) {
            var _this = _super.call(this) || this;
            _this.parent = parent;
            _this.conditions = [];
            return _this;
        }
        ClassBinding.prototype.setBaseClass = function (tpl) {
            this.baseClassTpl = tpl;
        };
        ClassBinding.prototype.addClass = function (className, condition) {
            this.conditions.push({ className: className, condition: condition });
        };
        ClassBinding.prototype.render = function (context) {
            this.context = context;
            var classes = [];
            if (!!this.baseClassTpl) {
                var value = fsharp_1.accept(this.baseClassTpl, this, context).valueOf();
                classes.push(value);
            }
            for (var i = 0; i < this.conditions.length; i++) {
                var _a = this.conditions[i], className = _a.className, condition = _a.condition;
                if (!!fsharp_1.accept(condition, this, context).valueOf()) {
                    classes.push(className);
                }
            }
            this.setAttribute("class", classes.length > 0 ? join(" ", classes) : null);
        };
        ClassBinding.prototype.setAttribute = function (attrName, newValue) {
            var oldValue = this.oldValue;
            var tag = this.parent.dom;
            if (typeof newValue === "undefined" || newValue === null) {
                tag[attrName] = void 0;
                tag.removeAttribute(attrName);
            }
            else {
                if (typeof oldValue === "undefined") {
                    var attr = document.createAttribute(attrName);
                    attr.value = newValue;
                    tag.setAttributeNode(attr);
                }
                else {
                    tag.className = newValue;
                }
            }
            this.oldValue = newValue;
        };
        return ClassBinding;
    }(reactive_1.Reactive.Binding));
    Dom.ClassBinding = ClassBinding;
    var AttributeBinding = (function (_super) {
        __extends(AttributeBinding, _super);
        function AttributeBinding(parent, name, tpl) {
            var _this = _super.call(this) || this;
            _this.parent = parent;
            _this.name = name;
            _this.tpl = tpl;
            return _this;
        }
        AttributeBinding.prototype.render = function (context) {
            this.context = context;
            var value = fsharp_1.accept(this.tpl, this, context);
            if (!!value && !!value.onNext) {
                value.subscribe(this);
            }
            else {
                this.onNext(value);
            }
        };
        AttributeBinding.prototype.onNext = function (value) {
            if (value !== null && value !== void 0 && !!value.valueOf)
                value = value.valueOf();
            var newValue;
            if (this.name === "checked") {
                newValue = !!value ? "checked" : null;
            }
            else {
                newValue = value;
            }
            var oldValue = this.oldValue;
            var attrName = this.name;
            var tag = this.parent.dom;
            if (typeof newValue === "undefined" || newValue === null) {
                tag[attrName] = void 0;
                tag.removeAttribute(attrName);
            }
            else {
                if (typeof oldValue === "undefined") {
                    var attr = document.createAttribute(attrName);
                    attr.value = newValue;
                    tag.setAttributeNode(attr);
                }
                else {
                    tag[attrName] = newValue;
                    tag.setAttribute(attrName, newValue);
                }
            }
            this.oldValue = newValue;
        };
        return AttributeBinding;
    }(reactive_1.Reactive.Binding));
    Dom.AttributeBinding = AttributeBinding;
})(Dom = exports.Dom || (exports.Dom = {}));
function join(separator, value) {
    if (Array.isArray(value)) {
        return value.length > 0 ? value.sort().join(separator) : null;
    }
    return value;
}
exports.join = join;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2RvbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSx1Q0FBMkM7QUFDM0MsbUNBQWlDO0FBR2pDLElBQWMsR0FBRyxDQWlsQmhCO0FBamxCRCxXQUFjLEdBQUc7SUFFYixJQUFJLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDO0lBSy9CO1FBQW9DLGtDQUFVO1FBRzFDLHdCQUFvQixHQUFHLEVBQVMsWUFBNEMsRUFBUyxRQUEwQjtZQUEvRyxZQUNJLGlCQUFPLFNBQ1Y7WUFGbUIsU0FBRyxHQUFILEdBQUcsQ0FBQTtZQUFTLGtCQUFZLEdBQVosWUFBWSxDQUFnQztZQUFTLGNBQVEsR0FBUixRQUFRLENBQWtCO1lBRnZHLGVBQVMsR0FBc0IsRUFBRSxDQUFDOztRQUkxQyxDQUFDO1FBRUQsK0JBQU0sR0FBTjtZQUNJLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLEtBQUssSUFBSSxHQUFHLENBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBRSxHQUFHLGVBQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFekYsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2YsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3JDLElBQUksT0FBTyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFFeEIsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDO2dCQUNwQixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7b0JBQzdDLElBQUksQ0FBQyxH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OUMsSUFBSSxDQUFDLEtBQUssR0FBRyxRQUFRLENBQUM7b0JBQ3RCLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDL0IsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDSixHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsUUFBUSxDQUFDO29CQUN6QixHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDekMsQ0FBQztZQUNMLENBQUM7WUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUM3QixDQUFDO1FBQ0wsdUJBQUM7SUFBRCxDQUFDLEFBakRELENBQXNDLG1CQUFFLENBQUMsT0FBTyxHQWlEL0M7SUFqRFksb0JBQWdCLG1CQWlENUIsQ0FBQTtBQXFRTCxDQUFDLEVBamxCYSxHQUFHLEdBQUgsV0FBRyxLQUFILFdBQUcsUUFpbEJoQjtBQUVELGNBQXFCLFNBQWlCLEVBQUUsS0FBSztJQUN6QyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2QixNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDbEUsQ0FBQztJQUNELE1BQU0sQ0FBQyxLQUFLLENBQUM7QUFDakIsQ0FBQztBQUxELG9CQUtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29yZSB9IGZyb20gJy4vY29yZSdcclxuaW1wb3J0IHsgUmVhY3RpdmUgYXMgUmUgfSBmcm9tICcuL3JlYWN0aXZlJ1xyXG5pbXBvcnQgeyBhY2NlcHQgfSBmcm9tICcuL2ZzaGFycCdcclxuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tICcuL3RlbXBsYXRlJ1xyXG5cclxuZXhwb3J0IG1vZHVsZSBEb20ge1xyXG5cclxuICAgIHZhciBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDtcclxuXHJcbiAgICBpbnRlcmZhY2UgSVZpc2l0b3IgZXh0ZW5kcyBUZW1wbGF0ZS5JVmlzaXRvcjxSZS5CaW5kaW5nPiB7XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGNsYXNzIENvbnRlbnRCaW5kaW5nIGV4dGVuZHMgUmUuQmluZGluZyBpbXBsZW1lbnRzIElWaXNpdG9yIHtcclxuICAgICAgICBwcml2YXRlIGZyYWdtZW50czogQ29udGVudEZyYWdtZW50W10gPSBbXTtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSBhc3QsIHB1YmxpYyBwYXJlbnRJbnNlcnQ6IChuOiBOb2RlLCBpZHg6IG51bWJlcikgPT4gdm9pZCwgcHVibGljIGNoaWxkcmVuOiBUZW1wbGF0ZS5JTm9kZVtdKSB7XHJcbiAgICAgICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZW5kZXIoKSB7XHJcbiAgICAgICAgICAgIHZhciBzdHJlYW0gPSB0aGlzLmFzdCA9PT0gbnVsbCA/IFsgdGhpcy5jb250ZXh0IF0gOiBhY2NlcHQodGhpcy5hc3QsIHRoaXMsIHRoaXMuY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICB2YXIgb2Zmc2V0ID0gMDtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzdHJlYW0ubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gc3RyZWFtW2ldO1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciBmcmFnbWVudCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBlID0gaTsgZSA8IHRoaXMuZnJhZ21lbnRzLmxlbmd0aDsgZSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGYgPSB0aGlzLmZyYWdtZW50c1tlXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZi5jb250ZXh0ID09PSBjb250ZXh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyYWdtZW50ID0gZjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUgIT09IGkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8qIGZvdW5kIGZyYWdtZW50IGF0IGUgYnkgc2hvdWxkIGJlIGxvY2F0ZWQgYXQgaSAqL1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFnbWVudHMuc3BsaWNlKGUsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChmcmFnbWVudCA9PT0gbnVsbCAvKiBub3QgZm91bmQgKi8pIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZnJhZ21lbnQgPSBuZXcgQ29udGVudEZyYWdtZW50KHRoaXMsIGNvbnRleHQsIG9mZnNldCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGkgPCB0aGlzLmZyYWdtZW50cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYWdtZW50cy5zcGxpY2UoaSwgMCwgZnJhZ21lbnQpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYWdtZW50cy5wdXNoKGZyYWdtZW50KTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBvZmZzZXQgKz0gdGhpcy5jaGlsZHJlbi5sZW5ndGg7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBzdHJlYW07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgdGV4dChhc3QsIG9wdGlvbnM6IHsgZnJhZ21lbnQ6IENvbnRlbnRGcmFnbWVudCwgY2hpbGQ6IG51bWJlciB9KTogVGV4dEJpbmRpbmcge1xyXG4gICAgICAgICAgICB2YXIgYmluZGluZyA9IG5ldyBUZXh0QmluZGluZyhhc3QpO1xyXG4gICAgICAgICAgICBvcHRpb25zLmZyYWdtZW50Lmluc2VydChiaW5kaW5nLmRvbSwgb3B0aW9ucy5jaGlsZCk7XHJcbiAgICAgICAgICAgIHJldHVybiBiaW5kaW5nO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIGNvbnRlbnQoYXN0LCBjaGlsZHJlbiwgb3B0aW9uczogeyBmcmFnbWVudDogQ29udGVudEZyYWdtZW50LCBjaGlsZDogbnVtYmVyIH0pOiBDb250ZW50QmluZGluZyB7XHJcbiAgICAgICAgICAgIHZhciBiaW5kaW5nID0gbmV3IENvbnRlbnRCaW5kaW5nKGFzdCwgZG9tID0+IG9wdGlvbnMuZnJhZ21lbnQuaW5zZXJ0KGRvbSwgb3B0aW9ucy5jaGlsZCksIGNoaWxkcmVuKTtcclxuICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgdGFnKHRhZ05hbWU6IHN0cmluZywgbnM6IHN0cmluZywgYXR0cnMsIGV2ZW50cywgY2hpbGRyZW46IFJlLkJpbmRpbmdbXSwgb3B0aW9uczogYW55KSA6IFRhZ0JpbmRpbmcge1xyXG4gICAgICAgICAgICB2YXIgdGFnID0gbmV3IFRhZ0JpbmRpbmcodGFnTmFtZSwgbnMpO1xyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhdHRycy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdGFnLmF0dHIoYXR0cnNbaV0ubmFtZSwgYXR0cnNbaV0udHBsKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgZSA9IDA7IGUgPCBjaGlsZHJlbi5sZW5ndGg7IGUrKykge1xyXG4gICAgICAgICAgICAgICAgdGFnLmNoaWxkKGNoaWxkcmVuW2VdKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgb3B0aW9ucy5mcmFnbWVudC5pbnNlcnQodGFnLmRvbSwgb3B0aW9ucy5jaGlsZCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdGFnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjbGFzcyBDb250ZW50RnJhZ21lbnQge1xyXG4gICAgICAgIHB1YmxpYyBiaW5kaW5nczogUmUuQmluZGluZ1tdID0gW107XHJcblxyXG4gICAgICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgb3duZXI6IENvbnRlbnRCaW5kaW5nLCBwdWJsaWMgY29udGV4dCwgcHJpdmF0ZSBvZmZzZXQ6IG51bWJlcikge1xyXG4gICAgICAgICAgICBmb3IgKHZhciBlID0gMDsgZSA8IG93bmVyLmNoaWxkcmVuLmxlbmd0aDsgZSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmJpbmRpbmdzW2VdID1cclxuICAgICAgICAgICAgICAgICAgICBvd25lci5jaGlsZHJlbltlXS5hY2NlcHQob3duZXIgYXMgSVZpc2l0b3IsIHsgZnJhZ21lbnQ6IHRoaXMsIGNoaWxkOiBlIH0pLnVwZGF0ZShjb250ZXh0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaW5zZXJ0KGRvbSwgaW5kZXgpIHtcclxuICAgICAgICAgICAgdGhpcy5vd25lci5wYXJlbnRJbnNlcnQoZG9tLCB0aGlzLm9mZnNldCArIGluZGV4KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGNsYXNzIFRleHRCaW5kaW5nIGV4dGVuZHMgUmUuQmluZGluZyB7XHJcbiAgICAgICAgcHVibGljIGRvbTtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSBwYXJ0cykge1xyXG4gICAgICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgICAgICB0aGlzLmRvbSA9ICg8YW55PmRvY3VtZW50KS5jcmVhdGVUZXh0Tm9kZShcIlwiKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlbmRlcihjb250ZXh0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZXZhbHVhdGUodGhpcy5wYXJ0cywgY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tLmRldGFjaCgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gcmVzdWx0ICYmIHJlc3VsdC52YWx1ZU9mKCk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKCEhbmV3VmFsdWUgJiYgISFuZXdWYWx1ZS5vbk5leHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZS5zdWJzY3JpYmUodGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25OZXh0KG5ld1ZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgb25OZXh0KG5ld1ZhbHVlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZG9tLnRleHRDb250ZW50ID0gbmV3VmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBldmFsdWF0ZShwYXJ0cywgY29udGV4dCk6IGFueSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnBhcnRzLmxlbmd0aCA9PT0gMClcclxuICAgICAgICAgICAgICAgIHJldHVybiBcIlwiO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMucGFydHMubGVuZ3RoID09PSAxKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdGVQYXJ0KHRoaXMucGFydHNbMF0sIGNvbnRleHQpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFydHMubWFwKHAgPT4gdGhpcy5ldmFsdWF0ZVBhcnQocCwgY29udGV4dCkpLmpvaW4oXCJcIik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBldmFsdWF0ZVBhcnQocGFydDogYW55LCBjb250ZXh0KSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFydCA9PT0gXCJzdHJpbmdcIilcclxuICAgICAgICAgICAgICAgIHJldHVybiBwYXJ0O1xyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhY2NlcHQocGFydCwgdGhpcywgY29udGV4dCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZXhwb3J0IGNsYXNzIFRhZ0JpbmRpbmcgZXh0ZW5kcyBSZS5CaW5kaW5nIGltcGxlbWVudHMgSVZpc2l0b3Ige1xyXG4gICAgICAgIHB1YmxpYyBkb207XHJcbiAgICAgICAgcHJpdmF0ZSBhdHRyaWJ1dGVCaW5kaW5ncyA9IFtdO1xyXG4gICAgICAgIHByaXZhdGUgY2hpbGRCaW5kaW5nczogUmUuQmluZGluZ1tdID0gW107XHJcbiAgICAgICAgcHJpdmF0ZSBldmVudHMgPSB7fTtcclxuICAgICAgICBwcml2YXRlIGFwcGVuZENoaWxkID0gZG9tID0+IHRoaXMuZG9tLmFwcGVuZENoaWxkKGRvbSk7XHJcbiAgICAgICAgcHJpdmF0ZSBjbGFzc0JpbmRpbmcgPSBuZXcgQ2xhc3NCaW5kaW5nKHRoaXMpO1xyXG5cclxuICAgICAgICBjb25zdHJ1Y3Rvcih0YWdOYW1lOiBzdHJpbmcsIHByaXZhdGUgbnM6IHN0cmluZyA9IG51bGwpIHtcclxuICAgICAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICAgICAgaWYgKG5zID09PSBudWxsKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5kb20gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpO1xyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZG9tID0gKDxhbnk+ZG9jdW1lbnQpLmNyZWF0ZUVsZW1lbnROUyhucywgdGFnTmFtZS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5kb20uYXR0cmlidXRlc1tcIl9fYmluZGluZ1wiXSA9IHRoaXM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBhdHRyKG5hbWUsIGFzdCk6IHRoaXMge1xyXG4gICAgICAgICAgICBpZiAobmFtZSA9PT0gXCJjbGFzc1wiKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsYXNzQmluZGluZy5zZXRCYXNlQ2xhc3MoYXN0KTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lLnN0YXJ0c1dpdGgoXCJjbGFzcy5cIikpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY2xhc3NCaW5kaW5nLmFkZENsYXNzKG5hbWUuc3Vic3RyKDYpLCBhc3QpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFyIGF0dHJCaW5kaW5nID0gbmV3IEF0dHJpYnV0ZUJpbmRpbmcodGhpcywgbmFtZSwgYXN0KTtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlQmluZGluZ3MucHVzaChhdHRyQmluZGluZyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2hpbGQoY2hpbGQ6IFJlLkJpbmRpbmcpOiB0aGlzIHtcclxuICAgICAgICAgICAgaWYgKCEhdGhpcy5jb250ZXh0KVxyXG4gICAgICAgICAgICAgICAgY2hpbGQudXBkYXRlKHRoaXMuY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNoaWxkQmluZGluZ3MucHVzaChjaGlsZCk7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgb24obmFtZSwgYXN0KSA6IHRoaXMge1xyXG4gICAgICAgICAgICB0aGlzLmV2ZW50c1tuYW1lXSA9IGFzdDtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIHRleHQoYXN0KTogVGV4dEJpbmRpbmcge1xyXG4gICAgICAgICAgICB2YXIgYmluZGluZyA9IG5ldyBUZXh0QmluZGluZyhhc3QpO1xyXG4gICAgICAgICAgICB0aGlzLmFwcGVuZENoaWxkKGJpbmRpbmcuZG9tKTtcclxuICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgY29udGVudChhc3QsIGNoaWxkcmVuOiBUZW1wbGF0ZS5JTm9kZVtdKTogQ29udGVudEJpbmRpbmcge1xyXG4gICAgICAgICAgICB2YXIgYmluZGluZyA9IG5ldyBDb250ZW50QmluZGluZyhhc3QsIHRoaXMuYXBwZW5kQ2hpbGQsIGNoaWxkcmVuKTtcclxuICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB1cGRhdGUoY29udGV4dCk6IHRoaXMge1xyXG4gICAgICAgICAgICBzdXBlci51cGRhdGUoY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNsYXNzQmluZGluZy51cGRhdGUoY29udGV4dCk7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5jaGlsZEJpbmRpbmdzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNoaWxkQmluZGluZ3NbaV0udXBkYXRlKGNvbnRleHQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmb3IgKHZhciBlID0gMDsgZSA8IHRoaXMuYXR0cmlidXRlQmluZGluZ3MubGVuZ3RoOyBlKyspIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlQmluZGluZ3NbZV0udXBkYXRlKGNvbnRleHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVuZGVyKGNvbnRleHQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZG9tO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdHJpZ2dlcihuYW1lKSB7XHJcbiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gdGhpcy5ldmVudHNbbmFtZV07XHJcbiAgICAgICAgICAgIGlmICghIWhhbmRsZXIpIHtcclxuICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBhY2NlcHQoaGFuZGxlciwgdGhpcywgdGhpcy5jb250ZXh0KTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlc3VsdCA9PT0gXCJmdW5jdGlvblwiKVxyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGV4cG9ydCBjbGFzcyBDbGFzc0JpbmRpbmcgZXh0ZW5kcyBSZS5CaW5kaW5nIHtcclxuICAgICAgICBwdWJsaWMgZG9tO1xyXG4gICAgICAgIHByaXZhdGUgY29uZGl0aW9ucyA9IFtdO1xyXG4gICAgICAgIHByaXZhdGUgb2xkVmFsdWU7XHJcbiAgICAgICAgcHJpdmF0ZSBiYXNlQ2xhc3NUcGw7XHJcblxyXG4gICAgICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcGFyZW50OiBUYWdCaW5kaW5nKSB7XHJcbiAgICAgICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzZXRCYXNlQ2xhc3ModHBsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYmFzZUNsYXNzVHBsID0gdHBsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYWRkQ2xhc3MoY2xhc3NOYW1lLCBjb25kaXRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5jb25kaXRpb25zLnB1c2goeyBjbGFzc05hbWUsIGNvbmRpdGlvbiB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlbmRlcihjb250ZXh0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7XHJcbiAgICAgICAgICAgIGNvbnN0IGNsYXNzZXMgPSBbXTtcclxuICAgICAgICAgICAgaWYgKCEhdGhpcy5iYXNlQ2xhc3NUcGwpIHtcclxuICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGFjY2VwdCh0aGlzLmJhc2VDbGFzc1RwbCwgdGhpcywgY29udGV4dCkudmFsdWVPZigpO1xyXG4gICAgICAgICAgICAgICAgY2xhc3Nlcy5wdXNoKHZhbHVlKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNvbmRpdGlvbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHZhciB7IGNsYXNzTmFtZSwgY29uZGl0aW9uIH0gPSB0aGlzLmNvbmRpdGlvbnNbaV07XHJcbiAgICAgICAgICAgICAgICBpZiAoISFhY2NlcHQoY29uZGl0aW9uLCB0aGlzLCBjb250ZXh0KS52YWx1ZU9mKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGFzc2VzLnB1c2goY2xhc3NOYW1lKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoXCJjbGFzc1wiLCBjbGFzc2VzLmxlbmd0aCA+IDAgPyBqb2luKFwiIFwiLCBjbGFzc2VzKSA6IG51bGwpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcHVibGljIHNldEF0dHJpYnV0ZShhdHRyTmFtZTogc3RyaW5nLCBuZXdWYWx1ZSkge1xyXG4gICAgICAgICAgICB2YXIgb2xkVmFsdWUgPSB0aGlzLm9sZFZhbHVlO1xyXG5cclxuICAgICAgICAgICAgdmFyIHRhZyA9IHRoaXMucGFyZW50LmRvbTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdWYWx1ZSA9PT0gXCJ1bmRlZmluZWRcIiB8fCBuZXdWYWx1ZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdGFnW2F0dHJOYW1lXSA9IHZvaWQgMDtcclxuICAgICAgICAgICAgICAgIHRhZy5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvbGRWYWx1ZSA9PT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhdHRyID0gZG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKGF0dHJOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBhdHRyLnZhbHVlID0gbmV3VmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFnLnNldEF0dHJpYnV0ZU5vZGUoYXR0cik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRhZy5jbGFzc05hbWUgPSBuZXdWYWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLm9sZFZhbHVlID0gbmV3VmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgY2xhc3MgQXR0cmlidXRlQmluZGluZyBleHRlbmRzIFJlLkJpbmRpbmcge1xyXG4gICAgICAgIHB1YmxpYyBkb207XHJcbiAgICAgICAgcHJpdmF0ZSBvbGRWYWx1ZTtcclxuXHJcbiAgICAgICAgY29uc3RydWN0b3IocHJpdmF0ZSBwYXJlbnQ6IFRhZ0JpbmRpbmcsIHByaXZhdGUgbmFtZSwgcHJpdmF0ZSB0cGwpIHtcclxuICAgICAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlbmRlcihjb250ZXh0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7XHJcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGFjY2VwdCh0aGlzLnRwbCwgdGhpcywgY29udGV4dCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoISF2YWx1ZSAmJiAhIXZhbHVlLm9uTmV4dCkge1xyXG4gICAgICAgICAgICAgICAgdmFsdWUuc3Vic2NyaWJlKHRoaXMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbk5leHQodmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwdWJsaWMgb25OZXh0KHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdm9pZCAwICYmICEhdmFsdWUudmFsdWVPZilcclxuICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudmFsdWVPZigpO1xyXG5cclxuICAgICAgICAgICAgdmFyIG5ld1ZhbHVlO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5uYW1lID09PSBcImNoZWNrZWRcIikge1xyXG4gICAgICAgICAgICAgICAgbmV3VmFsdWUgPSAhIXZhbHVlID8gXCJjaGVja2VkXCIgOiBudWxsO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbmV3VmFsdWUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdmFyIG9sZFZhbHVlID0gdGhpcy5vbGRWYWx1ZTtcclxuXHJcbiAgICAgICAgICAgIHZhciBhdHRyTmFtZSA9IHRoaXMubmFtZTtcclxuICAgICAgICAgICAgdmFyIHRhZyA9IHRoaXMucGFyZW50LmRvbTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdWYWx1ZSA9PT0gXCJ1bmRlZmluZWRcIiB8fCBuZXdWYWx1ZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdGFnW2F0dHJOYW1lXSA9IHZvaWQgMDtcclxuICAgICAgICAgICAgICAgIHRhZy5yZW1vdmVBdHRyaWJ1dGUoYXR0ck5hbWUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvbGRWYWx1ZSA9PT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBhdHRyID0gZG9jdW1lbnQuY3JlYXRlQXR0cmlidXRlKGF0dHJOYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBhdHRyLnZhbHVlID0gbmV3VmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFnLnNldEF0dHJpYnV0ZU5vZGUoYXR0cik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRhZ1thdHRyTmFtZV0gPSBuZXdWYWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB0YWcuc2V0QXR0cmlidXRlKGF0dHJOYW1lLCBuZXdWYWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5vbGRWYWx1ZSA9IG5ld1ZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvL2NsYXNzIFJlYWN0aXZlQmluZGluZyBleHRlbmRzIERvbUJpbmRpbmcge1xyXG4gICAgLy8gICAgcHJpdmF0ZSBiaW5kaW5ncyA9IFtdO1xyXG4gICAgLy8gICAgcHJpdmF0ZSBzdHJlYW07XHJcbiAgICAvLyAgICBwcml2YXRlIGxlbmd0aDtcclxuXHJcbiAgICAvLyAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRwbDogVGVtcGxhdGUuSU5vZGUsIHByaXZhdGUgdGFyZ2V0LCBwcml2YXRlIG9mZnNldCkge1xyXG4gICAgLy8gICAgICAgIHN1cGVyKCk7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgcmVuZGVyKGNvbnRleHQpIHtcclxuICAgIC8vICAgICAgICB2YXIgeyBiaW5kaW5ncywgdGFyZ2V0LCB0cGwgfSA9IHRoaXM7XHJcbiAgICAvLyAgICAgICAgaWYgKCEhdHBsLm1vZGVsQWNjZXNzb3IpIHtcclxuICAgIC8vICAgICAgICAgICAgdmFyIHN0cmVhbSA9IHRwbC5tb2RlbEFjY2Vzc29yLmV4ZWN1dGUoY29udGV4dCwgdGhpcyk7XHJcbiAgICAvLyAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMDtcclxuXHJcbiAgICAvLyAgICAgICAgICAgIHN0cmVhbS5mb3JFYWNoKChjdHgsIGlkeCkgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgdGhpcy5sZW5ndGggPSBpZHggKyAxO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBiaW5kaW5ncy5sZW5ndGg7IGkrKykge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHZhciBiaW5kaW5nID0gYmluZGluZ3NbaV07XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgaWYgKGJpbmRpbmcuY29udGV4dC52YWx1ZSA9PT0gY3R4LnZhbHVlKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpICE9PSBpZHgpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzW2ldID0gYmluZGluZ3NbaWR4XTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpbmRpbmdzW2lkeF0gPSBiaW5kaW5nO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgICAgICB0aGlzLmV4ZWN1dGUoY3R4LCBpZHgpO1xyXG4gICAgLy8gICAgICAgICAgICB9KTtcclxuICAgIC8vICAgICAgICB9IGVsc2Uge1xyXG4gICAgLy8gICAgICAgICAgICB0aGlzLmV4ZWN1dGUoY29udGV4dCwgMCk7XHJcbiAgICAvLyAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMTtcclxuICAgIC8vICAgICAgICB9XHJcblxyXG4gICAgLy8gICAgICAgIHdoaWxlIChiaW5kaW5ncy5sZW5ndGggPiB0aGlzLmxlbmd0aCkge1xyXG4gICAgLy8gICAgICAgICAgICBjb25zdCBvbGRCaW5kaW5nID0gYmluZGluZ3MucG9wKCk7XHJcbiAgICAvLyAgICAgICAgICAgIHRhcmdldC5yZW1vdmVDaGlsZChvbGRCaW5kaW5nLmRvbSk7XHJcbiAgICAvLyAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvLyAgICBleGVjdXRlKHJlc3VsdCwgaWR4KSB7XHJcbiAgICAvLyAgICAgICAgdGhpcy5hZGRCaW5kaW5nKHRoaXMudHBsLmJpbmQocmVzdWx0KSwgaWR4KTtcclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvLyAgICBhZGRCaW5kaW5nKG5ld0JpbmRpbmcsIGlkeCkge1xyXG4gICAgLy8gICAgICAgIHZhciB7IG9mZnNldCwgdGFyZ2V0LCBiaW5kaW5ncyB9ID0gdGhpcztcclxuICAgIC8vICAgICAgICB2YXIgaW5zZXJ0QXQgPSBvZmZzZXQgKyBpZHg7XHJcblxyXG4gICAgLy8gICAgICAgIGlmIChpbnNlcnRBdCA8IHRhcmdldC5jaGlsZE5vZGVzLmxlbmd0aCkge1xyXG4gICAgLy8gICAgICAgICAgICB2YXIgYmVmb3JlRWxlbWVudCA9IHRhcmdldC5jaGlsZE5vZGVzW2luc2VydEF0XTtcclxuICAgIC8vICAgICAgICAgICAgdGFyZ2V0Lmluc2VydEJlZm9yZShuZXdCaW5kaW5nLmRvbSwgYmVmb3JlRWxlbWVudCk7XHJcbiAgICAvLyAgICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgdGFyZ2V0LmFwcGVuZENoaWxkKG5ld0JpbmRpbmcuZG9tKTtcclxuICAgIC8vICAgICAgICB9XHJcblxyXG4gICAgLy8gICAgICAgIGJpbmRpbmdzLnNwbGljZShpZHgsIDAsIG5ld0JpbmRpbmcpO1xyXG4gICAgLy8gICAgfVxyXG4gICAgLy99XHJcblxyXG4gICAgLy9leHBvcnQgZnVuY3Rpb24gZXhlY3V0ZVRlbXBsYXRlKG9ic2VydmFibGUsIHRwbDogVGVtcGxhdGUuSU5vZGUsIHRhcmdldCwgb2Zmc2V0KSB7XHJcbiAgICAvLyAgICByZXR1cm4gbmV3IFJlYWN0aXZlQmluZGluZyh0cGwsIHRhcmdldCwgb2Zmc2V0KS51cGRhdGUob2JzZXJ2YWJsZSk7XHJcbiAgICAvL31cclxuXHJcbiAgICAvL2NsYXNzIEJpbmRlciB7XHJcbiAgICAvLyAgICBwcml2YXRlIGNvbXBpbGU6IEZ1bmN0aW9uO1xyXG4gICAgLy8gICAgcHJpdmF0ZSBjb21waWxlcjogQXN0LkNvbXBpbGVyO1xyXG4gICAgLy8gICAgcHVibGljIGNvbnRleHRzOiBEYXRhNC5JVmFsdWVbXSA9IFtdO1xyXG5cclxuICAgIC8vICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbGliczogYW55W10pIHtcclxuICAgIC8vICAgICAgICB0aGlzLmNvbXBpbGVyID0gbmV3IEFzdC5Db21waWxlcigpO1xyXG4gICAgLy8gICAgICAgIHRoaXMuY29tcGlsZSA9IHRoaXMuY29tcGlsZXIudGVtcGxhdGUuYmluZCh0aGlzLmNvbXBpbGVyKTtcclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvLyAgICBzdGF0aWMgbGlzdGVuKHRhcmdldCwgc3RvcmU6IERhdGE1LlN0b3JlKSB7XHJcbiAgICAvLyAgICAgICAgdmFyIGV2ZW50SGFuZGxlciA9ICh0YXJnZXQsIG5hbWUpID0+IHtcclxuICAgIC8vICAgICAgICAgICAgdmFyIGJpbmRpbmcgPSB0YXJnZXQuYXR0cmlidXRlc1tcIl9fYmluZGluZ1wiXTtcclxuICAgIC8vICAgICAgICAgICAgaWYgKCEhYmluZGluZykge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgYmluZGluZy50cmlnZ2VyKG5hbWUpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgc3RvcmUudXBkYXRlKCk7XHJcbiAgICAvLyAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICB9O1xyXG5cclxuICAgIC8vICAgICAgICB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIGV2dCA9PiBldmVudEhhbmRsZXIoZXZ0LnRhcmdldCwgZXZ0LnR5cGUpKTtcclxuXHJcbiAgICAvLyAgICAgICAgY29uc3Qgb25jaGFuZ2UgPSBldnQgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICB2YXIgYmluZGluZyA9IGV2dC50YXJnZXQuYXR0cmlidXRlc1tcIl9fYmluZGluZ1wiXTtcclxuICAgIC8vICAgICAgICAgICAgaWYgKGJpbmRpbmcgIT0gbnVsbCkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgY29uc3QgbmFtZUF0dHIgPSBldnQudGFyZ2V0LmF0dHJpYnV0ZXNbXCJuYW1lXCJdO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgaWYgKCEhbmFtZUF0dHIpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICB2YXIgYXJyID0gbmFtZUF0dHIudmFsdWUuc3BsaXQoJy4nKTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICB2YXIgY29udGV4dCA9IGJpbmRpbmcuY29udGV4dDtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyci5sZW5ndGg7IGkrKykge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcCA9IGFycltpXTtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQuZ2V0KHApO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgICAgICAgICBjb250ZXh0LnNldChldnQudGFyZ2V0LnZhbHVlKTtcclxuXHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgc3RvcmUudXBkYXRlKCk7XHJcbiAgICAvLyAgICAgICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICB9O1xyXG4gICAgLy8gICAgICAgIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKFwia2V5dXBcIixcclxuICAgIC8vICAgICAgICAgICAgZXZ0ID0+IHtcclxuICAgIC8vICAgICAgICAgICAgICAgIGlmIChldnQua2V5Q29kZSA9PT0gMTMpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICBldmVudEhhbmRsZXIoZXZ0LnRhcmdldCwgXCJrZXl1cC5lbnRlclwiKTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgb25jaGFuZ2UoZXZ0KTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgfSk7XHJcbiAgICAvLyAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZW92ZXJcIixcclxuICAgIC8vICAgICAgICAgICAgZXZ0ID0+IHtcclxuICAgIC8vICAgICAgICAgICAgICAgIGV2ZW50SGFuZGxlcihldnQudGFyZ2V0LCBcIm1vdXNlb3ZlclwiKTtcclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICk7XHJcbiAgICAvLyAgICAgICAgdGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZW91dFwiLFxyXG4gICAgLy8gICAgICAgICAgICBldnQgPT4ge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgZXZlbnRIYW5kbGVyKGV2dC50YXJnZXQsIFwibW91c2VvdXRcIik7XHJcbiAgICAvLyAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICApO1xyXG4gICAgLy8gICAgfVxyXG5cclxuICAgIC8vICAgIHB1YmxpYyB1cGRhdGUyKCkge1xyXG4gICAgLy8gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jb250ZXh0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgLy8gICAgICAgICAgICB2YXIgY3R4ID0gdGhpcy5jb250ZXh0c1tpXTtcclxuICAgIC8vICAgICAgICAgICAgY3R4LnVwZGF0ZShudWxsKTtcclxuICAgIC8vICAgICAgICB9XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgcGFyc2VEb20ocm9vdERvbTogTm9kZSk6IFRlbXBsYXRlLklOb2RlIHtcclxuICAgIC8vICAgICAgICBjb25zdCBzdGFjayA9IFtdO1xyXG4gICAgLy8gICAgICAgIGxldCBpOiBudW1iZXI7XHJcbiAgICAvLyAgICAgICAgdmFyIHJvb3RUcGw7XHJcbiAgICAvLyAgICAgICAgc3RhY2sucHVzaCh7XHJcbiAgICAvLyAgICAgICAgICAgIG5vZGU6IHJvb3REb20sXHJcbiAgICAvLyAgICAgICAgICAgIHB1c2goZSkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgcm9vdFRwbCA9IGU7XHJcbiAgICAvLyAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICB9KTtcclxuXHJcbiAgICAvLyAgICAgICAgd2hpbGUgKHN0YWNrLmxlbmd0aCA+IDApIHtcclxuICAgIC8vICAgICAgICAgICAgY29uc3QgY3VyID0gc3RhY2sucG9wKCk7XHJcbiAgICAvLyAgICAgICAgICAgIGNvbnN0IG5vZGU6IE5vZGUgPSBjdXIubm9kZTtcclxuICAgIC8vICAgICAgICAgICAgY29uc3QgcHVzaCA9IGN1ci5wdXNoO1xyXG5cclxuICAgIC8vICAgICAgICAgICAgaWYgKCEhbm9kZVtcImNvbnRlbnRcIl0pIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIGNvbnN0IGVsdCA9IDxIVE1MRWxlbWVudD5ub2RlW1wiY29udGVudFwiXTtcclxuICAgIC8vICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IG5ldyBUZW1wbGF0ZS5Db250ZW50VGVtcGxhdGUoKTtcclxuICAgIC8vICAgICAgICAgICAgICAgIGZvciAoaSA9IGVsdC5jaGlsZE5vZGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaCh7IG5vZGU6IGVsdC5jaGlsZE5vZGVzW2ldLCBwdXNoOiB0ZW1wbGF0ZS5hZGRDaGlsZC5iaW5kKHRlbXBsYXRlKSB9KTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgICAgIHB1c2godGVtcGxhdGUpO1xyXG4gICAgLy8gICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIGNvbnN0IGVsdCA9IDxIVE1MRWxlbWVudD5ub2RlO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUuVGFnVGVtcGxhdGUoZWx0LnRhZ05hbWUsIGVsdC5uYW1lc3BhY2VVUkkpO1xyXG5cclxuICAgIC8vICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7ICEhZWx0LmF0dHJpYnV0ZXMgJiYgaSA8IGVsdC5hdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IGVsdC5hdHRyaWJ1dGVzW2ldO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHRoaXMucGFyc2VBdHRyKHRlbXBsYXRlLCBhdHRyaWJ1dGUpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICAgICAgICAgIGZvciAoaSA9IGVsdC5jaGlsZE5vZGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XHJcbiAgICAvLyAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaCh7IG5vZGU6IGVsdC5jaGlsZE5vZGVzW2ldLCBwdXNoOiB0ZW1wbGF0ZS5hZGRDaGlsZC5iaW5kKHRlbXBsYXRlKSB9KTtcclxuICAgIC8vICAgICAgICAgICAgICAgIH1cclxuICAgIC8vICAgICAgICAgICAgICAgIHB1c2godGVtcGxhdGUpO1xyXG4gICAgLy8gICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUubm9kZVR5cGUgPT09IDMpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIHZhciB0ZXh0Q29udGVudCA9IG5vZGUudGV4dENvbnRlbnQ7XHJcbiAgICAvLyAgICAgICAgICAgICAgICBpZiAodGV4dENvbnRlbnQudHJpbSgpLmxlbmd0aCA+IDApIHtcclxuICAgIC8vICAgICAgICAgICAgICAgICAgICBjb25zdCB0cGwgPSB0aGlzLmNvbXBpbGUodGV4dENvbnRlbnQpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgICAgIHB1c2gobmV3IFRlbXBsYXRlLlRleHRUZW1wbGF0ZSh0cGwgfHwgbm9kZS50ZXh0Q29udGVudCkpO1xyXG4gICAgLy8gICAgICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgfVxyXG5cclxuICAgIC8vICAgICAgICByZXR1cm4gcm9vdFRwbDtcclxuICAgIC8vICAgIH1cclxuXHJcbiAgICAvLyAgICBwYXJzZUF0dHIodGFnRWxlbWVudDogVGVtcGxhdGUuVGFnVGVtcGxhdGUsIGF0dHI6IEF0dHIpIHtcclxuICAgIC8vICAgICAgICBjb25zdCBuYW1lID0gYXR0ci5uYW1lO1xyXG4gICAgLy8gICAgICAgIGlmIChuYW1lID09PSBcImNsaWNrXCIgfHwgbmFtZS5tYXRjaCgva2V5dXBcXC4vKSB8fCBuYW1lID09PSBcIm1vdXNlb3ZlclwiIHx8IG5hbWUgPT09IFwibW91c2VvdXRcIikge1xyXG4gICAgLy8gICAgICAgICAgICBjb25zdCBmbiA9IHRoaXMuY29tcGlsZShhdHRyLnZhbHVlKTtcclxuICAgIC8vICAgICAgICAgICAgdGFnRWxlbWVudC5hZGRFdmVudChuYW1lLCBmbik7XHJcbiAgICAvLyAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSBcImRhdGEtc2VsZWN0XCIgfHwgbmFtZSA9PT0gXCJkYXRhLWZyb21cIikge1xyXG4gICAgLy8gICAgICAgICAgICBjb25zdCBmbiA9IHRoaXMuY29tcGlsZShhdHRyLnZhbHVlKTtcclxuICAgIC8vICAgICAgICAgICAgdGFnRWxlbWVudC5zZWxlY3QoZm4pO1xyXG4gICAgLy8gICAgICAgIH0gZWxzZSB7XHJcbiAgICAvLyAgICAgICAgICAgIGNvbnN0IHRwbCA9IHRoaXMuY29tcGlsZShhdHRyLnZhbHVlKTtcclxuICAgIC8vICAgICAgICAgICAgdGFnRWxlbWVudC5hdHRyKG5hbWUsIHRwbCB8fCBhdHRyLnZhbHVlKTtcclxuXHJcbiAgICAvLyAgICAgICAgICAgIC8vIGNvbnZlbnRpb25zXHJcbiAgICAvLyAgICAgICAgICAgIGlmICghIXRhZ0VsZW1lbnQubmFtZS5tYXRjaCgvXmlucHV0JC9pKSAmJlxyXG4gICAgLy8gICAgICAgICAgICAgICAgISFhdHRyLm5hbWUubWF0Y2goL15uYW1lJC9pKSAmJlxyXG4gICAgLy8gICAgICAgICAgICAgICAgIXRhZ0VsZW1lbnQuZ2V0QXR0cmlidXRlKFwidmFsdWVcIikpIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlQWNjZXNzb3IgPSB0aGlzLmNvbXBpbGUoYHt7ICR7YXR0ci52YWx1ZX0gfX1gKTtcclxuICAgIC8vICAgICAgICAgICAgICAgIHRhZ0VsZW1lbnQuYXR0cihcInZhbHVlXCIsIHZhbHVlQWNjZXNzb3IpO1xyXG4gICAgLy8gICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgfVxyXG4gICAgLy8gICAgfVxyXG5cclxuICAgIC8vfVxyXG5cclxuICAgIC8vZXhwb3J0IGZ1bmN0aW9uIGltcG9ydFZpZXcodmlldzogc3RyaW5nLCAuLi5hcmdzKTogYW55IHtcclxuICAgIC8vICAgIGlmICghKFwiaW1wb3J0XCIgaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImxpbmtcIikpKSB7XHJcbiAgICAvLyAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSFRNTCBpbXBvcnQgaXMgbm90IHN1cHBvcnRlZCBpbiB0aGlzIGJyb3dzZXJcIik7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgdmFyIGRlZmVycmVkID0gZGVmZXIoKTtcclxuICAgIC8vICAgIHZhciBsaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGluaycpO1xyXG4gICAgLy8gICAgbGluay5yZWwgPSAnaW1wb3J0JztcclxuICAgIC8vICAgIGxpbmsuaHJlZiA9IHZpZXc7XHJcbiAgICAvLyAgICBsaW5rLnNldEF0dHJpYnV0ZSgnYXN5bmMnLCBcIlwiKTsgLy8gbWFrZSBpdCBhc3luYyFcclxuICAgIC8vICAgIGxpbmsub25sb2FkID0gZSA9PiB7XHJcbiAgICAvLyAgICAgICAgdmFyIGxpbmsgPSAoPGFueT5lLnRhcmdldCk7XHJcbiAgICAvLyAgICAgICAgZGVmZXJyZWQubm90aWZ5KGxpbmsuaW1wb3J0LnF1ZXJ5U2VsZWN0b3IoXCJ0ZW1wbGF0ZVwiKSk7XHJcbiAgICAvLyAgICAgICAgbGluay5vbmxvYWQgPSBudWxsO1xyXG4gICAgLy8gICAgfVxyXG4gICAgLy8gICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChsaW5rKTtcclxuXHJcbiAgICAvLyAgICByZXR1cm4gZGVmZXJyZWQ7XHJcbiAgICAvL31cclxuXHJcbiAgICAvL2Z1bmN0aW9uIGRlZmVyKCkge1xyXG4gICAgLy8gICAgcmV0dXJuIHtcclxuICAgIC8vICAgICAgICB2YWx1ZTogdm9pZCAwLFxyXG4gICAgLy8gICAgICAgIHJlc29sdmVyczogW10sXHJcbiAgICAvLyAgICAgICAgbm90aWZ5KHZhbHVlKSB7XHJcbiAgICAvLyAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdm9pZCAwKVxyXG4gICAgLy8gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwidW5kZWZpbmVkIHJlc3VsdFwiKTtcclxuXHJcbiAgICAvLyAgICAgICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcclxuXHJcbiAgICAvLyAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5yZXNvbHZlcnMubGVuZ3RoOyBpKyspIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIHRoaXMucmVzb2x2ZXJzW2ldLmNhbGwobnVsbCwgdmFsdWUpO1xyXG4gICAgLy8gICAgICAgICAgICB9XHJcbiAgICAvLyAgICAgICAgfSxcclxuICAgIC8vICAgICAgICB0aGVuKHJlc29sdmUpIHtcclxuICAgIC8vICAgICAgICAgICAgaWYgKHRoaXMudmFsdWUgPT09IHZvaWQgMCkge1xyXG4gICAgLy8gICAgICAgICAgICAgICAgdGhpcy5yZXNvbHZlcnMucHVzaChyZXNvbHZlKTtcclxuICAgIC8vICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgIC8vICAgICAgICAgICAgICAgIHJlc29sdmUuY2FsbChudWxsLCB0aGlzLnZhbHVlKTtcclxuICAgIC8vICAgICAgICAgICAgfVxyXG4gICAgLy8gICAgICAgIH1cclxuICAgIC8vICAgIH07XHJcbiAgICAvL31cclxuXHJcbiAgICAvL2V4cG9ydCBmdW5jdGlvbiBiaW5kKGRvbTogTm9kZSwgc3RvcmUpIHtcclxuXHJcbiAgICAvLyAgICB2YXIgYmluZGVyID0gbmV3IEJpbmRlcihbQ29yZS5MaXN0LCBDb3JlLk1hdGgsIENvcmUuRGF0ZXNdKTtcclxuXHJcbiAgICAvLyAgICBsZXQgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XHJcbiAgICAvLyAgICBEb20uZXhlY3V0ZVRlbXBsYXRlKHN0b3JlLCBiaW5kZXIucGFyc2VEb20oZG9tKSwgZnJhZ21lbnQsIDApO1xyXG4gICAgLy8gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmFnbWVudC5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAvLyAgICAgICAgdmFyIGNoaWxkID0gZnJhZ21lbnQuY2hpbGROb2Rlc1tpXTtcclxuICAgIC8vICAgICAgICBCaW5kZXIubGlzdGVuKGNoaWxkLCBzdG9yZSk7XHJcbiAgICAvLyAgICB9XHJcblxyXG4gICAgLy8gICAgcmV0dXJuIGZyYWdtZW50O1xyXG4gICAgLy99XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBqb2luKHNlcGFyYXRvcjogc3RyaW5nLCB2YWx1ZSkge1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlLmxlbmd0aCA+IDAgPyB2YWx1ZS5zb3J0KCkuam9pbihzZXBhcmF0b3IpIDogbnVsbDtcclxuICAgIH1cclxuICAgIHJldHVybiB2YWx1ZTtcclxufVxyXG5cclxuICAgIC8vIFJlU2hhcnBlciByZXN0b3JlIEluY29uc2lzdGVudE5hbWluZ1xyXG4iXX0=