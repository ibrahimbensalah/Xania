"use strict";
var dom_1 = require("./dom");
var core_1 = require("./core");
var template_1 = require("./template");
var fsharp_1 = require("./fsharp");
var Loader;
(function (Loader) {
    function domReady(fn) {
        var args = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            args[_i - 1] = arguments[_i];
        }
        if (document.readyState !== "loading") {
            fn.apply(null, args);
        }
        else {
            document.addEventListener("DOMContentLoaded", function () { return fn.apply(null, args); });
        }
    }
    function init(root) {
        var stack = [root];
        while (stack.length > 0) {
            var dom = stack.pop();
            if (!!dom["content"] && !!dom.attributes["name"]) {
                var name = dom.attributes["name"].value;
                var parts = name.split('.');
            }
            else {
                for (var i = 0; i < dom.childNodes.length; i++) {
                    var child = dom.childNodes[i];
                    if (child.nodeType === 1)
                        stack.push(child);
                }
            }
        }
    }
    Loader.init = init;
})(Loader || (Loader = {}));
var Parser = (function () {
    function Parser() {
    }
    Parser.parseText = function (text) {
        var parts = [];
        var appendText = function (x) {
            var s = x.trim();
            if (s.length > 0)
                parts.push(x);
        };
        var offset = 0;
        while (offset < text.length) {
            var begin = text.indexOf("{{", offset);
            if (begin >= 0) {
                if (begin > offset)
                    appendText(text.substring(offset, begin));
                offset = begin + 2;
                var end = text.indexOf("}}", offset);
                if (end >= 0) {
                    parts.push(fsharp_1.fsharp(text.substring(offset, end)));
                    offset = end + 2;
                }
                else {
                    throw new SyntaxError("Expected '}}' but not found starting from index: " + offset);
                }
            }
            else {
                appendText(text.substring(offset));
                break;
            }
        }
        if (parts.length === 1)
            return parts[0];
        return parts;
    };
    Parser.parseAttr = function (tagElement, attr) {
        var name = attr.name;
        if (name === "click" || name.startsWith("keyup.")) {
            var fn = this.parseText(attr.value);
            tagElement.addEvent(name, fn);
        }
        else if (name === "data-select" || name === "data-from") {
            var fn = this.parseText(attr.value);
            tagElement.select(fn);
        }
        else if (name === "checked") {
            var fn = this.parseText(attr.value);
            tagElement.attr(name, core_1.Core.compose(function (ctx) { return !!ctx ? "checked" : null; }, fn));
        }
        else {
            var tpl = this.parseText(attr.value);
            tagElement.attr(name, tpl || attr.value);
            if (!!tagElement.name.match(/^input$/i) && !!attr.name.match(/^name$/i) && tagElement.getAttribute("value") != undefined) {
                var valueAccessor = this.parseText(attr.value);
                tagElement.attr("value", valueAccessor);
            }
        }
    };
    Parser.parseNode = function (node) {
        if (node.nodeType === 1) {
            var elt = node;
            var template = new template_1.Template.TagTemplate(elt.tagName, elt.namespaceURI);
            var content = null;
            for (var i = 0; !!elt.attributes && i < elt.attributes.length; i++) {
                var attribute = elt.attributes[i];
                if (attribute.name === "data-repeat") {
                    content = new template_1.Template.ContentTemplate(this.parseText(attribute.value)).child(template);
                }
                else {
                    this.parseAttr(template, attribute);
                }
            }
            for (var e = 0; e < elt.childNodes.length; e++) {
                var child = this.parseNode(elt.childNodes[e]);
                if (child)
                    template.addChild(child);
            }
            return content || template;
        }
        else if (node.nodeType === 3) {
            var textContent = node.textContent;
            if (textContent.trim().length > 0) {
                var tpl = this.parseText(textContent);
                return new template_1.Template.TextTemplate(tpl || node.textContent);
            }
        }
        return undefined;
    };
    return Parser;
}());
function bind(node) {
    var children = [];
    if (!!node["content"]) {
        var content = node["content"];
        for (var i = 0; i < content.childNodes.length; i++) {
            var tpl = Parser.parseNode(content.childNodes[i]);
            if (tpl)
                children.push(tpl);
        }
    }
    return new dom_1.Dom.ContentBinding(null, function (dom) { return node.parentElement.insertBefore(dom, node); }, children);
}
exports.bind = bind;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xvYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsNkJBQTJCO0FBQzNCLCtCQUE2QjtBQUM3Qix1Q0FBcUM7QUFDckMsbUNBQXVDO0FBSXZDLElBQU8sTUFBTSxDQWtFWjtBQWxFRCxXQUFPLE1BQU07SUFHVCxrQkFBa0IsRUFBRTtRQUFFLGNBQWM7YUFBZCxVQUFjLEVBQWQscUJBQWMsRUFBZCxJQUFjO1lBQWQsNkJBQWM7O1FBQ2hDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNwQyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN6QixDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixRQUFRLENBQUMsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUUsY0FBTSxPQUFBLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFwQixDQUFvQixDQUFDLENBQUM7UUFDOUUsQ0FBQztJQUNMLENBQUM7SUFFRCxjQUFxQixJQUFJO1FBSXJCLElBQUksS0FBSyxHQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFM0IsT0FBTyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3RCLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUV0QixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDL0MsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUM7Z0JBSXhDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxL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QUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0QyxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNsQyxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxhQUFhLElBQUksSUFBSSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUM7WUFDeEQsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdEMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMxQixDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQzVCLElBQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3RDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLFdBQUksQ0FBQyxPQUFPLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxDQUFDLENBQUMsR0FBRyxHQUFHLFNBQVMsR0FBRyxJQUFJLEVBQXhCLENBQXdCLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM3RSxDQUFDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDSixJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2QyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBR3pDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksVUFBVSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUN2SCxJQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDakQsVUFBVSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFDNUMsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0lBRU0sZ0JBQVMsR0FBaEIsVUFBaUIsSUFBVTtRQUN2QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsSUFBTSxHQUFHLEdBQWdCLElBQUksQ0FBQztZQUU5QixJQUFNLFFBQVEsR0FBRyxJQUFJLG1CQUFRLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3pFLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztZQUVuQixHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ2pFLElBQUksU0FBUyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEtBQUssYUFBYSxDQUFDLENBQUMsQ0FBQztvQkFDbkMsT0FBTyxHQUFHLElBQUksbUJBQVEsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzVGLENBQUM7Z0JBQUMsSUFBSSxDQUFDLENBQUM7b0JBQ0osSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUM7Z0JBQ3hDLENBQUM7WUFDTCxDQUFDO1lBRUQsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUM3QyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDOUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDO29CQUNOLFFBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDakMsQ0FBQztZQUVELE1BQU0sQ0FBQyxPQUFPLElBQUksUUFBUSxDQUFDO1FBQy9CLENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdCLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDbkMsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNoQyxJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUN4QyxNQUFNLENBQUMsSUFBSSxtQkFBUSxDQUFDLFlBQVksQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzlELENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxDQUFDLFNBQVMsQ0FBQztJQUNyQixDQUFDO0lBQ0wsYUFBQztBQUFELENBQUMsQUE5RkQsSUE4RkM7QUFFRCxjQUFxQixJQUFJO0lBQ3JCLElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQztJQUNsQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQixJQUFNLE9BQU8sR0FBZ0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzdDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNqRCxJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsRCxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7Z0JBQ0osUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzQixDQUFDO0lBQ0wsQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFJLFNBQUcsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLFVBQUEsR0FBRyxJQUFJLE9BQUEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUExQyxDQUEwQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ3JHLENBQUM7QUFaRCxvQkFZQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERvbSB9IGZyb20gXCIuL2RvbVwiXHJcbmltcG9ydCB7IENvcmUgfSBmcm9tICcuL2NvcmUnXHJcbmltcG9ydCB7IFRlbXBsYXRlIH0gZnJvbSBcIi4vdGVtcGxhdGVcIlxyXG5pbXBvcnQgeyBmc2hhcnAgYXMgZnMgfSBmcm9tIFwiLi9mc2hhcnBcIlxyXG5cclxuZGVjbGFyZSBmdW5jdGlvbiByZXF1aXJlKG1vZHVsZTogc3RyaW5nKTtcclxuXHJcbm1vZHVsZSBMb2FkZXIge1xyXG4gICAgZGVjbGFyZSB2YXIgZG9jdW1lbnQ6IGFueTtcclxuXHJcbiAgICBmdW5jdGlvbiBkb21SZWFkeShmbiwgLi4uYXJnczogYW55W10pIHtcclxuICAgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSAhPT0gXCJsb2FkaW5nXCIpIHtcclxuICAgICAgICAgICAgZm4uYXBwbHkobnVsbCwgYXJncyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgKCkgPT4gZm4uYXBwbHkobnVsbCwgYXJncykpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBleHBvcnQgZnVuY3Rpb24gaW5pdChyb290KSB7XHJcblxyXG4gICAgICAgIC8vICAgIHZhciBjb250YWluZXIgPSBuZXcgRGF0YS5PYmplY3RDb250YWluZXIoKTtcclxuICAgICAgICAvLyAgICAvLyBGaW5kIHRvcCBsZXZlbCBjb21wb25lbnRzIGFuZCBiaW5kXHJcbiAgICAgICAgdmFyIHN0YWNrOiBOb2RlW10gPSBbcm9vdF07XHJcblxyXG4gICAgICAgIHdoaWxlIChzdGFjay5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHZhciBkb20gPSBzdGFjay5wb3AoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghIWRvbVtcImNvbnRlbnRcIl0gJiYgISFkb20uYXR0cmlidXRlc1tcIm5hbWVcIl0pIHtcclxuICAgICAgICAgICAgICAgIHZhciBuYW1lID0gZG9tLmF0dHJpYnV0ZXNbXCJuYW1lXCJdLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgLy8gbGV0IG1vZGVsID0gZXZhbCgnKCcgKyBuYW1lQXR0ci52YWx1ZSArICcpJyk7XHJcbiAgICAgICAgICAgICAgICAvLyB2YXIgc3RvcmUgPSBuZXcgUmUuU3RvcmUobW9kZWwsIFtDb3JlLkxpc3QsIENvcmUuTWF0aCwgQ29yZS5EYXRlc10ucmVkdWNlKCh4LCB5KSA9PiBPYmplY3QuYXNzaWduKHgsIHkpLCB7fSkpO1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IG5hbWUuc3BsaXQoJy4nKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyB2YXIgbW9kdWxlID0gcmVxdWlyZShwYXJ0c1swXSk7XHJcbiAgICAgICAgICAgICAgICAvLyB2YXIgY29tcG9uZW50ID0gbW9kdWxlW3BhcnRzWzFdXTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhjb21wb25lbnQpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8vIHBhcnNlRG9tKGRvbSk7XHJcbiAgICAgICAgICAgICAgICAvLyBEb20uYmluZChkb20sIHN0b3JlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvL2lmICghIW1vZGVsLmluaXQpIHtcclxuICAgICAgICAgICAgICAgIC8vICAgIG1vZGVsLmluaXQoc3RvcmUpO1xyXG4gICAgICAgICAgICAgICAgLy99XHJcbiAgICAgICAgICAgICAgICAvL30gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICB2YXIgbmFtZSA9IGRvbS5ub2RlTmFtZS5yZXBsYWNlKC9cXC0vLCBcIlwiKS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgbGV0IG1vZGVsID0gY29udGFpbmVyLmdldChuYW1lKTtcclxuICAgICAgICAgICAgICAgIC8vICAgIGlmIChtb2RlbCAhPT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRvbS5hdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgIHZhciBhdHRyID0gZG9tLmF0dHJpYnV0ZXMuaXRlbShpKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgbW9kZWxbYXR0ci5uYW1lXSA9IGV2YWwoYXR0ci52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgIGxldCB0ZW1wbGF0ZSA9IGRvbTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICBEb20uaW1wb3J0Vmlldyhkb20ubm9kZU5hbWUgKyBcIi5odG1sXCIpXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgIC50aGVuKGRvbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgICB2YXIgc3RvcmUgPSBuZXcgRGF0YS5TdG9yZShtb2RlbCxcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgICAgICBbQ29yZS5MaXN0LCBDb3JlLk1hdGgsIENvcmUuRGF0ZXNdLnJlZHVjZSgoeCwgeSkgPT4gT2JqZWN0LmFzc2lnbih4LCB5KSwge30pKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgICB2YXIgZnJhZ21lbnQgPSBEb20uYmluZChkb20sIHN0b3JlKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgICAgICAgICAgIHRlbXBsYXRlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGZyYWdtZW50LCB0ZW1wbGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkb20uY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IGRvbS5jaGlsZE5vZGVzW2ldO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5ub2RlVHlwZSA9PT0gMSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChjaGlsZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gICAgIGRvbVJlYWR5KGluaXQsIGRvY3VtZW50LmJvZHkpO1xyXG59XHJcblxyXG5jbGFzcyBQYXJzZXIge1xyXG5cclxuICAgIHN0YXRpYyBwYXJzZVRleHQodGV4dCk6IGFueVtdIHtcclxuICAgICAgICB2YXIgcGFydHM6IGFueVtdID0gW107XHJcblxyXG4gICAgICAgIHZhciBhcHBlbmRUZXh0ID0gKHgpID0+IHtcclxuICAgICAgICAgICAgdmFyIHMgPSB4LnRyaW0oKTtcclxuICAgICAgICAgICAgaWYgKHMubGVuZ3RoID4gMClcclxuICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goeCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgdmFyIG9mZnNldCA9IDA7XHJcbiAgICAgICAgd2hpbGUgKG9mZnNldCA8IHRleHQubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHZhciBiZWdpbiA9IHRleHQuaW5kZXhPZihcInt7XCIsIG9mZnNldCk7XHJcbiAgICAgICAgICAgIGlmIChiZWdpbiA+PSAwKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYmVnaW4gPiBvZmZzZXQpXHJcbiAgICAgICAgICAgICAgICAgICAgYXBwZW5kVGV4dCh0ZXh0LnN1YnN0cmluZyhvZmZzZXQsIGJlZ2luKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgb2Zmc2V0ID0gYmVnaW4gKyAyO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZW5kID0gdGV4dC5pbmRleE9mKFwifX1cIiwgb2Zmc2V0KTtcclxuICAgICAgICAgICAgICAgIGlmIChlbmQgPj0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcnRzLnB1c2goZnModGV4dC5zdWJzdHJpbmcob2Zmc2V0LCBlbmQpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gZW5kICsgMjtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFwiRXhwZWN0ZWQgJ319JyBidXQgbm90IGZvdW5kIHN0YXJ0aW5nIGZyb20gaW5kZXg6IFwiICsgb2Zmc2V0KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGFwcGVuZFRleHQodGV4dC5zdWJzdHJpbmcob2Zmc2V0KSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMSlcclxuICAgICAgICAgICAgcmV0dXJuIHBhcnRzWzBdO1xyXG5cclxuICAgICAgICByZXR1cm4gcGFydHM7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHBhcnNlQXR0cih0YWdFbGVtZW50OiBUZW1wbGF0ZS5UYWdUZW1wbGF0ZSwgYXR0cjogQXR0cikge1xyXG4gICAgICAgIGNvbnN0IG5hbWUgPSBhdHRyLm5hbWU7XHJcbiAgICAgICAgaWYgKG5hbWUgPT09IFwiY2xpY2tcIiB8fCBuYW1lLnN0YXJ0c1dpdGgoXCJrZXl1cC5cIikpIHtcclxuICAgICAgICAgICAgY29uc3QgZm4gPSB0aGlzLnBhcnNlVGV4dChhdHRyLnZhbHVlKTtcclxuICAgICAgICAgICAgdGFnRWxlbWVudC5hZGRFdmVudChuYW1lLCBmbik7XHJcbiAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSBcImRhdGEtc2VsZWN0XCIgfHwgbmFtZSA9PT0gXCJkYXRhLWZyb21cIikge1xyXG4gICAgICAgICAgICBjb25zdCBmbiA9IHRoaXMucGFyc2VUZXh0KGF0dHIudmFsdWUpO1xyXG4gICAgICAgICAgICB0YWdFbGVtZW50LnNlbGVjdChmbik7XHJcbiAgICAgICAgfSBlbHNlIGlmIChuYW1lID09PSBcImNoZWNrZWRcIikge1xyXG4gICAgICAgICAgICBjb25zdCBmbiA9IHRoaXMucGFyc2VUZXh0KGF0dHIudmFsdWUpO1xyXG4gICAgICAgICAgICB0YWdFbGVtZW50LmF0dHIobmFtZSwgQ29yZS5jb21wb3NlKGN0eCA9PiAhIWN0eCA/IFwiY2hlY2tlZFwiIDogbnVsbCwgZm4pKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBjb25zdCB0cGwgPSB0aGlzLnBhcnNlVGV4dChhdHRyLnZhbHVlKTtcclxuICAgICAgICAgICAgdGFnRWxlbWVudC5hdHRyKG5hbWUsIHRwbCB8fCBhdHRyLnZhbHVlKTtcclxuXHJcbiAgICAgICAgICAgIC8vIGNvbnZlbnRpb25zXHJcbiAgICAgICAgICAgIGlmICghIXRhZ0VsZW1lbnQubmFtZS5tYXRjaCgvXmlucHV0JC9pKSAmJiAhIWF0dHIubmFtZS5tYXRjaCgvXm5hbWUkL2kpICYmIHRhZ0VsZW1lbnQuZ2V0QXR0cmlidXRlKFwidmFsdWVcIikgIT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZUFjY2Vzc29yID0gdGhpcy5wYXJzZVRleHQoYXR0ci52YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB0YWdFbGVtZW50LmF0dHIoXCJ2YWx1ZVwiLCB2YWx1ZUFjY2Vzc29yKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgcGFyc2VOb2RlKG5vZGU6IE5vZGUpOiBUZW1wbGF0ZS5JTm9kZSB7XHJcbiAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHtcclxuICAgICAgICAgICAgY29uc3QgZWx0ID0gPEhUTUxFbGVtZW50Pm5vZGU7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IG5ldyBUZW1wbGF0ZS5UYWdUZW1wbGF0ZShlbHQudGFnTmFtZSwgZWx0Lm5hbWVzcGFjZVVSSSk7XHJcbiAgICAgICAgICAgIHZhciBjb250ZW50ID0gbnVsbDtcclxuXHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyAhIWVsdC5hdHRyaWJ1dGVzICYmIGkgPCBlbHQuYXR0cmlidXRlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdmFyIGF0dHJpYnV0ZSA9IGVsdC5hdHRyaWJ1dGVzW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZS5uYW1lID09PSBcImRhdGEtcmVwZWF0XCIpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gbmV3IFRlbXBsYXRlLkNvbnRlbnRUZW1wbGF0ZSh0aGlzLnBhcnNlVGV4dChhdHRyaWJ1dGUudmFsdWUpKS5jaGlsZCh0ZW1wbGF0ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFyc2VBdHRyKHRlbXBsYXRlLCBhdHRyaWJ1dGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmb3IgKHZhciBlID0gMDsgZSA8IGVsdC5jaGlsZE5vZGVzLmxlbmd0aDsgZSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGQgPSB0aGlzLnBhcnNlTm9kZShlbHQuY2hpbGROb2Rlc1tlXSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2hpbGQpXHJcbiAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGUuYWRkQ2hpbGQoY2hpbGQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gY29udGVudCB8fCB0ZW1wbGF0ZTtcclxuICAgICAgICB9IGVsc2UgaWYgKG5vZGUubm9kZVR5cGUgPT09IDMpIHtcclxuICAgICAgICAgICAgdmFyIHRleHRDb250ZW50ID0gbm9kZS50ZXh0Q29udGVudDtcclxuICAgICAgICAgICAgaWYgKHRleHRDb250ZW50LnRyaW0oKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0cGwgPSB0aGlzLnBhcnNlVGV4dCh0ZXh0Q29udGVudCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRlbXBsYXRlLlRleHRUZW1wbGF0ZSh0cGwgfHwgbm9kZS50ZXh0Q29udGVudCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBiaW5kKG5vZGUpIHtcclxuICAgIHZhciBjaGlsZHJlbiA9IFtdO1xyXG4gICAgaWYgKCEhbm9kZVtcImNvbnRlbnRcIl0pIHtcclxuICAgICAgICBjb25zdCBjb250ZW50ID0gPEhUTUxFbGVtZW50Pm5vZGVbXCJjb250ZW50XCJdO1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY29udGVudC5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciB0cGwgPSBQYXJzZXIucGFyc2VOb2RlKGNvbnRlbnQuY2hpbGROb2Rlc1tpXSk7XHJcbiAgICAgICAgICAgIGlmICh0cGwpXHJcbiAgICAgICAgICAgICAgICBjaGlsZHJlbi5wdXNoKHRwbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXcgRG9tLkNvbnRlbnRCaW5kaW5nKG51bGwsIGRvbSA9PiBub2RlLnBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKGRvbSwgbm9kZSksIGNoaWxkcmVuKTtcclxufVxyXG4iXX0=