"use strict";
var peg = require("./query.peg");
function empty(list) {
    return list.length === 0;
}
function not(value) {
    return !value;
}
function count(list) {
    return list.length;
}
var WHERE = 1;
var QUERY = 2;
var IDENT = 3;
var MEMBER = 4;
var APP = 5;
var SELECT = 6;
var CONST = 7;
var RANGE = 8;
var BINARY = 9;
var AWAIT = 10;
var PIPE = 11;
var COMPOSE = 12;
var LAMBDA = 13;
var Expression = (function () {
    function Expression(ast, stack) {
        this.ast = ast;
        this.stack = stack;
    }
    Expression.prototype.execute = function (binding, contexts) {
        var stack = this.stack;
        var context = Array.isArray(contexts) ? new Scope(binding, contexts) : contexts;
        var idx = stack.length;
        while (idx--) {
            var ast = stack[idx];
            switch (ast.type) {
                case IDENT:
                    ast.value = binding.member(context, ast.name);
                    break;
                case QUERY:
                    ast.value = binding.query(ast.param, ast.source.value);
                    break;
                case CONST:
                    break;
                case MEMBER:
                    var target = ast.target.value;
                    var name = ast.member.value || ast.member;
                    ast.value = binding.member(target, name);
                    break;
                case AWAIT:
                    ast.value = binding.await(ast.expr.value);
                    break;
                case RANGE:
                    var first = ast.from.value;
                    var last = ast.to.value;
                    if (first === void 0 || last === void 0)
                        return void 0;
                    ast.value = new Range(first, last);
                    break;
                case BINARY:
                    var source;
                    switch (ast.op) {
                        case "->":
                            source = ast.left.value;
                            if (source === void 0 || !source.valueOf())
                                return void 0;
                            ast.value = ast.right.compiled.execute(binding, context);
                            break;
                        case "where":
                        case WHERE:
                            source = ast.left.value;
                            var length_1 = source.length;
                            var result = [];
                            for (var i = 0; i < length_1; i++) {
                                var item = binding.member(source, i);
                                var scope = new Scope(binding, [item, context]);
                                var b = ast.right.compiled.execute(binding, scope);
                                if (b)
                                    result.push(item);
                            }
                            ast.value = result;
                            break;
                        default:
                            var left = ast.left.value;
                            var right = ast.right.value;
                            ast.value = binding.app(ast.op, [right, left]);
                            break;
                    }
                    break;
                case APP:
                    var args = void 0;
                    var length_2 = ast.args.length;
                    for (var i_1 = 0; i_1 < length_2; i_1++) {
                        var arg = ast.args[i_1].value;
                        if (arg === void 0)
                            return arg;
                        if (!args)
                            args = [arg];
                        else
                            args.push(arg);
                    }
                    var fun = ast.fun.value;
                    if (fun === void 0) {
                        console.error("could not resolve expression, " + JSON.stringify(ast.fun));
                        return void 0;
                    }
                    else
                        ast.value = binding.app(fun.valueOf(), args);
                    break;
                default:
                    throw Error("unsupported ast type " + ast.type);
            }
            if (ast.value === void 0)
                return void 0;
        }
        return this.ast.value;
    };
    Expression.compile = function (ast) {
        var queue = [];
        Expression.compileAst(ast, queue);
        return new Expression(ast, queue);
    };
    Expression.compileAst = function (ast, stack) {
        var compile = Expression.compileAst;
        if (typeof ast === "object") {
            switch (ast.type) {
                case IDENT:
                    switch (ast.name) {
                        case "null":
                            ast.type = CONST;
                            ast.value = null;
                            break;
                        case "true":
                            ast.type = CONST;
                            ast.value = true;
                            break;
                        case "false":
                            ast.type = CONST;
                            ast.value = false;
                            break;
                        case "no":
                        case "empty":
                            ast.type = CONST;
                            ast.value = empty;
                            break;
                        case "count":
                            ast.type = CONST;
                            ast.value = count;
                            break;
                        case "not":
                            ast.type = CONST;
                            ast.value = not;
                            break;
                        default:
                            stack.push(ast);
                            break;
                    }
                    break;
                case QUERY:
                    stack.push(ast);
                    compile(ast.source, stack);
                    break;
                case MEMBER:
                    stack.push(ast);
                    compile(ast.member, stack);
                    compile(ast.target, stack);
                    break;
                case AWAIT:
                    stack.push(ast);
                    compile(ast.expr, stack);
                    break;
                case RANGE:
                    stack.push(ast);
                    compile(ast.from, stack);
                    compile(ast.to, stack);
                    break;
                case CONST:
                    stack.push(ast);
                    break;
                case BINARY:
                    stack.push(ast);
                    switch (ast.op) {
                        case "->":
                        case "where":
                        case WHERE:
                            ast.right.compiled = Expression.compile(ast.right);
                            compile(ast.left, stack);
                            break;
                        default:
                            compile(ast.right, stack);
                            compile(ast.left, stack);
                            break;
                    }
                    break;
                case APP:
                    stack.push(ast);
                    compile(ast.fun, stack);
                    var length = ast.args.length;
                    for (var i = 0; i < length; i++) {
                        compile(ast.args[i], stack);
                    }
                    break;
                default:
                    throw Error("unsupported ast type " + ast.type);
            }
        }
    };
    return Expression;
}());
var Range = (function () {
    function Range(first, last) {
        this.first = first;
        this.last = last;
    }
    Range.prototype.map = function (fn) {
        var result = [], last = this.last;
        for (var i = this.first; i <= last; i++) {
            result.push(fn(i));
        }
        return result;
    };
    return Range;
}());
function compile(expr) {
    return Expression.compile(peg.parse(expr));
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = compile;
function parse(expr) {
    return peg.parse(expr);
}
exports.parse = parse;
var Scope = (function () {
    function Scope(visitor, contexts) {
        this.visitor = visitor;
        this.contexts = contexts;
    }
    Scope.prototype.get = function (name) {
        var visitor = this.visitor;
        var contexts = this.contexts;
        for (var i = 0; i < this.contexts.length; i++) {
            var value = visitor.member(contexts[i], name);
            if (value !== void 0)
                return value;
        }
        return void 0;
    };
    return Scope;
}());
exports.Scope = Scope;
exports.TOKENS = { WHERE: WHERE, QUERY: QUERY, IDENT: IDENT, MEMBER: MEMBER, APP: APP, SELECT: SELECT, CONST: CONST, RANGE: RANGE, BINARY: BINARY, AWAIT: AWAIT, PIPE: PIPE, COMPOSE: COMPOSE };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvbXBpbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQWFBLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUVqQyxlQUFlLElBQUk7SUFDZixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUM7QUFDN0IsQ0FBQztBQUVELGFBQWEsS0FBSztJQUNkLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNsQixDQUFDO0FBRUQsZUFBZSxJQUFJO0lBQ2YsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7QUFDdkIsQ0FBQztBQUdELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztBQUNaLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztBQUNkLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztBQUNmLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztBQUNmLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUNkLElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQztBQUNqQixJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFHaEI7SUFDSSxvQkFBbUIsR0FBRyxFQUFVLEtBQVk7UUFBekIsUUFBRyxHQUFILEdBQUcsQ0FBQTtRQUFVLFVBQUssR0FBTCxLQUFLLENBQU87SUFDNUMsQ0FBQztJQUVELDRCQUFPLEdBQVAsVUFBUSxPQUFvQixFQUFFLFFBQWE7UUFDakMsSUFBQSxrQkFBSyxDQUFVO1FBRXJCLElBQUksT0FBTyxHQUFHLEtB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T0FBTyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDOUMsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLEtBQUssQ0FBQyxDQUFDO2dCQUNqQixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ3JCLENBQUM7UUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUNMLFlBQUM7QUFBRCxDQUFDLEFBZkQsSUFlQztBQWZZLHNCQUFLO0FBaUJQLFFBQUEsTUFBTSxHQUFHLEVBQUUsS0FBSyxPQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsTUFBTSxRQUFBLEVBQUUsR0FBRyxLQUFBLEVBQUUsTUFBTSxRQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsTUFBTSxRQUFBLEVBQUUsS0FBSyxPQUFBLEVBQUUsSUFBSSxNQUFBLEVBQUUsT0FBTyxTQUFBLEVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBpbnRlcmZhY2UgSUFzdFZpc2l0b3Ige1xyXG4gICAgd2hlcmUoc291cmNlLCBwcmVkaWNhdGUpO1xyXG4gICAgc2VsZWN0KHNvdXJjZSwgc2VsZWN0b3IpO1xyXG4gICAgcXVlcnkocGFyYW0sIHNvdXJjZSk7XHJcbiAgICBtZW1iZXIodGFyZ2V0LCBuYW1lKTtcclxuICAgIGFwcChmdW4sIGFyZ3M6IGFueVtdKTtcclxuICAgIGV4dGVuZChuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpO1xyXG4gICAgYXdhaXQob2JzZXJ2YWJsZSk7XHJcbiAgICBjb25zdCh2YWx1ZSk7XHJcbn1cclxuXHJcbmRlY2xhcmUgZnVuY3Rpb24gcmVxdWlyZShtb2R1bGU6IHN0cmluZyk7XHJcblxyXG52YXIgcGVnID0gcmVxdWlyZShcIi4vcXVlcnkucGVnXCIpO1xyXG5cclxuZnVuY3Rpb24gZW1wdHkobGlzdCkge1xyXG4gICAgcmV0dXJuIGxpc3QubGVuZ3RoID09PSAwO1xyXG59XHJcblxyXG5mdW5jdGlvbiBub3QodmFsdWUpIHtcclxuICAgIHJldHVybiAhdmFsdWU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvdW50KGxpc3QpIHtcclxuICAgIHJldHVybiBsaXN0Lmxlbmd0aDtcclxufVxyXG5cclxuLy8gUmVTaGFycGVyIGRpc2FibGUgSW5jb25zaXN0ZW50TmFtaW5nXHJcbnZhciBXSEVSRSA9IDE7XHJcbnZhciBRVUVSWSA9IDI7XHJcbnZhciBJREVOVCA9IDM7XHJcbnZhciBNRU1CRVIgPSA0O1xyXG52YXIgQVBQID0gNTtcclxudmFyIFNFTEVDVCA9IDY7XHJcbnZhciBDT05TVCA9IDc7XHJcbnZhciBSQU5HRSA9IDg7XHJcbnZhciBCSU5BUlkgPSA5O1xyXG52YXIgQVdBSVQgPSAxMDtcclxudmFyIFBJUEUgPSAxMTtcclxudmFyIENPTVBPU0UgPSAxMjtcclxudmFyIExBTUJEQSA9IDEzO1xyXG4vLyBSZVNoYXJwZXIgcmVzdG9yZSBJbmNvbnNpc3RlbnROYW1pbmdcclxuXHJcbmNsYXNzIEV4cHJlc3Npb24ge1xyXG4gICAgY29uc3RydWN0b3IocHVibGljIGFzdCwgcHJpdmF0ZSBzdGFjazogYW55W10pIHtcclxuICAgIH1cclxuXHJcbiAgICBleGVjdXRlKGJpbmRpbmc6IElBc3RWaXNpdG9yLCBjb250ZXh0czogYW55KSB7XHJcbiAgICAgICAgdmFyIHsgc3RhY2sgfSA9IHRoaXM7XHJcblxyXG4gICAgICAgIHZhciBjb250ZXh0ID0gQXJyYXkuaXNBcnJheShjb250ZXh0cykgPyBuZXcgU2NvcGUoYmluZGluZywgY29udGV4dHMpIDogY29udGV4dHM7XHJcblxyXG4gICAgICAgIGxldCBpZHggPSBzdGFjay5sZW5ndGg7XHJcbiAgICAgICAgd2hpbGUgKGlkeC0tKSB7XHJcbiAgICAgICAgICAgIHZhciBhc3QgPSBzdGFja1tpZHhdO1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGFzdC50eXBlKSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIElERU5UOlxyXG4gICAgICAgICAgICAgICAgICAgIGFzdC52YWx1ZSA9IGJpbmRpbmcubWVtYmVyKGNvbnRleHQsIGFzdC5uYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgUVVFUlk6XHJcbiAgICAgICAgICAgICAgICAgICAgYXN0LnZhbHVlID0gYmluZGluZy5xdWVyeShhc3QucGFyYW0sIGFzdC5zb3VyY2UudmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBDT05TVDpcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgTUVNQkVSOlxyXG4gICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSBhc3QudGFyZ2V0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBuYW1lID0gYXN0Lm1lbWJlci52YWx1ZSB8fCBhc3QubWVtYmVyO1xyXG4gICAgICAgICAgICAgICAgICAgIGFzdC52YWx1ZSA9IGJpbmRpbmcubWVtYmVyKHRhcmdldCwgbmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIEFXQUlUOlxyXG4gICAgICAgICAgICAgICAgICAgIGFzdC52YWx1ZSA9IGJpbmRpbmcuYXdhaXQoYXN0LmV4cHIudmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBSQU5HRTpcclxuICAgICAgICAgICAgICAgICAgICB2YXIgZmlyc3QgPSBhc3QuZnJvbS52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdCA9IGFzdC50by52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZmlyc3QgPT09IHZvaWQgMCB8fCBsYXN0ID09PSB2b2lkIDApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7XHJcbiAgICAgICAgICAgICAgICAgICAgYXN0LnZhbHVlID0gbmV3IFJhbmdlKGZpcnN0LCBsYXN0KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgQklOQVJZOlxyXG4gICAgICAgICAgICAgICAgICAgIHZhciBzb3VyY2U7XHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChhc3Qub3ApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIi0+XCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2UgPSBhc3QubGVmdC52YWx1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc291cmNlID09PSB2b2lkIDAgfHwgIXNvdXJjZS52YWx1ZU9mKCkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3QudmFsdWUgPSBhc3QucmlnaHQuY29tcGlsZWQuZXhlY3V0ZShiaW5kaW5nLCBjb250ZXh0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwid2hlcmVcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBXSEVSRTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGFzdC5sZWZ0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxlbmd0aCA9IHNvdXJjZS5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSBiaW5kaW5nLm1lbWJlcihzb3VyY2UsIGkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY29wZSA9IG5ldyBTY29wZShiaW5kaW5nLCBbaXRlbSwgY29udGV4dF0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBiID0gYXN0LnJpZ2h0LmNvbXBpbGVkLmV4ZWN1dGUoYmluZGluZywgc2NvcGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChpdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzdC52YWx1ZSA9IHJlc3VsdDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxlZnQgPSBhc3QubGVmdC52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByaWdodCA9IGFzdC5yaWdodC52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzdC52YWx1ZSA9IGJpbmRpbmcuYXBwKGFzdC5vcCwgW3JpZ2h0LCBsZWZ0XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIEFQUDpcclxuICAgICAgICAgICAgICAgICAgICBsZXQgYXJncztcclxuICAgICAgICAgICAgICAgICAgICBsZXQgbGVuZ3RoID0gYXN0LmFyZ3MubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFyZyA9IGFzdC5hcmdzW2ldLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJnID09PSB2b2lkIDApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXJnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFyZ3MpIGFyZ3MgPSBbYXJnXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhcmdzLnB1c2goYXJnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZ1biA9IGFzdC5mdW4udmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZ1biA9PT0gdm9pZCAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJjb3VsZCBub3QgcmVzb2x2ZSBleHByZXNzaW9uLCBcIiArIEpTT04uc3RyaW5naWZ5KGFzdC5mdW4pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgMDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2VcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXN0LnZhbHVlID0gYmluZGluZy5hcHAoZnVuLnZhbHVlT2YoKSwgYXJncyk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IEVycm9yKFwidW5zdXBwb3J0ZWQgYXN0IHR5cGUgXCIgKyBhc3QudHlwZSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChhc3QudmFsdWUgPT09IHZvaWQgMClcclxuICAgICAgICAgICAgICAgIHJldHVybiB2b2lkIDA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5hc3QudmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGNvbXBpbGUoYXN0KSB7XHJcbiAgICAgICAgdmFyIHF1ZXVlID0gW107XHJcbiAgICAgICAgRXhwcmVzc2lvbi5jb21waWxlQXN0KGFzdCwgcXVldWUpO1xyXG4gICAgICAgIHJldHVybiBuZXcgRXhwcmVzc2lvbihhc3QsIHF1ZXVlKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgY29tcGlsZUFzdChhc3QsIHN0YWNrOiBhbnlbXSkge1xyXG4gICAgICAgIGNvbnN0IGNvbXBpbGUgPSBFeHByZXNzaW9uLmNvbXBpbGVBc3Q7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBhc3QgPT09IFwib2JqZWN0XCIpIHtcclxuICAgICAgICAgICAgc3dpdGNoIChhc3QudHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSBJREVOVDpcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGFzdC5uYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJudWxsXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3QudHlwZSA9IENPTlNUO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN0LnZhbHVlID0gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwidHJ1ZVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN0LnR5cGUgPSBDT05TVDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzdC52YWx1ZSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcImZhbHNlXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3QudHlwZSA9IENPTlNUO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN0LnZhbHVlID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm5vXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJlbXB0eVwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN0LnR5cGUgPSBDT05TVDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzdC52YWx1ZSA9IGVtcHR5O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJjb3VudFwiOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXN0LnR5cGUgPSBDT05TVDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzdC52YWx1ZSA9IGNvdW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgXCJub3RcIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzdC50eXBlID0gQ09OU1Q7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3QudmFsdWUgPSBub3Q7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goYXN0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgUVVFUlk6XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChhc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoYXN0LnNvdXJjZSwgc3RhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBNRU1CRVI6XHJcbiAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChhc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoYXN0Lm1lbWJlciwgc3RhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoYXN0LnRhcmdldCwgc3RhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBBV0FJVDpcclxuICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKGFzdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29tcGlsZShhc3QuZXhwciwgc3RhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiB2aXNpdG9yLmF3YWl0KGFjY2VwdChhc3QuZXhwciwgdmlzaXRvciwgY29udGV4dCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBSQU5HRTpcclxuICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKGFzdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29tcGlsZShhc3QuZnJvbSwgc3RhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoYXN0LnRvLCBzdGFjayk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIENPTlNUOlxyXG4gICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goYXN0KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgQklOQVJZOlxyXG4gICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goYXN0KTtcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGFzdC5vcCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIFwiLT5cIjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSBcIndoZXJlXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgV0hFUkU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhc3QucmlnaHQuY29tcGlsZWQgPSBFeHByZXNzaW9uLmNvbXBpbGUoYXN0LnJpZ2h0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoYXN0LmxlZnQsIHN0YWNrKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZShhc3QucmlnaHQsIHN0YWNrKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGUoYXN0LmxlZnQsIHN0YWNrKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgQVBQOlxyXG4gICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2goYXN0KTtcclxuICAgICAgICAgICAgICAgICAgICBjb21waWxlKGFzdC5mdW4sIHN0YWNrKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gYXN0LmFyZ3MubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29tcGlsZShhc3QuYXJnc1tpXSwgc3RhY2spO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJ1bnN1cHBvcnRlZCBhc3QgdHlwZSBcIiArIGFzdC50eXBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgUmFuZ2Uge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBmaXJzdCwgcHJpdmF0ZSBsYXN0KSB7XHJcbiAgICB9XHJcblxyXG4gICAgbWFwKGZuKSB7XHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IFtdLCBsYXN0ID0gdGhpcy5sYXN0O1xyXG4gICAgICAgIGZvciAodmFyIGkgPSB0aGlzLmZpcnN0OyBpIDw9IGxhc3Q7IGkrKykge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChmbihpKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGNvbXBpbGUoZXhwcikge1xyXG4gICAgcmV0dXJuIEV4cHJlc3Npb24uY29tcGlsZShwZWcucGFyc2UoZXhwcikpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcGFyc2UoZXhwcikge1xyXG4gICAgcmV0dXJuIHBlZy5wYXJzZShleHByKTtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFNjb3BlIHtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgdmlzaXRvcjogSUFzdFZpc2l0b3IsIHByaXZhdGUgY29udGV4dHM6IGFueVtdKSB7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0KG5hbWU6IHN0cmluZykge1xyXG4gICAgICAgIHZhciB2aXNpdG9yID0gdGhpcy52aXNpdG9yO1xyXG4gICAgICAgIHZhciBjb250ZXh0cyA9IHRoaXMuY29udGV4dHM7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmNvbnRleHRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IHZpc2l0b3IubWVtYmVyKGNvbnRleHRzW2ldLCBuYW1lKTtcclxuICAgICAgICAgICAgaWYgKHZhbHVlICE9PSB2b2lkIDApXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdm9pZCAwO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgdmFyIFRPS0VOUyA9IHsgV0hFUkUsIFFVRVJZLCBJREVOVCwgTUVNQkVSLCBBUFAsIFNFTEVDVCwgQ09OU1QsIFJBTkdFLCBCSU5BUlksIEFXQUlULCBQSVBFLCBDT01QT1NFIH1cclxuIl19