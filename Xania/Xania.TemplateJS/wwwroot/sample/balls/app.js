"use strict";
var xania_1 = require("../../src/xania");
var anim_1 = require("../../src/anim");
var BallsApp = (function () {
    function BallsApp() {
        var _this = this;
        this.balls = [];
        this.onShuffle = function () {
            for (var i = 0; i < _this.balls.length; i++) {
                var e = Math.floor(Math.random() * _this.balls.length);
                if (e !== i) {
                    var t = _this.balls[i].idx;
                    _this.balls[i].idx = _this.balls[e].idx;
                    _this.balls[e].idx = t;
                }
            }
        };
        for (var i = 0; i < 16; i++) {
            this.balls.push(new Ball(i));
        }
    }
    BallsApp.translate3d = function (idx, pressed) {
        var x = (idx % 4) * 70;
        var y = Math.floor(idx / 4) * 70;
        var s = pressed ? 1.2 : 1;
        return "translate3d(" + x + "px, " + y + "px, 0px) scale(" + s + ")";
    };
    BallsApp.initial = function (ball) {
        return this.translate3d(ball.idx, ball.pressed);
    };
    BallsApp.prototype.drag = function (event, ball, state) {
        var movementX = event.movementX, movementY = event.movementY;
        var node = event.target;
        var startX, startY, ballIdx;
        if (state && node.style.marginTop !== 0 && node.style.marginLeft !== 0) {
            movementX += state.movementX;
            movementY += state.movementY;
            startX = state.startX;
            startY = state.startY;
            ballIdx = state.ballIdx;
        }
        else {
            startX = (ball.idx % 4) * 70;
            startY = Math.floor(ball.idx / 4) * 70;
            ballIdx = ball.idx;
        }
        node.style.marginTop = movementY + "px";
        node.style.marginLeft = movementX + "px";
        node.style.zIndex = 100;
        var x = movementX + startX;
        var y = movementY + startY;
        var col = Math.max(0, Math.min(3, Math.round(x / 70)));
        var row = Math.max(0, Math.min(3, Math.round(y / 70)));
        var newBallIdx = col + row * 4;
        if (ballIdx !== newBallIdx) {
            for (var i = 0; i < this.balls.length; i++) {
                var b = this.balls[i];
                if (ball !== b && b.idx === newBallIdx)
                    b.idx = ballIdx;
            }
            ballIdx = newBallIdx;
        }
        return { movementX: movementX, movementY: movementY, startX: startX, startY: startY, ballIdx: ballIdx };
    };
    BallsApp.prototype.release = function (event, ball) {
        if (ball.pressed) {
            ball.pressed = false;
        }
        var node = event.target;
        var top = node.style.marginTop;
        var left = node.style.marginLeft;
        node.style.marginTop = 0;
        node.style.marginLeft = 0;
        node.style.zIndex = 10;
        for (var i = 0; i < this.balls.length; i++) {
            if (!this.balls.find(function (b) { return b.idx === i; })) {
                var x = (ball.idx % 4) * 70;
                var y = Math.floor(ball.idx / 4) * 70;
                var transform = "translate3d(" + left + ", " + top + ", 0) translate3d(" + x + "px, " + y + "px, 0px) scale(1.2)";
                node.style.transform = transform;
                ball.idx = i;
                break;
            }
        }
    };
    BallsApp.prototype.view = function (xania) {
        return (xania.tag("div", { className: "balls-outer" },
            xania.tag("div", null,
                xania.tag("button", { onClick: this.onShuffle }, "shuffle")),
            xania.tag("div", { className: "demo2" },
                xania.tag(xania_1.ForEach, { expr: xania_1.fs("for ball in balls") },
                    xania.tag(anim_1.Animate, { transform: xania_1.fs("translate3d ball.idx ball.pressed") },
                        xania.tag("div", { className: "demo2-ball", onMouseDown: xania_1.fs("ball.press()"), onMouseMove: xania_1.fs("ball.pressed -> drag event ball state"), onMouseUp: xania_1.fs("release event ball"), onMouseOut: xania_1.fs("release event ball"), style: [
                                "background-color: ", xania_1.fs("ball.backColor"),
                                "; transform: ",
                                xania_1.fs("initial ball"),
                                "; z-index: 10; box-shadow: rgba(0, 0, 0, 0.498039) -0.666667px 5px 5px;"
                            ] }))))));
    };
    return BallsApp;
}());
exports.BallsApp = BallsApp;
var Ball = (function () {
    function Ball(idx) {
        this.idx = idx;
        this.pressed = false;
        var r = Math.floor(Math.random() * 155) + 100;
        var g = Math.floor(Math.random() * 155) + 100;
        var b = Math.floor(Math.random() * 155) + 100;
        this.backColor = "rgb(" + r + ", " + g + ", " + b + ")";
    }
    Ball.prototype.press = function () {
        this.pressed = true;
    };
    return Ball;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc2FtcGxlL2JhbGxzL2FwcC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHlDQUFrRTtBQUNsRSx1Q0FBd0M7QUFFeEM7SUFJSTtRQUFBLGlCQUlDO1FBTk8sVUFBSyxHQUFHLEVBQUUsQ0FBQztRQXFCbkIsY0FBUyxHQUFHO1lBQ1IsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUN6QyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxLQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN0RCxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDVixJQUFJLENBQUMsR0FBRyxLQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztvQkFDMUIsS0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsS0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7b0JBQ3RDLEtBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFDMUIsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDLENBQUE7UUEzQkcsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUMxQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pDLENBQUM7SUFDTCxDQUFD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QUssRUFBRTtnQ0FDSCxvQkFBb0IsRUFBRSxVQUFFLENBQUMsZ0JBQWdCLENBQUM7Z0NBQzFDLGVBQWU7Z0NBQ2YsVUFBRSxDQUFDLGNBQWMsQ0FBQztnQ0FDbEIseUVBQXlFOzZCQUFDLEdBQzVFLENBQ0EsQ0FDSixDQUVSLENBQ0osQ0FDVCxDQUFDO0lBQ04sQ0FBQztJQUNMLGVBQUM7QUFBRCxDQUFDLEFBOUhELElBOEhDO0FBOUhZLDRCQUFRO0FBZ0lyQjtJQUNJLGNBQW1CLEdBQVc7UUFBWCxRQUFHLEdBQUgsR0FBRyxDQUFRO1FBTzlCLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFOWixJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7UUFDOUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQzlDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUM5QyxJQUFJLENBQUMsU0FBUyxHQUFHLFNBQU8sQ0FBQyxVQUFLLENBQUMsVUFBSyxDQUFDLE1BQUcsQ0FBQztJQUM3QyxDQUFDO0lBSUQsb0JBQUssR0FBTDtRQUNJLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLENBQUM7SUFHTCxXQUFDO0FBQUQsQ0FBQyxBQWZELElBZUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb3JFYWNoLCBmcywgVGVtcGxhdGUsIFJlYWN0aXZlIH0gZnJvbSBcIi4uLy4uL3NyYy94YW5pYVwiO1xyXG5pbXBvcnQgeyBBbmltYXRlIH0gZnJvbSBcIi4uLy4uL3NyYy9hbmltXCJcclxuXHJcbmV4cG9ydCBjbGFzcyBCYWxsc0FwcCB7XHJcblxyXG4gICAgcHJpdmF0ZSBiYWxscyA9IFtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTY7IGkrKykge1xyXG4gICAgICAgICAgICB0aGlzLmJhbGxzLnB1c2gobmV3IEJhbGwoaSkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgdHJhbnNsYXRlM2QoaWR4LCBwcmVzc2VkKSB7XHJcbiAgICAgICAgdmFyIHggPSAoaWR4ICUgNCkgKiA3MDtcclxuICAgICAgICB2YXIgeSA9IE1hdGguZmxvb3IoaWR4IC8gNCkgKiA3MDtcclxuXHJcbiAgICAgICAgdmFyIHMgPSBwcmVzc2VkID8gMS4yIDogMTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGB0cmFuc2xhdGUzZCgke3h9cHgsICR7eX1weCwgMHB4KSBzY2FsZSgke3N9KWA7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGluaXRpYWwoYmFsbCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZTNkKGJhbGwuaWR4LCBiYWxsLnByZXNzZWQpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU2h1ZmZsZSA9ICgpID0+IHtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuYmFsbHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdmFyIGUgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0aGlzLmJhbGxzLmxlbmd0aCk7XHJcbiAgICAgICAgICAgIGlmIChlICE9PSBpKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuYmFsbHNbaV0uaWR4O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5iYWxsc1tpXS5pZHggPSB0aGlzLmJhbGxzW2VdLmlkeDtcclxuICAgICAgICAgICAgICAgIHRoaXMuYmFsbHNbZV0uaWR4ID0gdDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBkcmFnKGV2ZW50LCBiYWxsLCBzdGF0ZSkge1xyXG4gICAgICAgIHZhciB7IG1vdmVtZW50WCwgbW92ZW1lbnRZIH0gPSBldmVudDtcclxuICAgICAgICB2YXIgbm9kZSA9IGV2ZW50LnRhcmdldDtcclxuXHJcbiAgICAgICAgdmFyIHN0YXJ0WCwgc3RhcnRZLCBiYWxsSWR4O1xyXG4gICAgICAgIGlmIChzdGF0ZSAmJiBub2RlLnN0eWxlLm1hcmdpblRvcCAhPT0gMCAmJiBub2RlLnN0eWxlLm1hcmdpbkxlZnQgIT09IDApIHtcclxuICAgICAgICAgICAgbW92ZW1lbnRYICs9IHN0YXRlLm1vdmVtZW50WDtcclxuICAgICAgICAgICAgbW92ZW1lbnRZICs9IHN0YXRlLm1vdmVtZW50WTtcclxuICAgICAgICAgICAgc3RhcnRYID0gc3RhdGUuc3RhcnRYO1xyXG4gICAgICAgICAgICBzdGFydFkgPSBzdGF0ZS5zdGFydFk7XHJcbiAgICAgICAgICAgIGJhbGxJZHggPSBzdGF0ZS5iYWxsSWR4O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN0YXJ0WCA9IChiYWxsLmlkeCAlIDQpICogNzA7XHJcbiAgICAgICAgICAgIHN0YXJ0WSA9IE1hdGguZmxvb3IoYmFsbC5pZHggLyA0KSAqIDcwO1xyXG4gICAgICAgICAgICBiYWxsSWR4ID0gYmFsbC5pZHg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBub2RlLnN0eWxlLm1hcmdpblRvcCA9IG1vdmVtZW50WSArIFwicHhcIjtcclxuICAgICAgICBub2RlLnN0eWxlLm1hcmdpbkxlZnQgPSBtb3ZlbWVudFggKyBcInB4XCI7XHJcbiAgICAgICAgbm9kZS5zdHlsZS56SW5kZXggPSAxMDA7XHJcblxyXG4gICAgICAgIHZhciB4ID0gbW92ZW1lbnRYICsgc3RhcnRYO1xyXG4gICAgICAgIHZhciB5ID0gbW92ZW1lbnRZICsgc3RhcnRZO1xyXG5cclxuICAgICAgICB2YXIgY29sID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMywgTWF0aC5yb3VuZCh4IC8gNzApKSk7XHJcbiAgICAgICAgdmFyIHJvdyA9IE1hdGgubWF4KDAsIE1hdGgubWluKDMsIE1hdGgucm91bmQoeSAvIDcwKSkpO1xyXG4gICAgICAgIHZhciBuZXdCYWxsSWR4ID0gY29sICsgcm93ICogNDtcclxuXHJcbiAgICAgICAgaWYgKGJhbGxJZHggIT09IG5ld0JhbGxJZHgpIHtcclxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmJhbGxzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYiA9IHRoaXMuYmFsbHNbaV07XHJcbiAgICAgICAgICAgICAgICBpZiAoYmFsbCAhPT0gYiAmJiBiLmlkeCA9PT0gbmV3QmFsbElkeClcclxuICAgICAgICAgICAgICAgICAgICBiLmlkeCA9IGJhbGxJZHg7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgYmFsbElkeCA9IG5ld0JhbGxJZHg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4geyBtb3ZlbWVudFgsIG1vdmVtZW50WSwgc3RhcnRYLCBzdGFydFksIGJhbGxJZHggfTtcclxuICAgIH1cclxuXHJcbiAgICByZWxlYXNlKGV2ZW50LCBiYWxsOiBCYWxsKSB7XHJcbiAgICAgICAgaWYgKGJhbGwucHJlc3NlZCkge1xyXG4gICAgICAgICAgICBiYWxsLnByZXNzZWQgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIG5vZGUgPSBldmVudC50YXJnZXQ7XHJcbiAgICAgICAgdmFyIHRvcCA9IG5vZGUuc3R5bGUubWFyZ2luVG9wO1xyXG4gICAgICAgIHZhciBsZWZ0ID0gbm9kZS5zdHlsZS5tYXJnaW5MZWZ0O1xyXG4gICAgICAgIG5vZGUuc3R5bGUubWFyZ2luVG9wID0gMDtcclxuICAgICAgICBub2RlLnN0eWxlLm1hcmdpbkxlZnQgPSAwO1xyXG4gICAgICAgIG5vZGUuc3R5bGUuekluZGV4ID0gMTA7XHJcblxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5iYWxscy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuYmFsbHMuZmluZChiID0+IGIuaWR4ID09PSBpKSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIHggPSAoYmFsbC5pZHggJSA0KSAqIDcwO1xyXG4gICAgICAgICAgICAgICAgdmFyIHkgPSBNYXRoLmZsb29yKGJhbGwuaWR4IC8gNCkgKiA3MDtcclxuXHJcbiAgICAgICAgICAgICAgICB2YXIgdHJhbnNmb3JtID0gYHRyYW5zbGF0ZTNkKCR7bGVmdH0sICR7dG9wfSwgMCkgdHJhbnNsYXRlM2QoJHt4fXB4LCAke3l9cHgsIDBweCkgc2NhbGUoMS4yKWA7XHJcbiAgICAgICAgICAgICAgICBub2RlLnN0eWxlLnRyYW5zZm9ybSA9IHRyYW5zZm9ybTtcclxuXHJcbiAgICAgICAgICAgICAgICBiYWxsLmlkeCA9IGk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB2aWV3KHhhbmlhKSB7XHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJiYWxscy1vdXRlclwiPlxyXG4gICAgICAgICAgICAgICAgPGRpdj5cclxuICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIG9uQ2xpY2s9e3RoaXMub25TaHVmZmxlfT5zaHVmZmxlPC9idXR0b24+XHJcbiAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPVwiZGVtbzJcIj5cclxuICAgICAgICAgICAgICAgICAgICA8Rm9yRWFjaCBleHByPXtmcyhcImZvciBiYWxsIGluIGJhbGxzXCIpfT5cclxuICAgICAgICAgICAgICAgICAgICAgICAgPEFuaW1hdGUgdHJhbnNmb3JtPXtmcyhcInRyYW5zbGF0ZTNkIGJhbGwuaWR4IGJhbGwucHJlc3NlZFwiKX0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImRlbW8yLWJhbGxcIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTW91c2VEb3duPXtmcyhcImJhbGwucHJlc3MoKVwiKX1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1vdXNlTW92ZT17ZnMoXCJiYWxsLnByZXNzZWQgLT4gZHJhZyBldmVudCBiYWxsIHN0YXRlXCIpfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTW91c2VVcD17ZnMoXCJyZWxlYXNlIGV2ZW50IGJhbGxcIil9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Nb3VzZU91dD17ZnMoXCJyZWxlYXNlIGV2ZW50IGJhbGxcIil9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU9e1tcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJiYWNrZ3JvdW5kLWNvbG9yOiBcIiwgZnMoXCJiYWxsLmJhY2tDb2xvclwiKSAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiOyB0cmFuc2Zvcm06IFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcyhcImluaXRpYWwgYmFsbFwiKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCI7IHotaW5kZXg6IDEwOyBib3gtc2hhZG93OiByZ2JhKDAsIDAsIDAsIDAuNDk4MDM5KSAtMC42NjY2NjdweCA1cHggNXB4O1wiXX0gPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDwvQW5pbWF0ZT5cclxuICAgICAgICAgICAgICAgICAgICA8L0ZvckVhY2g+XHJcblxyXG4gICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIEJhbGwge1xyXG4gICAgY29uc3RydWN0b3IocHVibGljIGlkeDogbnVtYmVyKSB7XHJcbiAgICAgICAgdmFyIHIgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxNTUpICsgMTAwO1xyXG4gICAgICAgIHZhciBnID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMTU1KSArIDEwMDtcclxuICAgICAgICB2YXIgYiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDE1NSkgKyAxMDA7XHJcbiAgICAgICAgdGhpcy5iYWNrQ29sb3IgPSBgcmdiKCR7cn0sICR7Z30sICR7Yn0pYDtcclxuICAgIH1cclxuXHJcbiAgICBwcmVzc2VkID0gZmFsc2U7XHJcblxyXG4gICAgcHJlc3MoKSB7XHJcbiAgICAgICAgdGhpcy5wcmVzc2VkID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBiYWNrQ29sb3I6IHN0cmluZztcclxufSJdfQ==