"use strict";
var xania_1 = require("../../src/xania");
var anim_1 = require("../../src/anim");
require("./app.css");
var BallsApp = (function () {
    function BallsApp() {
        var _this = this;
        this.balls = [];
        this.onShuffle = function () {
            for (var i = 0; i < _this.balls.length; i++) {
                var e = Math.floor(Math.random() * _this.balls.length);
                if (e !== i) {
                    var t = _this.balls[i].idx;
                    _this.balls[i].idx = _this.balls[e].idx;
                    _this.balls[e].idx = t;
                }
            }
        };
        for (var i = 0; i < 16; i++) {
            var rgb = [100, 100, 100]
                .map(function (x) { return x + Math.random() * 150; })
                .map(Math.floor);
            this.balls.push(new Ball(i, "rgb(" + rgb.join(", ") + ")"));
        }
    }
    BallsApp.translate3d = function (idx, pressed) {
        var x = (idx % 4) * 70;
        var y = Math.floor(idx / 4) * 70;
        var s = pressed ? 1.2 : 1;
        return "translate3d(" + x + "px, " + y + "px, 0px) scale(" + s + ")";
    };
    BallsApp.initial = function (ball) {
        return this.translate3d(ball.idx, ball.pressed);
    };
    BallsApp.prototype.drag = function (event, ball, state) {
        var offsetX = event.offsetX, offsetY = event.offsetY;
        var node = event.target;
        var marginLeft, marginTop, dLeft, dTop, ballIdx;
        if (state && node.style.marginTop !== 0 && node.style.marginLeft !== 0) {
            marginLeft = state.marginLeft;
            marginTop = state.marginTop;
            dLeft = state.dLeft;
            dTop = state.dTop;
            ballIdx = state.ballIdx;
        }
        else {
            dLeft = offsetX - 25;
            dTop = offsetY - 25;
            marginLeft = 0;
            marginTop = 0;
            ballIdx = ball.idx;
        }
        marginLeft += offsetX - 25 - dLeft;
        marginTop += offsetY - 25 - dTop;
        node.style.marginLeft = marginLeft + "px";
        node.style.marginTop = marginTop + "px";
        node.style.zIndex = 100;
        var x = marginLeft + (ball.idx % 4) * 70;
        var y = marginTop + Math.floor(ball.idx / 4) * 70;
        var col = Math.max(0, Math.min(3, Math.round(x / 70)));
        var row = Math.max(0, Math.min(3, Math.round(y / 70)));
        var newBallIdx = col + row * 4;
        if (ballIdx !== newBallIdx) {
            for (var i = 0; i < this.balls.length; i++) {
                var b = this.balls[i];
                if (ball !== b && b.idx === newBallIdx)
                    b.idx = ballIdx;
            }
            ballIdx = newBallIdx;
        }
        return { marginTop: marginTop, marginLeft: marginLeft, dLeft: dLeft, dTop: dTop, ballIdx: ballIdx };
    };
    BallsApp.prototype.release = function (event, ball) {
        if (ball.pressed) {
            ball.pressed = false;
        }
        var node = event.target;
        var top = node.style.marginTop;
        var left = node.style.marginLeft;
        node.style.marginTop = 0;
        node.style.marginLeft = 0;
        node.style.zIndex = 10;
        for (var i = 0; i < this.balls.length; i++) {
            if (!this.balls.find(function (b) { return b.idx === i; })) {
                var x = (ball.idx % 4) * 70;
                var y = Math.floor(ball.idx / 4) * 70;
                var transform = "translate3d(" + left + ", " + top + ", 0) translate3d(" + x + "px, " + y + "px, 0px) scale(1.2)";
                node.style.transform = transform;
                ball.idx = i;
                break;
            }
        }
    };
    BallsApp.prototype.view = function (xania) {
        return (xania.tag("div", { className: "balls-outer" },
            xania.tag("div", null,
                xania.tag("button", { onClick: this.onShuffle }, "shuffle")),
            xania.tag("div", { className: "demo2" },
                xania.tag(xania_1.Repeat, { source: xania_1.expr("for ball in balls") },
                    xania.tag(anim_1.Animate, { transform: xania_1.expr("translate3d ball.idx ball.pressed") },
                        xania.tag("div", { className: "demo2-ball", onMouseDown: xania_1.expr("ball.press()"), onMouseMove: xania_1.expr("ball.pressed -> drag event ball state"), onMouseUp: xania_1.expr("release event ball"), onMouseOut: xania_1.expr("release event ball"), style: [
                                "background-color: ", xania_1.expr("ball.backColor"),
                                "; transform: ",
                                xania_1.expr("initial ball"),
                                "; z-index: 10; box-shadow: rgba(0, 0, 0, 0.498039) -0.666667px 5px 5px;"
                            ] }))))));
    };
    return BallsApp;
}());
exports.BallsApp = BallsApp;
var Ball = (function () {
    function Ball(idx, backColor) {
        this.idx = idx;
        this.backColor = backColor;
        this.pressed = false;
    }
    Ball.prototype.press = function () {
        this.pressed = true;
    };
    return Ball;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEseUNBQW1FO0FBQ25FLHVDQUF3QztBQUN4QyxxQkFBa0I7QUFFbEI7SUFJSTtRQUFBLGlCQU9DO1FBVE8sVUFBSyxHQUFHLEVBQUUsQ0FBQztRQXdCbkIsY0FBUyxHQUFHO1lBQ1IsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUN6QyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxLQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN0RCxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDVixJQUFJLENBQUMsR0FBRyxLQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztvQkFDMUIsS0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsS0FBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7b0JBQ3RDLEtBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFDMUIsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDLENBQUE7UUE5QkcsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUMxQixJQUFJLEdBQUcsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO2lCQUNwQixHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLEdB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QUFNLENBQUMsQ0FDSCxtQkFBSyxTQUFTLEVBQUMsYUFBYTtZQUN4QjtnQkFDSSxzQkFBUSxPQUFPLEVBQUUsSUFBSSxDQUFDLFNBQVMsY0FBa0IsQ0FDL0M7WUFDTixtQkFBSyxTQUFTLEVBQUMsT0FBTztnQkFDbEIsVUFBQyxjQUFNLElBQUMsTUFBTSxFQUFFLFlBQUksQ0FBQyxtQkFBbUIsQ0FBQztvQkFDckMsVUFBQyxjQUFPLElBQUMsU0FBUyxFQUFFLFlBQUksQ0FBQyxtQ0FBbUMsQ0FBQzt3QkFDekQsbUJBQUssU0FBUyxFQUFDLFlBQVksRUFDdkIsV0FBVyxFQUFFLFlBQUksQ0FBQyxjQUFjLENBQUMsRUFDakMsV0FBVyxFQUFFLFlBQUksQ0FBQyx1Q0FBdUMsQ0FBQyxFQUMxRCxTQUFTLEVBQUUsWUFBSSxDQUFDLG9CQUFvQixDQUFDLEVBQ3JDLFVBQVUsRUFBRSxZQUFJLENBQUMsb0JBQW9CLENBQUMsRUFDdEMsS0FBSyxFQUFFO2dDQUNILG9CQUFvQixFQUFFLFlBQUksQ0FBQyxnQkFBZ0IsQ0FBQztnQ0FDNUMsZUFBZTtnQ0FDZixZQUFJLENBQUMsY0FBYyxDQUFDO2dDQUNwQix5RUFBeUU7NkJBQUMsR0FDNUUsQ0FDQSxDQUNMLENBQ1AsQ0FDSixDQUNULENBQUM7SUFDTixDQUFDO0lBQ0wsZUFBQztBQUFELENBQUMsQUF0SUQsSUFzSUM7QUF0SVksNEJBQVE7QUF3SXJCO0lBQ0ksY0FBbUIsR0FBVyxFQUFTLFNBQVM7UUFBN0IsUUFBRyxHQUFILEdBQUcsQ0FBUTtRQUFTLGNBQVMsR0FBVCxTQUFTLENBQUE7UUFHaEQsWUFBTyxHQUFHLEtBQUssQ0FBQztJQUZoQixDQUFDO0lBSUQsb0JBQUssR0FBTDtRQUNJLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLENBQUM7SUFDTCxXQUFDO0FBQUQsQ0FBQyxBQVRELElBU0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXBlYXQsIGV4cHIsIFRlbXBsYXRlLCBSZWFjdGl2ZSB9IGZyb20gXCIuLi8uLi9zcmMveGFuaWFcIjtcclxuaW1wb3J0IHsgQW5pbWF0ZSB9IGZyb20gXCIuLi8uLi9zcmMvYW5pbVwiXHJcbmltcG9ydCAnLi9hcHAuY3NzJ1xyXG5cclxuZXhwb3J0IGNsYXNzIEJhbGxzQXBwIHtcclxuXHJcbiAgICBwcml2YXRlIGJhbGxzID0gW107XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxNjsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhciByZ2IgPSBbMTAwLCAxMDAsIDEwMF1cclxuICAgICAgICAgICAgICAgIC5tYXAoeCA9PiB4ICsgTWF0aC5yYW5kb20oKSAqIDE1MClcclxuICAgICAgICAgICAgICAgIC5tYXAoTWF0aC5mbG9vcik7XHJcbiAgICAgICAgICAgIHRoaXMuYmFsbHMucHVzaChuZXcgQmFsbChpLCBgcmdiKCR7cmdiLmpvaW4oXCIsIFwiKX0pYCkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgdHJhbnNsYXRlM2QoaWR4LCBwcmVzc2VkKSB7XHJcbiAgICAgICAgdmFyIHggPSAoaWR4ICUgNCkgKiA3MDtcclxuICAgICAgICB2YXIgeSA9IE1hdGguZmxvb3IoaWR4IC8gNCkgKiA3MDtcclxuXHJcbiAgICAgICAgdmFyIHMgPSBwcmVzc2VkID8gMS4yIDogMTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGB0cmFuc2xhdGUzZCgke3h9cHgsICR7eX1weCwgMHB4KSBzY2FsZSgke3N9KWA7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGluaXRpYWwoYmFsbCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZTNkKGJhbGwuaWR4LCBiYWxsLnByZXNzZWQpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU2h1ZmZsZSA9ICgpID0+IHtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuYmFsbHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdmFyIGUgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0aGlzLmJhbGxzLmxlbmd0aCk7XHJcbiAgICAgICAgICAgIGlmIChlICE9PSBpKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgdCA9IHRoaXMuYmFsbHNbaV0uaWR4O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5iYWxsc1tpXS5pZHggPSB0aGlzLmJhbGxzW2VdLmlkeDtcclxuICAgICAgICAgICAgICAgIHRoaXMuYmFsbHNbZV0uaWR4ID0gdDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBkcmFnKGV2ZW50LCBiYWxsLCBzdGF0ZSkge1xyXG4gICAgICAgIHZhciB7IG9mZnNldFgsIG9mZnNldFkgfSA9IGV2ZW50O1xyXG4gICAgICAgIHZhciBub2RlID0gZXZlbnQudGFyZ2V0O1xyXG4gICAgICAgIFxyXG4gICAgICAgIHZhciBtYXJnaW5MZWZ0LCBtYXJnaW5Ub3AsIGRMZWZ0LCBkVG9wLCBiYWxsSWR4O1xyXG4gICAgICAgIGlmIChzdGF0ZSAmJiBub2RlLnN0eWxlLm1hcmdpblRvcCAhPT0gMCAmJiBub2RlLnN0eWxlLm1hcmdpbkxlZnQgIT09IDApIHtcclxuICAgICAgICAgICAgbWFyZ2luTGVmdCA9IHN0YXRlLm1hcmdpbkxlZnQ7XHJcbiAgICAgICAgICAgIG1hcmdpblRvcCA9IHN0YXRlLm1hcmdpblRvcDtcclxuICAgICAgICAgICAgZExlZnQgPSBzdGF0ZS5kTGVmdDtcclxuICAgICAgICAgICAgZFRvcCA9IHN0YXRlLmRUb3A7XHJcbiAgICAgICAgICAgIGJhbGxJZHggPSBzdGF0ZS5iYWxsSWR4O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGRMZWZ0ID0gb2Zmc2V0WCAtIDI1O1xyXG4gICAgICAgICAgICBkVG9wID0gb2Zmc2V0WSAtIDI1O1xyXG4gICAgICAgICAgICBtYXJnaW5MZWZ0ID0gMDtcclxuICAgICAgICAgICAgbWFyZ2luVG9wID0gMDtcclxuICAgICAgICAgICAgYmFsbElkeCA9IGJhbGwuaWR4O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbWFyZ2luTGVmdCArPSBvZmZzZXRYIC0gMjUgLSBkTGVmdDtcclxuICAgICAgICBtYXJnaW5Ub3AgKz0gb2Zmc2V0WSAtIDI1IC0gZFRvcDtcclxuXHJcbiAgICAgICAgbm9kZS5zdHlsZS5tYXJnaW5MZWZ0ID0gbWFyZ2luTGVmdCArIFwicHhcIjtcclxuICAgICAgICBub2RlLnN0eWxlLm1hcmdpblRvcCA9IG1hcmdpblRvcCArIFwicHhcIjtcclxuICAgICAgICBub2RlLnN0eWxlLnpJbmRleCA9IDEwMDtcclxuXHJcblxyXG4gICAgICAgIHZhciB4ID0gbWFyZ2luTGVmdCArIChiYWxsLmlkeCAlIDQpICogNzA7XHJcbiAgICAgICAgdmFyIHkgPSBtYXJnaW5Ub3AgKyBNYXRoLmZsb29yKGJhbGwuaWR4IC8gNCkgKiA3MDtcclxuXHJcbiAgICAgICAgdmFyIGNvbCA9IE1hdGgubWF4KDAsIE1hdGgubWluKDMsIE1hdGgucm91bmQoeCAvIDcwKSkpO1xyXG4gICAgICAgIHZhciByb3cgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigzLCBNYXRoLnJvdW5kKHkgLyA3MCkpKTtcclxuICAgICAgICB2YXIgbmV3QmFsbElkeCA9IGNvbCArIHJvdyAqIDQ7XHJcblxyXG4gICAgICAgIGlmIChiYWxsSWR4ICE9PSBuZXdCYWxsSWR4KSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5iYWxscy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgdmFyIGIgPSB0aGlzLmJhbGxzW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYgKGJhbGwgIT09IGIgJiYgYi5pZHggPT09IG5ld0JhbGxJZHgpXHJcbiAgICAgICAgICAgICAgICAgICAgYi5pZHggPSBiYWxsSWR4O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGJhbGxJZHggPSBuZXdCYWxsSWR4O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHsgbWFyZ2luVG9wLCBtYXJnaW5MZWZ0LCBkTGVmdCwgZFRvcCwgYmFsbElkeCB9O1xyXG4gICAgfVxyXG5cclxuICAgIHJlbGVhc2UoZXZlbnQsIGJhbGw6IEJhbGwpIHtcclxuICAgICAgICBpZiAoYmFsbC5wcmVzc2VkKSB7XHJcbiAgICAgICAgICAgIGJhbGwucHJlc3NlZCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgbm9kZSA9IGV2ZW50LnRhcmdldDtcclxuICAgICAgICB2YXIgdG9wID0gbm9kZS5zdHlsZS5tYXJnaW5Ub3A7XHJcbiAgICAgICAgdmFyIGxlZnQgPSBub2RlLnN0eWxlLm1hcmdpbkxlZnQ7XHJcbiAgICAgICAgbm9kZS5zdHlsZS5tYXJnaW5Ub3AgPSAwO1xyXG4gICAgICAgIG5vZGUuc3R5bGUubWFyZ2luTGVmdCA9IDA7XHJcbiAgICAgICAgbm9kZS5zdHlsZS56SW5kZXggPSAxMDtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmJhbGxzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5iYWxscy5maW5kKGIgPT4gYi5pZHggPT09IGkpKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgeCA9IChiYWxsLmlkeCAlIDQpICogNzA7XHJcbiAgICAgICAgICAgICAgICB2YXIgeSA9IE1hdGguZmxvb3IoYmFsbC5pZHggLyA0KSAqIDcwO1xyXG5cclxuICAgICAgICAgICAgICAgIHZhciB0cmFuc2Zvcm0gPSBgdHJhbnNsYXRlM2QoJHtsZWZ0fSwgJHt0b3B9LCAwKSB0cmFuc2xhdGUzZCgke3h9cHgsICR7eX1weCwgMHB4KSBzY2FsZSgxLjIpYDtcclxuICAgICAgICAgICAgICAgIG5vZGUuc3R5bGUudHJhbnNmb3JtID0gdHJhbnNmb3JtO1xyXG5cclxuICAgICAgICAgICAgICAgIGJhbGwuaWR4ID0gaTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHZpZXcoeGFuaWEpIHtcclxuICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT1cImJhbGxzLW91dGVyXCI+XHJcbiAgICAgICAgICAgICAgICA8ZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgIDxidXR0b24gb25DbGljaz17dGhpcy5vblNodWZmbGV9PnNodWZmbGU8L2J1dHRvbj5cclxuICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJkZW1vMlwiPlxyXG4gICAgICAgICAgICAgICAgICAgIDxSZXBlYXQgc291cmNlPXtleHByKFwiZm9yIGJhbGwgaW4gYmFsbHNcIil9PlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8QW5pbWF0ZSB0cmFuc2Zvcm09e2V4cHIoXCJ0cmFuc2xhdGUzZCBiYWxsLmlkeCBiYWxsLnByZXNzZWRcIil9PlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9XCJkZW1vMi1iYWxsXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1vdXNlRG93bj17ZXhwcihcImJhbGwucHJlc3MoKVwiKX1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1vdXNlTW92ZT17ZXhwcihcImJhbGwucHJlc3NlZCAtPiBkcmFnIGV2ZW50IGJhbGwgc3RhdGVcIil9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Nb3VzZVVwPXtleHByKFwicmVsZWFzZSBldmVudCBiYWxsXCIpfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTW91c2VPdXQ9e2V4cHIoXCJyZWxlYXNlIGV2ZW50IGJhbGxcIil9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU9e1tcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJiYWNrZ3JvdW5kLWNvbG9yOiBcIiwgZXhwcihcImJhbGwuYmFja0NvbG9yXCIpICxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCI7IHRyYW5zZm9ybTogXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cHIoXCJpbml0aWFsIGJhbGxcIiksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiOyB6LWluZGV4OiAxMDsgYm94LXNoYWRvdzogcmdiYSgwLCAwLCAwLCAwLjQ5ODAzOSkgLTAuNjY2NjY3cHggNXB4IDVweDtcIl19ID5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8L0FuaW1hdGU+XHJcbiAgICAgICAgICAgICAgICAgICAgPC9SZXBlYXQ+XHJcbiAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgKTtcclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgQmFsbCB7XHJcbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgaWR4OiBudW1iZXIsIHB1YmxpYyBiYWNrQ29sb3IpIHtcclxuICAgIH1cclxuXHJcbiAgICBwcmVzc2VkID0gZmFsc2U7XHJcblxyXG4gICAgcHJlc3MoKSB7XHJcbiAgICAgICAgdGhpcy5wcmVzc2VkID0gdHJ1ZTtcclxuICAgIH1cclxufVxyXG4iXX0=