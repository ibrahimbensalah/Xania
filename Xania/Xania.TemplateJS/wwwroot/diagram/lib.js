"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
require("./diagram.css");
var dom_1 = require("../src/dom");
var compile_1 = require("../src/compile");
var GraphApp = (function () {
    function GraphApp() {
        this.P1 = { x: 100, y: 10 };
        this.P2 = { x: 400, y: 100 };
    }
    GraphApp.horizontalArrow = function (_a, _b) {
        var x1 = _a.x, y1 = _a.y;
        var x2 = _b.x, y2 = _b.y;
        var d = (x2 - x1) / 2;
        return "m" + x1 + "," + y1 + " C" + (x1 + d) + "," + y1 + " " + (x2 - d) + "," + y2 + " " + x2 + "," + y2;
    };
    GraphApp.input = function (x, y) {
        return { x: x, y: y + 50 };
    };
    GraphApp.output = function (x, y) {
        return { x: x + 100, y: y + 50 };
    };
    GraphApp.prototype.view = function (xania) {
        return (xania.tag("div", { style: "height: 100%;" },
            xania.tag("div", { className: ["xania-diagram", compile_1.default("pressed -> ' pressed'")] },
                xania.tag(Draggable, { x: compile_1.default("P1.x"), y: compile_1.default("P1.y"), style: "background-color: blue;" }),
                xania.tag(Draggable, { x: compile_1.default("P2.x"), y: compile_1.default("P2.y"), style: "background-color: orange;" }),
                xania.tag("svg", null,
                    xania.tag("g", null,
                        xania.tag("path", { d: compile_1.default("horizontalArrow (output P1.x P1.y) (input P2.x P2.y)"), stroke: "black" }))))));
    };
    return GraphApp;
}());
exports.GraphApp = GraphApp;
var Canvas = (function () {
    function Canvas(attrs, children) {
        this.attrs = attrs;
        this.children = children;
    }
    Canvas.prototype.bind = function () {
        var tag = new dom_1.Dom.TagBinding("div", null, this.children.map(function (x) { return x.bind(); })), attrs = this.attrs;
        for (var prop in attrs) {
            if (attrs.hasOwnProperty(prop)) {
                var attrValue = attrs[prop];
                tag.attr(prop.toLowerCase(), attrValue);
            }
        }
        return tag;
    };
    return Canvas;
}());
var Draggable = (function () {
    function Draggable(attrs, children) {
        this.attrs = attrs;
        this.children = children;
    }
    Draggable.prototype.bind = function () {
        var tag = new DraggableBinding(this.attrs.x, this.attrs.y, this.children.map(function (x) { return x.bind(); })), attrs = this.attrs;
        tag.attr("class", "xania-draggable");
        for (var prop in attrs) {
            if (attrs.hasOwnProperty(prop) && prop !== "x" && prop !== "y") {
                var attrValue = attrs[prop];
                if (prop === "className" || prop === "classname" || prop === "clazz")
                    tag.attr("class", "xania-draggable " + attrValue);
                else
                    tag.attr(prop.toLowerCase(), attrValue);
            }
        }
        return tag;
    };
    return Draggable;
}());
var DraggableBinding = (function (_super) {
    __extends(DraggableBinding, _super);
    function DraggableBinding(x, y, childBindings) {
        var _this = _super.call(this, "div", null, childBindings) || this;
        _this.x = x;
        _this.y = y;
        _this.pressed = null;
        _this.state = { left: 0, top: 0, clientX: 0, clientY: 0 };
        _this.press = function (event) {
            var clientX = event.clientX, clientY = event.clientY, target = event.target;
            do {
                if (target.classList.contains("xania-draggable"))
                    break;
                target = target.parentElement;
            } while (target);
            if (!target)
                return;
            var _a = window.getComputedStyle(target), top = _a.top, left = _a.left;
            _this.state = {
                top: DraggableBinding.prixels(top),
                left: DraggableBinding.prixels(left),
                clientX: clientX,
                clientY: clientY
            };
            _this.pressed = target;
        };
        _this.release = function (event) {
            _this.pressed = null;
            _this.state = null;
        };
        _this.drag = function (event) {
            if (event.buttons !== 1)
                return;
            var clientX = event.clientX, clientY = event.clientY;
            var state = _this.state;
            if (!state)
                return;
            var left = state.left + clientX - state.clientX;
            var top = state.top + clientY - state.clientY;
            if (state.left !== left || state.top !== top) {
                state.clientX = clientX;
                state.clientY = clientY;
                state.left = left;
                state.top = top;
                var x = _this.evaluateObject(_this.x);
                var y = _this.evaluateObject(_this.y);
                x.set(left);
                y.set(top);
            }
        };
        _this.event("mousedown", _this.press);
        _this.event("mousemove", _this.drag);
        _this.event("mouseup", _this.release);
        return _this;
    }
    DraggableBinding.prixels = function (px) {
        return parseFloat(px.replace("px", "")) || 0;
    };
    DraggableBinding.prototype.render = function (context, driver) {
        _super.prototype.render.call(this, context, driver);
        var x = this.evaluateText(this.x);
        var y = this.evaluateText(this.y);
        var style = this.tagNode.style;
        style.left = x + "px";
        style.top = y + "px";
    };
    return DraggableBinding;
}(dom_1.Dom.TagBinding));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibGliLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSx5QkFBc0I7QUFFdEIsa0NBQWlDO0FBQ2pDLDBDQUFrQztBQUVsQztJQUFBO1FBRVksT0FBRSxHQUFVLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDOUIsT0FBRSxHQUFVLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7SUE2QjNDLENBQUM7SUEzQlUsd0JBQWUsR0FBdEIsVUFBdUIsRUFBYyxFQUFFLEVBQWM7WUFBN0IsU0FBSyxFQUFFLFNBQUs7WUFBSSxTQUFLLEVBQUUsU0FBSztRQUNoRCxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEIsTUFBTSxDQUFDLE1BQUksRUFBRSxTQUFJLEVBQUUsV0FBSyxFQUFFLEdBQUcsQ0FBQyxVQUFJLEVBQUUsVUFBSSxFQUFFLEdBQUcsQ0FBQyxVQUFJLEVBQUUsU0FBSSxFQUFFLFNBQUksRUFBSSxDQUFDO0lBQ3ZFLENBQUM7SUFFTSxjQUFLLEdBQVosVUFBYSxDQUFDLEVBQUUsQ0FBQztRQUNiLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBQSxFQUFFLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUNNLGVBQU0sR0FBYixVQUFjLENBQUMsRUFBRSxDQUFDO1FBQ2QsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0lBRUQsdUJBQUksR0FBSixVQUFLLEtBQUs7UUFDTixNQUFNLENBQUMsQ0FDSCxtQkFBSyxLQUFLLEVBQUMsZUFBZTtZQUN0QixtQkFBSyxTQUFTLEVBQUUsQ0FB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bnRlbnQiOlsiaW1wb3J0ICcuL2RpYWdyYW0uY3NzJ1xyXG5pbXBvcnQgeyBUZW1wbGF0ZSB9IGZyb20gXCIuLi9zcmMvdGVtcGxhdGVcIjtcclxuaW1wb3J0IHsgRG9tIH0gZnJvbSBcIi4uL3NyYy9kb21cIjtcclxuaW1wb3J0IGV4cHIgZnJvbSBcIi4uL3NyYy9jb21waWxlXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgR3JhcGhBcHAge1xyXG5cclxuICAgIHByaXZhdGUgUDE6IFBvaW50ID0geyB4OiAxMDAsIHk6IDEwIH07XHJcbiAgICBwcml2YXRlIFAyOiBQb2ludCA9IHsgeDogNDAwLCB5OiAxMDAgfTtcclxuXHJcbiAgICBzdGF0aWMgaG9yaXpvbnRhbEFycm93KHt4OiB4MSwgeTogeTF9LCB7eDogeDIsIHk6IHkyfSkge1xyXG4gICAgICAgIHZhciBkID0gKHgyIC0geDEpIC8gMjtcclxuICAgICAgICByZXR1cm4gYG0ke3gxfSwke3kxfSBDJHt4MSArIGR9LCR7eTF9ICR7eDIgLSBkfSwke3kyfSAke3gyfSwke3kyfWA7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGlucHV0KHgsIHkpIHtcclxuICAgICAgICByZXR1cm4geyB4LCB5OiB5ICsgNTAgfTtcclxuICAgIH1cclxuICAgIHN0YXRpYyBvdXRwdXQoeCwgeSkge1xyXG4gICAgICAgIHJldHVybiB7IHg6IHggKyAxMDAsIHk6IHkgKyA1MCB9O1xyXG4gICAgfVxyXG5cclxuICAgIHZpZXcoeGFuaWEpIHtcclxuICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICA8ZGl2IHN0eWxlPVwiaGVpZ2h0OiAxMDAlO1wiPlxyXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e1tcInhhbmlhLWRpYWdyYW1cIiwgZXhwcihcInByZXNzZWQgLT4gJyBwcmVzc2VkJ1wiKV19PlxyXG4gICAgICAgICAgICAgICAgICAgIDxEcmFnZ2FibGUgeD17ZXhwcihcIlAxLnhcIil9IHk9e2V4cHIoXCJQMS55XCIpfSBzdHlsZT1cImJhY2tncm91bmQtY29sb3I6IGJsdWU7XCIgLz5cclxuICAgICAgICAgICAgICAgICAgICA8RHJhZ2dhYmxlIHg9e2V4cHIoXCJQMi54XCIpfSB5PXtleHByKFwiUDIueVwiKX0gc3R5bGU9XCJiYWNrZ3JvdW5kLWNvbG9yOiBvcmFuZ2U7XCIgLz5cclxuICAgICAgICAgICAgICAgICAgICA8c3ZnPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8Zz5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxwYXRoIGQ9e2V4cHIoXCJob3Jpem9udGFsQXJyb3cgKG91dHB1dCBQMS54IFAxLnkpIChpbnB1dCBQMi54IFAyLnkpXCIpfSBzdHJva2U9XCJibGFja1wiIC8+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDwvZz5cclxuICAgICAgICAgICAgICAgICAgICA8L3N2Zz5cclxuICAgICAgICAgICAgICAgIDwvZGl2PlxyXG4gICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICApO1xyXG4gICAgfVxyXG59XHJcblxyXG5pbnRlcmZhY2UgUG9pbnQge1xyXG4gICAgeDogbnVtYmVyO1xyXG4gICAgeTogbnVtYmVyO1xyXG59XHJcblxyXG5jbGFzcyBDYW52YXMge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhdHRycywgcHJpdmF0ZSBjaGlsZHJlbikge1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBiaW5kKCkge1xyXG4gICAgICAgIHZhciB0YWcgPSBuZXcgRG9tLlRhZ0JpbmRpbmcoXCJkaXZcIiwgbnVsbCwgdGhpcy5jaGlsZHJlbi5tYXAoeCA9PiB4LmJpbmQoKSkpLFxyXG4gICAgICAgICAgICBhdHRycyA9IHRoaXMuYXR0cnM7XHJcblxyXG4gICAgICAgIGZvciAodmFyIHByb3AgaW4gYXR0cnMpIHtcclxuICAgICAgICAgICAgaWYgKGF0dHJzLmhhc093blByb3BlcnR5KHByb3ApKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXR0clZhbHVlID0gYXR0cnNbcHJvcF07XHJcbiAgICAgICAgICAgICAgICB0YWcuYXR0cihwcm9wLnRvTG93ZXJDYXNlKCksIGF0dHJWYWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0YWc7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIERyYWdnYWJsZSB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGF0dHJzLCBwcml2YXRlIGNoaWxkcmVuKSB7XHJcbiAgICB9XHJcblxyXG4gICAgYmluZCgpIHtcclxuICAgICAgICB2YXIgdGFnID0gbmV3IERyYWdnYWJsZUJpbmRpbmcodGhpcy5hdHRycy54LCB0aGlzLmF0dHJzLnksIHRoaXMuY2hpbGRyZW4ubWFwKHggPT4geC5iaW5kKCkpKSxcclxuICAgICAgICAgICAgYXR0cnMgPSB0aGlzLmF0dHJzO1xyXG5cclxuICAgICAgICB0YWcuYXR0cihcImNsYXNzXCIsIFwieGFuaWEtZHJhZ2dhYmxlXCIpO1xyXG4gICAgICAgIGZvciAodmFyIHByb3AgaW4gYXR0cnMpIHtcclxuICAgICAgICAgICAgaWYgKGF0dHJzLmhhc093blByb3BlcnR5KHByb3ApICYmIHByb3AgIT09IFwieFwiICYmIHByb3AgIT09IFwieVwiKSB7XHJcbiAgICAgICAgICAgICAgICB2YXIgYXR0clZhbHVlID0gYXR0cnNbcHJvcF07XHJcbiAgICAgICAgICAgICAgICBpZiAocHJvcCA9PT0gXCJjbGFzc05hbWVcIiB8fCBwcm9wID09PSBcImNsYXNzbmFtZVwiIHx8IHByb3AgPT09IFwiY2xhenpcIilcclxuICAgICAgICAgICAgICAgICAgICB0YWcuYXR0cihcImNsYXNzXCIsIFwieGFuaWEtZHJhZ2dhYmxlIFwiICsgYXR0clZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgICAgICB0YWcuYXR0cihwcm9wLnRvTG93ZXJDYXNlKCksIGF0dHJWYWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0YWc7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIERyYWdnYWJsZUJpbmRpbmcgZXh0ZW5kcyBEb20uVGFnQmluZGluZyB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHgsIHByaXZhdGUgeSwgY2hpbGRCaW5kaW5ncykge1xyXG4gICAgICAgIHN1cGVyKFwiZGl2XCIsIG51bGwsIGNoaWxkQmluZGluZ3MpO1xyXG4gICAgICAgIHRoaXMuZXZlbnQoXCJtb3VzZWRvd25cIiwgdGhpcy5wcmVzcyk7XHJcbiAgICAgICAgdGhpcy5ldmVudChcIm1vdXNlbW92ZVwiLCB0aGlzLmRyYWcpO1xyXG4gICAgICAgIHRoaXMuZXZlbnQoXCJtb3VzZXVwXCIsIHRoaXMucmVsZWFzZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwcmVzc2VkOiBhbnkgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBzdGF0ZSA9IHsgbGVmdDogMCwgdG9wOiAwLCBjbGllbnRYOiAwLCBjbGllbnRZOiAwIH07XHJcblxyXG4gICAgcHJpdmF0ZSBwcmVzcyA9IGV2ZW50ID0+IHtcclxuICAgICAgICB2YXIgeyBjbGllbnRYLCBjbGllbnRZLCB0YXJnZXQgfSA9IGV2ZW50O1xyXG5cclxuICAgICAgICBkbyB7XHJcbiAgICAgICAgICAgIGlmICh0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKFwieGFuaWEtZHJhZ2dhYmxlXCIpKVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnRFbGVtZW50O1xyXG4gICAgICAgIH0gd2hpbGUgKHRhcmdldCk7XHJcblxyXG4gICAgICAgIGlmICghdGFyZ2V0KVxyXG4gICAgICAgICAgICByZXR1cm47XHJcblxyXG4gICAgICAgIHZhciB7IHRvcCwgbGVmdCB9ID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGFyZ2V0KTtcclxuXHJcbiAgICAgICAgdGhpcy5zdGF0ZSA9IHtcclxuICAgICAgICAgICAgdG9wOiBEcmFnZ2FibGVCaW5kaW5nLnByaXhlbHModG9wKSxcclxuICAgICAgICAgICAgbGVmdDogRHJhZ2dhYmxlQmluZGluZy5wcml4ZWxzKGxlZnQpLFxyXG4gICAgICAgICAgICBjbGllbnRYLFxyXG4gICAgICAgICAgICBjbGllbnRZXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnByZXNzZWQgPSB0YXJnZXQ7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHByaXhlbHMocHg6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHB4LnJlcGxhY2UoXCJweFwiLCBcIlwiKSkgfHwgMDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlbGVhc2UgPSBldmVudCA9PiB7XHJcbiAgICAgICAgdGhpcy5wcmVzc2VkID0gbnVsbDtcclxuICAgICAgICB0aGlzLnN0YXRlID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGRyYWcgPSBldmVudCA9PiB7XHJcbiAgICAgICAgaWYgKGV2ZW50LmJ1dHRvbnMgIT09IDEpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgdmFyIHsgY2xpZW50WCwgY2xpZW50WSB9ID0gZXZlbnQ7XHJcbiAgICAgICAgdmFyIHsgc3RhdGUgfSA9IHRoaXM7XHJcblxyXG4gICAgICAgIGlmICghc3RhdGUpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgdmFyIGxlZnQgPSBzdGF0ZS5sZWZ0ICsgY2xpZW50WCAtIHN0YXRlLmNsaWVudFg7XHJcbiAgICAgICAgdmFyIHRvcCA9IHN0YXRlLnRvcCArIGNsaWVudFkgLSBzdGF0ZS5jbGllbnRZO1xyXG5cclxuICAgICAgICBpZiAoc3RhdGUubGVmdCAhPT0gbGVmdCB8fCBzdGF0ZS50b3AgIT09IHRvcCkge1xyXG4gICAgICAgICAgICBzdGF0ZS5jbGllbnRYID0gY2xpZW50WDtcclxuICAgICAgICAgICAgc3RhdGUuY2xpZW50WSA9IGNsaWVudFk7XHJcbiAgICAgICAgICAgIHN0YXRlLmxlZnQgPSBsZWZ0O1xyXG4gICAgICAgICAgICBzdGF0ZS50b3AgPSB0b3A7XHJcblxyXG4gICAgICAgICAgICB2YXIgeCA9IHRoaXMuZXZhbHVhdGVPYmplY3QodGhpcy54KTtcclxuICAgICAgICAgICAgdmFyIHkgPSB0aGlzLmV2YWx1YXRlT2JqZWN0KHRoaXMueSk7XHJcbiAgICAgICAgICAgIHguc2V0KGxlZnQpO1xyXG4gICAgICAgICAgICB5LnNldCh0b3ApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZW5kZXIoY29udGV4dCwgZHJpdmVyKSB7XHJcbiAgICAgICAgc3VwZXIucmVuZGVyKGNvbnRleHQsIGRyaXZlcik7XHJcblxyXG4gICAgICAgIHZhciB4ID0gdGhpcy5ldmFsdWF0ZVRleHQodGhpcy54KTtcclxuICAgICAgICB2YXIgeSA9IHRoaXMuZXZhbHVhdGVUZXh0KHRoaXMueSk7XHJcblxyXG4gICAgICAgIHZhciBzdHlsZSA9IHRoaXMudGFnTm9kZS5zdHlsZTtcclxuICAgICAgICBzdHlsZS5sZWZ0ID0geCArIFwicHhcIjtcclxuICAgICAgICBzdHlsZS50b3AgPSB5ICsgXCJweFwiO1xyXG4gICAgfVxyXG59Il19