"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
require("./diagram.css");
var dom_1 = require("../src/dom");
var compile_1 = require("../src/compile");
var GraphApp = (function () {
    function GraphApp() {
        this.P1 = { x: 10, y: 10 };
        this.P2 = { x: 300, y: 200 };
    }
    GraphApp.horizontalArrow = function (x1, y1, x2, y2) {
        var d = (x2 - x1) / 2;
        return "m" + x1 + "," + y1 + " C" + (x1 + d) + "," + y1 + " " + (x2 - d) + "," + y2 + " " + x2 + "," + y2;
    };
    GraphApp.prototype.move = function (x, y) {
        this.P2.x = x;
        this.P2.y = y + 50;
    };
    GraphApp.prototype.view = function (xania) {
        return (xania.tag("div", null,
            xania.tag("div", { className: ["xania-diagram", compile_1.default("pressed -> ' pressed'")] },
                xania.tag(Draggable, { style: "background-color: orange;", onMove: compile_1.default("move x y") }),
                xania.tag("svg", null,
                    xania.tag("g", null,
                        xania.tag("path", { d: compile_1.default("horizontalArrow P1.x P1.y P2.x P2.y"), stroke: "black" }))))));
    };
    return GraphApp;
}());
exports.GraphApp = GraphApp;
var Canvas = (function () {
    function Canvas(attrs, children) {
        this.attrs = attrs;
        this.children = children;
    }
    Canvas.prototype.bind = function () {
        var tag = new dom_1.Dom.TagBinding("div", null, this.children.map(function (x) { return x.bind(); })), attrs = this.attrs;
        for (var prop in attrs) {
            if (attrs.hasOwnProperty(prop)) {
                var attrValue = attrs[prop];
                tag.attr(prop.toLowerCase(), attrValue);
            }
        }
        return tag;
    };
    return Canvas;
}());
var Draggable = (function () {
    function Draggable(attrs, children) {
        var _this = this;
        this.attrs = attrs;
        this.children = children;
        this.pressed = null;
        this.state = { left: 0, top: 0, clientX: 0, clientY: 0 };
        this.press = function (event) {
            event.stopPropagation();
            var clientX = event.clientX, clientY = event.clientY, target = event.target;
            do {
                if (target.classList.contains("xania-draggable"))
                    break;
                target = target.parentElement;
            } while (target);
            if (!target)
                return;
            var _a = window.getComputedStyle(target), top = _a.top, left = _a.left;
            _this.state = {
                top: Draggable.prixels(top),
                left: Draggable.prixels(left),
                clientX: clientX,
                clientY: clientY
            };
            _this.pressed = target;
        };
        this.release = function (event) {
            _this.pressed = null;
            _this.state = null;
        };
        this.drag = function (event) {
            if (!_this.pressed || event.buttons !== 1)
                return false;
            var clientX = event.clientX, clientY = event.clientY;
            var _a = _this, pressed = _a.pressed, state = _a.state;
            var left = state.left + clientX - state.clientX;
            var top = state.top + clientY - state.clientY;
            if (state.left !== left || state.top !== top) {
                pressed.style.left = state.left + "px";
                pressed.style.top = state.top + "px";
                state.clientX = clientX;
                state.clientY = clientY;
                state.left = left;
                state.top = top;
                return true;
            }
            return false;
        };
    }
    Draggable.prixels = function (px) {
        return parseFloat(px.replace("px", "")) || 0;
    };
    Draggable.prototype.bind = function () {
        var _this = this;
        var tag = new DraggableBinding(this.children.map(function (x) { return x.bind(); })), attrs = this.attrs;
        tag.event("mousedown", this.press);
        tag.event("mousemove", function (event) {
            if (_this.drag(event)) {
                tag.trigger("move", event, { x: _this.state.left, y: _this.state.top });
            }
        });
        tag.event("mouseup", this.release);
        tag.attr("class", "xania-draggable");
        for (var prop in attrs) {
            if (attrs.hasOwnProperty(prop)) {
                var attrValue = attrs[prop];
                if (prop === "className" || prop === "classname" || prop === "clazz")
                    tag.attr("class", "xania-draggable " + attrValue);
                else
                    tag.attr(prop.toLowerCase(), attrValue);
            }
        }
        return tag;
    };
    return Draggable;
}());
var DraggableBinding = (function (_super) {
    __extends(DraggableBinding, _super);
    function DraggableBinding(childBindings) {
        return _super.call(this, "div", null, childBindings) || this;
    }
    DraggableBinding.prototype.render = function (context, driver) {
        _super.prototype.render.call(this, context, {
            insert: function (binding, dom, idx) {
                driver.insert(binding, dom, idx);
            }
        });
    };
    return DraggableBinding;
}(dom_1.Dom.TagBinding));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibGliLnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSx5QkFBc0I7QUFFdEIsa0NBQWlDO0FBQ2pDLDBDQUFvQztBQUVwQztJQUFBO1FBRVksT0FBRSxHQUFVLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDN0IsT0FBRSxHQUFVLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7SUEwQjNDLENBQUM7SUF4QlUsd0JBQWUsR0FBdEIsVUFBdUIsRUFBVSxFQUFFLEVBQVUsRUFBRSxFQUFVLEVBQUUsRUFBVTtRQUNqRSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEIsTUFBTSxDQUFDLE1BQUksRUFBRSxTQUFJLEVBQUUsV0FBSyxFQUFFLEdBQUcsQ0FBQyxVQUFJLEVBQUUsVUFBSSxFQUFFLEdBQUcsQ0FBQyxVQUFJLEVBQUUsU0FBSSxFQUFFLFNBQUksRUFBSSxDQUFDO0lBQ3ZFLENBQUM7SUFFRCx1QkFBSSxHQUFKLFVBQUssQ0FBQyxFQUFFLENBQUM7UUFDTCxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDZCxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCx1QkFBSSxHQUFKLFVBQUssS0FBSztRQUNOLE1BQU0sQ0FBQyxDQUNIO1lBQ0ksbUJBQUssU0FBUyxFQUFFLENBQUMsZUFBZSxFQUFFLGlCQUFPLENBQUMsdUJBQXVCLENBQUMsQ0FBQztnQkFDL0QsVUFBQyxTQUFTLElBQUMsS0FBSyxFQUFDLDJCQUEyQixFQUFDLE1BQU0sRUFBRSxpQkFBTyxDQUFDLFVBQVUsQ0FBQyxHQUFJO2dCQUM1RTtvQkFDSTt3QkFDSSxvQkFB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QUNBLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ2hELENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxDQUFDLEdBQUcsQ0FBQztJQUNmLENBQUM7SUFDTCxnQkFBQztBQUFELENBQUMsQUExRkQsSUEwRkM7QUFFRDtJQUErQixvQ0FBYztJQUN6QywwQkFBWSxhQUFhO2VBQ3JCLGtCQUFNLEtBQUssRUFBRSxJQUFJLEVBQUUsYUFBYSxDQUFDO0lBQ3JDLENBQUM7SUFFRCxpQ0FBTSxHQUFOLFVBQU8sT0FBTyxFQUFFLE1BQU07UUFDbEIsaUJBQU0sTUFBTSxZQUFDLE9BQU8sRUFBRTtZQUNsQixNQUFNLFlBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHO2dCQUNwQixNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDckMsQ0FBQztTQUNKLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDTCx1QkFBQztBQUFELENBQUMsQUFaRCxDQUErQixTQUFHLENBQUMsVUFBVSxHQVk1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnLi9kaWFncmFtLmNzcydcclxuaW1wb3J0IHsgVGVtcGxhdGUgfSBmcm9tIFwiLi4vc3JjL3RlbXBsYXRlXCI7XHJcbmltcG9ydCB7IERvbSB9IGZyb20gXCIuLi9zcmMvZG9tXCI7XHJcbmltcG9ydCBjb21waWxlIGZyb20gXCIuLi9zcmMvY29tcGlsZVwiXHJcblxyXG5leHBvcnQgY2xhc3MgR3JhcGhBcHAge1xyXG5cclxuICAgIHByaXZhdGUgUDE6IFBvaW50ID0geyB4OiAxMCwgeTogMTAgfTtcclxuICAgIHByaXZhdGUgUDI6IFBvaW50ID0geyB4OiAzMDAsIHk6IDIwMCB9O1xyXG5cclxuICAgIHN0YXRpYyBob3Jpem9udGFsQXJyb3coeDE6IG51bWJlciwgeTE6IG51bWJlciwgeDI6IG51bWJlciwgeTI6IG51bWJlcikge1xyXG4gICAgICAgIHZhciBkID0gKHgyIC0geDEpIC8gMjtcclxuICAgICAgICByZXR1cm4gYG0ke3gxfSwke3kxfSBDJHt4MSArIGR9LCR7eTF9ICR7eDIgLSBkfSwke3kyfSAke3gyfSwke3kyfWA7XHJcbiAgICB9XHJcblxyXG4gICAgbW92ZSh4LCB5KSB7XHJcbiAgICAgICAgdGhpcy5QMi54ID0geDtcclxuICAgICAgICB0aGlzLlAyLnkgPSB5ICsgNTA7XHJcbiAgICB9XHJcblxyXG4gICAgdmlldyh4YW5pYSkge1xyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgIDxkaXY+XHJcbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17W1wieGFuaWEtZGlhZ3JhbVwiLCBjb21waWxlKFwicHJlc3NlZCAtPiAnIHByZXNzZWQnXCIpXX0+XHJcbiAgICAgICAgICAgICAgICAgICAgPERyYWdnYWJsZSBzdHlsZT1cImJhY2tncm91bmQtY29sb3I6IG9yYW5nZTtcIiBvbk1vdmU9e2NvbXBpbGUoXCJtb3ZlIHggeVwiKX0gLz5cclxuICAgICAgICAgICAgICAgICAgICA8c3ZnPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8Zz5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxwYXRoIGQ9e2NvbXBpbGUoXCJob3Jpem9udGFsQXJyb3cgUDEueCBQMS55IFAyLnggUDIueVwiKX0gc3Ryb2tlPVwiYmxhY2tcIiAvPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8L2c+XHJcbiAgICAgICAgICAgICAgICAgICAgPC9zdmc+XHJcbiAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgKTtcclxuICAgIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIFBvaW50IHtcclxuICAgIHg6IG51bWJlcjtcclxuICAgIHk6IG51bWJlcjtcclxufVxyXG5cclxuY2xhc3MgQ2FudmFzIHtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXR0cnMsIHByaXZhdGUgY2hpbGRyZW4pIHtcclxuICAgIH1cclxuXHJcblxyXG4gICAgYmluZCgpIHtcclxuICAgICAgICB2YXIgdGFnID0gbmV3IERvbS5UYWdCaW5kaW5nKFwiZGl2XCIsIG51bGwsIHRoaXMuY2hpbGRyZW4ubWFwKHggPT4geC5iaW5kKCkpKSxcclxuICAgICAgICAgICAgYXR0cnMgPSB0aGlzLmF0dHJzO1xyXG5cclxuICAgICAgICBmb3IgKHZhciBwcm9wIGluIGF0dHJzKSB7XHJcbiAgICAgICAgICAgIGlmIChhdHRycy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGF0dHJWYWx1ZSA9IGF0dHJzW3Byb3BdO1xyXG4gICAgICAgICAgICAgICAgdGFnLmF0dHIocHJvcC50b0xvd2VyQ2FzZSgpLCBhdHRyVmFsdWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGFnO1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBEcmFnZ2FibGUge1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhdHRycywgcHJpdmF0ZSBjaGlsZHJlbikge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcHJlc3NlZDogYW55ID0gbnVsbDtcclxuICAgIHByaXZhdGUgc3RhdGUgPSB7IGxlZnQ6IDAsIHRvcDogMCwgY2xpZW50WDogMCwgY2xpZW50WTogMCB9O1xyXG5cclxuICAgIHByaXZhdGUgcHJlc3MgPSBldmVudCA9PiB7XHJcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblxyXG4gICAgICAgIHZhciB7IGNsaWVudFgsIGNsaWVudFksIHRhcmdldCB9ID0gZXZlbnQ7XHJcblxyXG4gICAgICAgIGRvIHtcclxuICAgICAgICAgICAgaWYgKHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoXCJ4YW5pYS1kcmFnZ2FibGVcIikpXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudEVsZW1lbnQ7XHJcbiAgICAgICAgfSB3aGlsZSAodGFyZ2V0KTtcclxuXHJcbiAgICAgICAgaWYgKCF0YXJnZXQpXHJcbiAgICAgICAgICAgIHJldHVybjtcclxuXHJcbiAgICAgICAgdmFyIHsgdG9wLCBsZWZ0IH0gPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0YXJnZXQpO1xyXG5cclxuICAgICAgICB0aGlzLnN0YXRlID0ge1xyXG4gICAgICAgICAgICB0b3A6IERyYWdnYWJsZS5wcml4ZWxzKHRvcCksXHJcbiAgICAgICAgICAgIGxlZnQ6IERyYWdnYWJsZS5wcml4ZWxzKGxlZnQpLFxyXG4gICAgICAgICAgICBjbGllbnRYLFxyXG4gICAgICAgICAgICBjbGllbnRZXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLnByZXNzZWQgPSB0YXJnZXQ7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIHByaXhlbHMocHg6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBwYXJzZUZsb2F0KHB4LnJlcGxhY2UoXCJweFwiLCBcIlwiKSkgfHwgMDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlbGVhc2UgPSBldmVudCA9PiB7XHJcbiAgICAgICAgdGhpcy5wcmVzc2VkID0gbnVsbDtcclxuICAgICAgICB0aGlzLnN0YXRlID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGRyYWcgPSBldmVudCA9PiB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnByZXNzZWQgfHwgZXZlbnQuYnV0dG9ucyAhPT0gMSlcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG5cclxuICAgICAgICB2YXIgeyBjbGllbnRYLCBjbGllbnRZIH0gPSBldmVudDtcclxuICAgICAgICB2YXIgeyBwcmVzc2VkLCBzdGF0ZSB9ID0gdGhpcztcclxuXHJcbiAgICAgICAgdmFyIGxlZnQgPSBzdGF0ZS5sZWZ0ICsgY2xpZW50WCAtIHN0YXRlLmNsaWVudFg7XHJcbiAgICAgICAgdmFyIHRvcCA9IHN0YXRlLnRvcCArIGNsaWVudFkgLSBzdGF0ZS5jbGllbnRZO1xyXG5cclxuICAgICAgICBpZiAoc3RhdGUubGVmdCAhPT0gbGVmdCB8fCBzdGF0ZS50b3AgIT09IHRvcCkge1xyXG4gICAgICAgICAgICBwcmVzc2VkLnN0eWxlLmxlZnQgPSBzdGF0ZS5sZWZ0ICsgXCJweFwiO1xyXG4gICAgICAgICAgICBwcmVzc2VkLnN0eWxlLnRvcCA9IHN0YXRlLnRvcCArIFwicHhcIjtcclxuXHJcbiAgICAgICAgICAgIHN0YXRlLmNsaWVudFggPSBjbGllbnRYO1xyXG4gICAgICAgICAgICBzdGF0ZS5jbGllbnRZID0gY2xpZW50WTtcclxuICAgICAgICAgICAgc3RhdGUubGVmdCA9IGxlZnQ7XHJcbiAgICAgICAgICAgIHN0YXRlLnRvcCA9IHRvcDtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgYmluZCgpIHtcclxuICAgICAgICB2YXIgdGFnID0gbmV3IERyYWdnYWJsZUJpbmRpbmcodGhpcy5jaGlsZHJlbi5tYXAoeCA9PiB4LmJpbmQoKSkpLFxyXG4gICAgICAgICAgICBhdHRycyA9IHRoaXMuYXR0cnM7XHJcblxyXG4gICAgICAgIHRhZy5ldmVudChcIm1vdXNlZG93blwiLCB0aGlzLnByZXNzKTtcclxuICAgICAgICB0YWcuZXZlbnQoXCJtb3VzZW1vdmVcIiwgZXZlbnQgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kcmFnKGV2ZW50KSkge1xyXG4gICAgICAgICAgICAgICAgdGFnLnRyaWdnZXIoXCJtb3ZlXCIsIGV2ZW50LCB7IHg6IHRoaXMuc3RhdGUubGVmdCwgeTogdGhpcy5zdGF0ZS50b3AgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICB0YWcuZXZlbnQoXCJtb3VzZXVwXCIsIHRoaXMucmVsZWFzZSk7XHJcblxyXG4gICAgICAgIHRhZy5hdHRyKFwiY2xhc3NcIiwgXCJ4YW5pYS1kcmFnZ2FibGVcIik7XHJcbiAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBhdHRycykge1xyXG4gICAgICAgICAgICBpZiAoYXR0cnMuaGFzT3duUHJvcGVydHkocHJvcCkpIHtcclxuICAgICAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSBhdHRyc1twcm9wXTtcclxuICAgICAgICAgICAgICAgIGlmIChwcm9wID09PSBcImNsYXNzTmFtZVwiIHx8IHByb3AgPT09IFwiY2xhc3NuYW1lXCIgfHwgcHJvcCA9PT0gXCJjbGF6elwiKVxyXG4gICAgICAgICAgICAgICAgICAgIHRhZy5hdHRyKFwiY2xhc3NcIiwgXCJ4YW5pYS1kcmFnZ2FibGUgXCIgKyBhdHRyVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIHRhZy5hdHRyKHByb3AudG9Mb3dlckNhc2UoKSwgYXR0clZhbHVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRhZztcclxuICAgIH1cclxufVxyXG5cclxuY2xhc3MgRHJhZ2dhYmxlQmluZGluZyBleHRlbmRzIERvbS5UYWdCaW5kaW5nIHtcclxuICAgIGNvbnN0cnVjdG9yKGNoaWxkQmluZGluZ3MpIHtcclxuICAgICAgICBzdXBlcihcImRpdlwiLCBudWxsLCBjaGlsZEJpbmRpbmdzKTtcclxuICAgIH1cclxuXHJcbiAgICByZW5kZXIoY29udGV4dCwgZHJpdmVyKSB7XHJcbiAgICAgICAgc3VwZXIucmVuZGVyKGNvbnRleHQsIHtcclxuICAgICAgICAgICAgaW5zZXJ0KGJpbmRpbmcsIGRvbSwgaWR4KSB7XHJcbiAgICAgICAgICAgICAgICBkcml2ZXIuaW5zZXJ0KGJpbmRpbmcsIGRvbSwgaWR4KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59Il19